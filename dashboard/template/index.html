<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forex AI Dashboard — Live Analysis & Backtest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    body {
      background:#f8fafc;
      color:#111827;
      font-family: "Inter","Segoe UI",sans-serif;
      padding:18px;
    }
    .topbar {
      display:flex; gap:12px; align-items:center; margin-bottom:14px;
      flex-wrap: wrap;
    }
    .card-soft {
      background:#fff; border-radius:12px; padding:14px;
      box-shadow:0 6px 16px rgba(0,0,0,0.05); margin-bottom:14px;
    }
    #chartRoot { height:520px; border-radius:8px; background:#fff; }
    #macdRoot { height:140px; margin-top:10px; border-radius:8px; background:#fff; }
    .muted { color:#6b7280; font-size:.95rem; }
    .ai-signal-buy { color:#0f5132; background:#d1fae5; padding:3px 8px; border-radius:6px; font-weight:600; }
    .ai-signal-sell { color:#6b0f1a; background:#ffe5e5; padding:3px 8px; border-radius:6px; font-weight:600; }
    .ai-signal-hold { color:#6a5b00; background:#fff7cc; padding:3px 8px; border-radius:6px; font-weight:600; }
    .small-muted { color:#6b7280; font-size:.9rem; }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status-live { background-color: #10b981; }
    .status-offline { background-color: #ef4444; }
    .backtest-positive { color: #10b981; }
    .backtest-negative { color: #ef4444; }
    .backtest-neutral { color: #6b7280; }
    .metric-card {
      background: #f8fafc;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .metric-value {
      font-size: 1.2rem;
      font-weight: 700;
    }
    .backtest-panel {
      max-height: 400px;
      overflow-y: auto;
    }
    .performance-grade {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .grade-a { background: #d1fae5; color: #065f46; }
    .grade-b { background: #fef3c7; color: #92400e; }
    .grade-c { background: #fde68a; color: #78350f; }
    .grade-d { background: #fecaca; color: #991b1b; }
    .risk-approved { color: #10b981; font-weight: 600; }
    .risk-rejected { color: #ef4444; font-weight: 600; }
    .risk-warning { color: #d97706; font-weight: 500; }
    .risk-factor { 
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin: 1px;
    }
    .risk-high { background: #fecaca; color: #991b1b; }
    .risk-medium { background: #fef3c7; color: #92400e; }
    .risk-low { background: #d1fae5; color: #065f46; }
    .risk-score-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      margin: 5px 0;
      overflow: hidden;
    }
    .risk-score-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .score-low { background: #10b981; }
    .score-medium { background: #f59e0b; }
    .score-high { background: #ef4444; }
  </style>
</head>
<body>

<div class="topbar">
  <h4 class="m-0">Forex AI Dashboard</h4>
  <label class="small-muted mb-0 ms-3">Pair</label>
  <select id="pairSelect" class="form-select form-select-sm" style="width:120px;">
    <option>USDJPY</option>
    <option>EURUSD</option>
    <option>GBPJPY</option>
    <option>CHFJPY</option>
    <option>EURJPY</option>
    <option>GBPUSD</option>
    <option>USDCHF</option>
    <option>AUDUSD</option>
    <option>USDCAD</option>
    <option>NZDUSD</option>
  </select>
  <label class="small-muted mb-0">Timeframe</label>
  <select id="timeframeSelect" class="form-select form-select-sm" style="width:100px;">
    <option>1D</option>
    <option>4H</option>
    <option>1H</option>
    <option>M30</option>
  </select>
  <button id="analyzeBtn" class="btn btn-primary btn-sm ms-2">Analyze</button>
  <button id="toggleAutoRefresh" class="btn btn-outline-secondary btn-sm">Auto Refresh: OFF</button>
  <button id="runBacktestBtn" class="btn btn-warning btn-sm">Run Backtest</button>
  <div id="pairTicker" class="ms-3 small-muted" style="font-weight:600; font-size:1.05rem;">
    USDJPY – 0.0000 (<span id="pairChange" style="color:gray;">0.00%</span>)
    <span id="statusIndicator" class="status-indicator status-offline"></span>
    <span id="lastUpdate" class="small-muted"></span>
  </div>
</div>

<div class="row gx-3">
  <div class="col-lg-8">
    <div class="card-soft">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong id="chartTitle">Price Chart</strong>
          <div class="muted" id="chartSubtitle">Candlestick · EMA26 · MACD</div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">Live Price</div>
          <div style="font-weight:700; font-size:1.2rem" id="livePrice">-</div>
        </div>
      </div>
      <div id="chartRoot"></div>
      <div id="macdRoot"></div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-soft">
      <h5>AI Analysis <small class="muted" id="aiProviderTxt">DeepSeek AI</small></h5>
      <div id="aiSummary" class="muted">No analysis yet.</div>
      <div class="mt-2"><strong>Signal:</strong> <span id="aiSignalBadge">-</span></div>
      <div class="row mt-1">
        <div class="col"><small class="small-muted">Confidence</small><div id="aiConfidence">-</div></div>
        <div class="col"><small class="small-muted">Risk</small><div id="aiRisk">-</div></div>
      </div>
      <div class="row mt-2">
        <div class="col"><small class="small-muted">Entry</small><div id="aiEntry">-</div></div>
        <div class="col"><small class="small-muted">SL</small><div id="aiSL">-</div></div>
      </div>
      <div class="row mt-1">
        <div class="col"><small class="small-muted">TP1</small><div id="aiTP1">-</div></div>
        <div class="col"><small class="small-muted">TP2</small><div id="aiTP2">-</div></div>
      </div>
      
      <!-- Enhanced Risk Assessment Section -->
      <div class="mt-3">
        <h6>Risk Assessment</h6>
        <div id="riskAssessment">
          <div class="text-center muted">No risk assessment data</div>
        </div>
      </div>
    </div>

    <div class="card-soft">
      <h6>Fundamental News</h6>
      <div id="fundamentalNews" class="muted">-</div>
    </div>

    <div class="card-soft">
      <h6>Technical Overview</h6>
      <div class="small-muted">RSI: <strong id="rsiVal">-</strong></div>
      <div class="small-muted">MACD: <strong id="macdVal">-</strong></div>
      <div class="small-muted">MACD Hist: <strong id="macdHistVal">-</strong></div>
      <div class="small-muted">ADX: <strong id="adxVal">-</strong></div>
      <div class="small-muted">ATR: <strong id="atrVal">-</strong></div>
      <div class="small-muted">Volatility: <strong id="volVal">-</strong></div>
      <div class="small-muted">Trend: <strong id="trendVal">-</strong></div>
    </div>
    
    <!-- Backtest Results Panel -->
    <div class="card-soft">
      <h6>Backtest Results <span id="backtestStatus" class="badge bg-secondary">Not Run</span></h6>
      <div id="backtestResults" class="backtest-panel">
        <div class="text-center muted">Run backtest to see results</div>
      </div>
    </div>
  </div>
</div>

<!-- Backtest Configuration Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Backtest Configuration</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Initial Balance ($)</label>
          <input type="number" class="form-control" id="initialBalance" value="10000" min="1000" step="1000">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Period (Days)</label>
          <input type="number" class="form-control" id="backtestDays" value="30" min="7" max="365">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Type</label>
          <select class="form-select" id="backtestType">
            <option value="advanced">Advanced Backtest</option>
            <option value="basic">Basic Backtest</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="startBacktestBtn">Start Backtest</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ... (kode JavaScript sebelumnya tetap sama, hanya bagian updateRiskAssessment yang diubah)

/* ===== Enhanced Risk Assessment Display ===== */
function updateRiskAssessment(risk) {
  const riskAssessmentEl = document.getElementById('riskAssessment');
  
  if (!risk || Object.keys(risk).length === 0) {
    riskAssessmentEl.innerHTML = '<div class="text-center muted">No risk assessment data</div>';
    return;
  }

  let riskHtml = '';

  // Status utama
  if (risk.approved !== undefined) {
    const statusClass = risk.approved ? 'risk-approved' : 'risk-rejected';
    const statusIcon = risk.approved ? '✓' : '✗';
    const statusText = risk.approved ? 'APPROVED' : 'REJECTED';
    
    riskHtml += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="${statusClass}">${statusIcon} ${statusText}</span>
        ${risk.risk_score !== undefined ? 
          `<span class="small-muted">Score: ${risk.risk_score}/10</span>` : 
          ''}
      </div>
    `;
  }

  // Risk Score Bar
  if (risk.risk_score !== undefined) {
    const scoreWidth = Math.min(risk.risk_score * 10, 100);
    let scoreClass = 'score-low';
    if (risk.risk_score >= 7) scoreClass = 'score-high';
    else if (risk.risk_score >= 4) scoreClass = 'score-medium';
    
    riskHtml += `
      <div class="risk-score-bar">
        <div class="risk-score-fill ${scoreClass}" style="width: ${scoreWidth}%"></div>
      </div>
    `;
  }

  // Risk Factors
  if (risk.risk_factors && Object.keys(risk.risk_factors).length > 0) {
    riskHtml += `<div class="mt-2"><strong>Risk Factors:</strong></div>`;
    riskHtml += `<div class="d-flex flex-wrap gap-1 mt-1">`;
    
    Object.entries(risk.risk_factors).forEach(([factor, level]) => {
      let levelClass = 'risk-low';
      if (level === 'HIGH') levelClass = 'risk-high';
      else if (level === 'MEDIUM') levelClass = 'risk-medium';
      
      riskHtml += `<span class="risk-factor ${levelClass}">${factor}: ${level}</span>`;
    });
    
    riskHtml += `</div>`;
  }

  // Warnings
  if (risk.warnings && risk.warnings.length > 0) {
    riskHtml += `<div class="mt-2"><strong class="risk-warning">⚠ Warnings:</strong></div>`;
    risk.warnings.forEach(warning => {
      riskHtml += `<div class="small-muted">• ${warning}</div>`;
    });
  }

  // Rejection Reasons
  if (risk.rejection_reasons && risk.rejection_reasons.length > 0) {
    riskHtml += `<div class="mt-2"><strong class="risk-rejected">Rejection Reasons:</strong></div>`;
    risk.rejection_reasons.forEach(reason => {
      riskHtml += `<div class="small-muted">• ${reason}</div>`;
    });
  }

  // Adjusted Lot Size
  if (risk.adjusted_lot_size && risk.adjusted_lot_size !== risk.proposed_lot_size) {
    riskHtml += `<div class="mt-2 small-muted">
      <strong>Position Adjusted:</strong> ${risk.adjusted_lot_size} lots
    </div>`;
  }

  // Max Allowed
  if (risk.max_allowed_lot_size) {
    riskHtml += `<div class="small-muted">
      <strong>Max Allowed:</strong> ${risk.max_allowed_lot_size} lots
    </div>`;
  }

  riskAssessmentEl.innerHTML = riskHtml;
}

/* ===== Fetch + Render ===== */
async function analyze(){
  const pair = pairSelect.value, tf = timeframeSelect.value;
  try {
    console.log(`Fetching analysis for ${pair}-${tf}...`);
    const r = await fetch(`/api/analyze?pair=${pair}&timeframe=${tf}`); 
    
    if (!r.ok) {
      throw new Error(`HTTP error! status: ${r.status}`);
    }
    
    const j = await r.json();
    console.log('Analysis response:', j);
    
    // ... (kode chart dan technical analysis sebelumnya tetap sama)

    // Update risk assessment - MENGGUNAKAN FUNGSI BARU
    const risk = j.risk_assessment || {};
    updateRiskAssessment(risk);
    
    // Update provider info
    document.getElementById('aiProviderTxt').textContent = ai.ai_provider || 'DeepSeek AI';
    
    updateStatusIndicator(true);
    updateLastUpdateTime();
    
  } catch (error) {
    console.error('Analysis error:', error);
    updateStatusIndicator(false);
    
    // Show error to user
    aiSummaryEl.textContent = `Error: ${error.message}`;
    aiSummaryEl.style.color = '#ef4444';
  }
}

// ... (sisa kode JavaScript tetap sama)
</script>
</body>
</html>
