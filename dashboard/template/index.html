<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forex Intelligence Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <style>
    body { background-color: #0b0f19; color: #fff; font-family: "Segoe UI", sans-serif; transition: background 1s ease; }
    .card { background-color: #141a28; border: 1px solid #2a3244; border-radius: 12px; box-shadow: 0 0 8px rgba(0,0,0,0.3); }
    canvas { width: 100% !important; height: 380px !important; transition: opacity 0.5s ease; }
    .loading-spinner { display: none; text-align: center; margin-top: 10px; }
    .loading-spinner.show { display: block; }
    #realtimePrice { font-size: 1.3rem; font-weight: 600; color: #00ffc3; transition: color 0.5s ease, transform 0.3s ease; }
    #realtimePrice.pulse { color: #00bfff; transform: scale(1.05); }
    .fade-in { animation: fadeIn 0.6s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .badge-profit { background-color: #00b050; }
    .badge-loss { background-color: #ff4c4c; }
  </style>
</head>
<body>
  <div class="container-fluid py-3">
    <h3 class="text-center mb-4">Forex Intelligence Dashboard</h3>

    <!-- CONTROL PANEL -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label>Pair</label>
        <select id="pairSelect" class="form-select">
          <option>USDJPY</option><option>GBPJPY</option><option>EURJPY</option><option>CHFJPY</option>
          <option>EURUSD</option><option>GBPUSD</option><option>USDCHF</option>
          <option>AUDUSD</option><option>USDCAD</option><option>NZDUSD</option>
        </select>
      </div>
      <div class="col-md-3">
        <label>Timeframe</label>
        <select id="timeframeSelect" class="form-select">
          <option>1H</option><option>4H</option><option>1D</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100" id="analyzeBtn">Analyze Market</button>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-outline-light w-100" id="toggleAutoRefresh">Auto Refresh: OFF</button>
      </div>
    </div>

    <!-- LOADING -->
    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-light"></div>
      <p>Analyzing market data...</p>
    </div>

    <!-- AI ANALYSIS -->
    <div class="card p-3 mb-3">
      <h5>AI Market Summary</h5>
      <p id="aiSummary" class="fade-in">No analysis yet.</p>
      <p><b>Recommendation:</b> <span id="tradeRecommendation">-</span></p>
      <p><b>Confidence:</b> <span id="aiConfidence">-</span></p>
      <p><b>Live Price:</b> <span id="realtimePrice">-</span></p>
    </div>

    <!-- PRICE CHART -->
    <div class="card p-3 mb-3">
      <h5>Price Chart (Historical + Realtime)</h5>
      <canvas id="priceChart" class="fade-in"></canvas>
    </div>

    <!-- BACKTEST RESULT -->
    <div class="card p-3 mb-3">
      <h5>Backtest Performance</h5>
      <div id="backtestStats">No backtest data.</div>
      <canvas id="backtestChart" class="fade-in"></canvas>
    </div>

    <!-- FUNDAMENTAL NEWS -->
    <div class="card p-3 mb-3">
      <h5>Latest Fundamental News</h5>
      <ul id="newsList"></ul>
    </div>
  </div>

  <script>
    const analyzeBtn = document.getElementById("analyzeBtn");
    const spinner = document.getElementById("loadingSpinner");
    const toggleAutoRefresh = document.getElementById("toggleAutoRefresh");
    let realtimeInterval = null;
    let autoRefreshInterval = null;
    let autoRefreshEnabled = false;

    analyzeBtn.addEventListener("click", analyzeMarket);
    toggleAutoRefresh.addEventListener("click", toggleAutoRefreshMode);

    async function analyzeMarket(showLoading = true) {
      const pair = document.getElementById("pairSelect").value;
      const timeframe = document.getElementById("timeframeSelect").value;
      if (showLoading) spinner.classList.add("show");

      try {
        const res = await fetch(`/api/analyze?pair=${pair}&timeframe=${timeframe}`);
        const data = await res.json();
        displayResults(data);
        startRealtimePrice(pair);
      } catch (err) {
        alert("Error fetching data: " + err);
      } finally {
        spinner.classList.remove("show");
      }
    }

    function toggleAutoRefreshMode() {
      autoRefreshEnabled = !autoRefreshEnabled;
      toggleAutoRefresh.textContent = `Auto Refresh: ${autoRefreshEnabled ? "ON" : "OFF"}`;

      if (autoRefreshEnabled) {
        analyzeMarket(false);
        autoRefreshInterval = setInterval(() => analyzeMarket(false), 30000);
      } else {
        clearInterval(autoRefreshInterval);
      }
    }

    function displayResults(data) {
      document.getElementById("aiSummary").textContent = data.ai_analysis?.summary || "No summary.";
      document.getElementById("tradeRecommendation").textContent = data.trading_recommendation || "-";
      document.getElementById("aiConfidence").textContent = data.ai_analysis?.confidence
        ? (data.ai_analysis.confidence * 100).toFixed(1) + "%"
        : "-";

      const aiSummary = document.getElementById("aiSummary");
      aiSummary.classList.remove("fade-in");
      void aiSummary.offsetWidth; // restart animation
      aiSummary.classList.add("fade-in");

      const newsList = document.getElementById("newsList");
      newsList.innerHTML = "";
      if (Array.isArray(data.fundamental_analysis)) {
        data.fundamental_analysis.forEach((n) => {
          const li = document.createElement("li");
          li.textContent = `${n.headline} (${n.source}) - ${n.sentiment}`;
          newsList.appendChild(li);
        });
      }

      renderChart(data);
      renderBacktest(data.backtest_results || {});
    }

    async function startRealtimePrice(pair) {
      const priceText = document.getElementById("realtimePrice");
      clearInterval(realtimeInterval);

      realtimeInterval = setInterval(async () => {
        try {
          const res = await fetch(`/api/realtime?pair=${pair}`);
          const data = await res.json();
          const price = data?.price || data?.current_price || "-";
          if (price !== "-") {
            priceText.textContent = parseFloat(price).toFixed(4);
            priceText.classList.add("pulse");
            setTimeout(() => priceText.classList.remove("pulse"), 400);
            updateChartRealtime(parseFloat(price));
          }
        } catch (err) {
          console.warn("Realtime update failed:", err);
        }
      }, 5000);
    }

    function renderChart(data) {
      const priceSeries = data.price_series || [];
      const pair = data.pair || "PAIR";
      const ctx = document.getElementById("priceChart").getContext("2d");
      if (window.priceChart instanceof Chart) window.priceChart.destroy();

      if (priceSeries.length > 0) {
        const labels = priceSeries.map(p => new Date(p.date).toLocaleDateString());
        const closes = priceSeries.map(p => parseFloat(p.close));

        function calcEMA(values, period) {
          const k = 2 / (period + 1);
          let ema = [], prev = values[0];
          values.forEach((v, i) => {
            prev = i === 0 ? v : v * k + prev * (1 - k);
            ema.push(prev);
          });
          return ema;
        }

        const ema20 = calcEMA(closes, 20);
        const ema50 = calcEMA(closes, 50);

        window.priceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              { label: `${pair} Close`, data: closes, borderColor: "rgba(0,200,255,1)", borderWidth: 2, tension: 0.3, fill: true, backgroundColor: "rgba(0,200,255,0.1)" },
              { label: "EMA 20", data: ema20, borderColor: "rgba(255,255,0,0.8)", borderWidth: 1, tension: 0.3, pointRadius: 0 },
              { label: "EMA 50", data: ema50, borderColor: "rgba(255,100,200,0.8)", borderWidth: 1, tension: 0.3, pointRadius: 0 }
            ]
          },
          options: {
            plugins: { legend: { labels: { color: "#fff" } } },
            scales: { x: { ticks: { color: "#aaa" } }, y: { ticks: { color: "#aaa" } } },
            animation: { duration: 800, easing: 'easeInOutQuad' }
          }
        });
      }
    }

    function updateChartRealtime(price) {
      if (window.priceChart && window.priceChart.data) {
        const chart = window.priceChart;
        const labels = chart.data.labels;
        const data = chart.data.datasets[0].data;
        const now = new Date().toLocaleTimeString();
        labels.push(now);
        data.push(price);
        if (labels.length > 100) { labels.shift(); data.shift(); }
        chart.update('active');
      }
    }

    function renderBacktest(backtest) {
      const div = document.getElementById("backtestStats");
      const ctx = document.getElementById("backtestChart").getContext("2d");
      if (window.backtestChart instanceof Chart) window.backtestChart.destroy();

      if (!backtest || Object.keys(backtest).length === 0) {
        div.textContent = "No backtest data available.";
        return;
      }

      div.innerHTML = `
        <p>Win Rate: <span class="badge bg-success">${backtest.win_rate || 0}%</span> |
           Profit Factor: ${backtest.profit_factor || "N/A"} |
           Net Profit: <span class="badge ${backtest.net_profit > 0 ? 'badge-profit' : 'badge-loss'}">${backtest.net_profit}</span></p>
      `;

      const labels = backtest.equity_curve?.map((_, i) => `Trade ${i + 1}`) || [];
      const equity = backtest.equity_curve || [];

      window.backtestChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Equity Curve", data: equity, borderColor: "rgba(0,255,120,1)", borderWidth: 2, tension: 0.3, fill: true, backgroundColor: "rgba(0,255,120,0.1)" }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: "#fff" } } },
          scales: { x: { ticks: { color: "#aaa" } }, y: { ticks: { color: "#aaa" } } },
          animation: { duration: 700, easing: 'easeOutCubic' }
        }
      });
    }
  </script>
</body>
</html>
