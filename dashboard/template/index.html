<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forex AI Dashboard — Live Analysis & Backtest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    body {
      background:#f8fafc;
      color:#111827;
      font-family: "Inter","Segoe UI",sans-serif;
      padding:18px;
    }
    .topbar {
      display:flex; gap:12px; align-items:center; margin-bottom:14px;
      flex-wrap: wrap;
    }
    .card-soft {
      background:#fff; border-radius:12px; padding:14px;
      box-shadow:0 6px 16px rgba(0,0,0,0.05); margin-bottom:14px;
    }
    #chartRoot { height:520px; border-radius:8px; background:#fff; }
    #macdRoot { height:140px; margin-top:10px; border-radius:8px; background:#fff; }
    .muted { color:#6b7280; font-size:.95rem; }
    .ai-signal-buy { color:#0f5132; background:#d1fae5; padding:3px 8px; border-radius:6px; font-weight:600; }
    .ai-signal-sell { color:#6b0f1a; background:#ffe5e5; padding:3px 8px; border-radius:6px; font-weight:600; }
    .ai-signal-hold { color:#6a5b00; background:#fff7cc; padding:3px 8px; border-radius:6px; font-weight:600; }
    .small-muted { color:#6b7280; font-size:.9rem; }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status-live { background-color: #10b981; }
    .status-offline { background-color: #ef4444; }
    .backtest-positive { color: #10b981; }
    .backtest-negative { color: #ef4444; }
    .backtest-neutral { color: #6b7280; }
    .metric-card {
      background: #f8fafc;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .metric-value {
      font-size: 1.2rem;
      font-weight: 700;
    }
    .backtest-panel {
      max-height: 400px;
      overflow-y: auto;
    }
    .performance-grade {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .grade-a { background: #d1fae5; color: #065f46; }
    .grade-b { background: #fef3c7; color: #92400e; }
    .grade-c { background: #fde68a; color: #78350f; }
    .grade-d { background: #fecaca; color: #991b1b; }
  </style>
</head>
<body>

<div class="topbar">
  <h4 class="m-0">Forex AI Dashboard</h4>
  <label class="small-muted mb-0 ms-3">Pair</label>
  <select id="pairSelect" class="form-select form-select-sm" style="width:120px;">
    <option>USDJPY</option>
    <option>EURUSD</option>
    <option>GBPJPY</option>
    <option>CHFJPY</option>
    <option>EURJPY</option>
    <option>GBPUSD</option>
    <option>USDCHF</option>
    <option>AUDUSD</option>
    <option>USDCAD</option>
    <option>NZDUSD</option>
  </select>
  <label class="small-muted mb-0">Timeframe</label>
  <select id="timeframeSelect" class="form-select form-select-sm" style="width:100px;">
    <option>1D</option>
    <option>4H</option>
    <option>1H</option>
    <option>M30</option>
  </select>
  <button id="analyzeBtn" class="btn btn-primary btn-sm ms-2">Analyze</button>
  <button id="toggleAutoRefresh" class="btn btn-outline-secondary btn-sm">Auto Refresh: OFF</button>
  <button id="runBacktestBtn" class="btn btn-warning btn-sm">Run Backtest</button>
  <div id="pairTicker" class="ms-3 small-muted" style="font-weight:600; font-size:1.05rem;">
    USDJPY – 0.0000 (<span id="pairChange" style="color:gray;">0.00%</span>)
    <span id="statusIndicator" class="status-indicator status-offline"></span>
    <span id="lastUpdate" class="small-muted"></span>
  </div>
</div>

<div class="row gx-3">
  <div class="col-lg-8">
    <div class="card-soft">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong id="chartTitle">Price Chart</strong>
          <div class="muted" id="chartSubtitle">Candlestick · EMA26 · MACD</div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">Live Price</div>
          <div style="font-weight:700; font-size:1.2rem" id="livePrice">-</div>
        </div>
      </div>
      <div id="chartRoot"></div>
      <div id="macdRoot"></div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-soft">
      <h5>AI Analysis <small class="muted" id="aiProviderTxt">DeepSeek AI</small></h5>
      <div id="aiSummary" class="muted">No analysis yet.</div>
      <div class="mt-2"><strong>Signal:</strong> <span id="aiSignalBadge">-</span></div>
      <div class="row mt-1">
        <div class="col"><small class="small-muted">Confidence</small><div id="aiConfidence">-</div></div>
        <div class="col"><small class="small-muted">Risk</small><div id="aiRisk">-</div></div>
      </div>
      <div class="row mt-2">
        <div class="col"><small class="small-muted">Entry</small><div id="aiEntry">-</div></div>
        <div class="col"><small class="small-muted">SL</small><div id="aiSL">-</div></div>
      </div>
      <div class="row mt-1">
        <div class="col"><small class="small-muted">TP1</small><div id="aiTP1">-</div></div>
        <div class="col"><small class="small-muted">TP2</small><div id="aiTP2">-</div></div>
      </div>
    </div>

    <div class="card-soft">
      <h6>Fundamental News</h6>
      <div id="fundamentalNews" class="muted">-</div>
    </div>

    <div class="card-soft">
      <h6>Technical Overview</h6>
      <div class="small-muted">RSI: <strong id="rsiVal">-</strong></div>
      <div class="small-muted">MACD: <strong id="macdVal">-</strong></div>
      <div class="small-muted">ADX: <strong id="adxVal">-</strong></div>
      <div class="small-muted">ATR: <strong id="atrVal">-</strong></div>
      <div class="small-muted">Volatility: <strong id="volVal">-</strong></div>
    </div>
    
    <!-- Backtest Results Panel -->
    <div class="card-soft">
      <h6>Backtest Results <span id="backtestStatus" class="badge bg-secondary">Not Run</span></h6>
      <div id="backtestResults" class="backtest-panel">
        <div class="text-center muted">Run backtest to see results</div>
      </div>
    </div>
  </div>
</div>

<!-- Backtest Configuration Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Backtest Configuration</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Initial Balance ($)</label>
          <input type="number" class="form-control" id="initialBalance" value="10000" min="1000" step="1000">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Period (Days)</label>
          <input type="number" class="form-control" id="backtestDays" value="30" min="7" max="365">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Type</label>
          <select class="form-select" id="backtestType">
            <option value="advanced">Advanced Backtest</option>
            <option value="basic">Basic Backtest</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="startBacktestBtn">Start Backtest</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ===== Utilities ===== */
function calcEMA(values, period){
  const k=2/(period+1);let ema=[values[0]];
  for(let i=1;i<values.length;i++)ema.push(values[i]*k+ema[i-1]*(1-k));
  return ema;
}
function calcMACDSeries(c,short=12,long=26,signal=9){
  const emaS=calcEMA(c,short),emaL=calcEMA(c,long);
  const macd=c.map((_,i)=>emaS[i]-emaL[i]);
  const sig=calcEMA(macd,signal);
  const hist=macd.map((v,i)=>v-(sig[i]||0));
  return {macd,sig,hist};
}
function fmt(d){const t=new Date(d);return t.toISOString().split('T')[0];}

/* ===== Chart Setup ===== */
const chart=LightweightCharts.createChart(document.getElementById('chartRoot'),{
  layout:{backgroundColor:'#fff',textColor:'#111'},grid:{vertLines:{color:'#f3f4f6'},horzLines:{color:'#f3f4f6'}},
  timeScale:{borderColor:'#eee'},rightPriceScale:{borderColor:'#eee'}
});
const candle=chart.addCandlestickSeries({upColor:'#16a34a',downColor:'#dc2626',borderVisible:true});
const ema26=chart.addLineSeries({color:'#2563eb',lineWidth:1.5});

const macdChart=LightweightCharts.createChart(document.getElementById('macdRoot'),{
  layout:{backgroundColor:'#fff',textColor:'#111'},
  grid:{vertLines:{color:'#f3f4f6'},horzLines:{color:'#f3f4f6'}},timeScale:{visible:true,borderColor:'#eee'}
});
const macdLine=macdChart.addLineSeries({color:'#0ea5e9'});
const macdSignal=macdChart.addLineSeries({color:'#f59e0b'});
const macdHist=macdChart.addHistogramSeries({color:'#a78bfa'});

// Sync time scales between charts
chart.timeScale().subscribeVisibleTimeRangeChange((timeRange) => {
  macdChart.timeScale().setVisibleRange(timeRange);
});

/* ===== DOM refs ===== */
const livePriceEl=document.getElementById('livePrice');
const pairSelect=document.getElementById('pairSelect');
const timeframeSelect=document.getElementById('timeframeSelect');
const aiSummaryEl=document.getElementById('aiSummary');
const aiSignal=document.getElementById('aiSignalBadge');
const aiConfidence=document.getElementById('aiConfidence');
const aiRisk=document.getElementById('aiRisk');
const aiEntry=document.getElementById('aiEntry');
const aiSL=document.getElementById('aiSL');
const aiTP1=document.getElementById('aiTP1');
const aiTP2=document.getElementById('aiTP2');
const fundNews=document.getElementById('fundamentalNews');
const rsiEl=document.getElementById('rsiVal');
const macdValEl=document.getElementById('macdVal');
const adxEl=document.getElementById('adxVal');
const atrEl=document.getElementById('atrVal');
const volEl=document.getElementById('volVal');
const changeEl=document.getElementById('pairChange');
const statusIndicator=document.getElementById('statusIndicator');
const lastUpdateEl=document.getElementById('lastUpdate');
const backtestResultsEl = document.getElementById('backtestResults');
const backtestStatusEl = document.getElementById('backtestStatus');

/* ===== Data state ===== */
let lastCandle=null, auto=false, autoRefreshInterval=null, livePriceInterval=null;
let currentSignal = 'HOLD';

function setSignal(sig){
  aiSignal.textContent=sig;
  currentSignal = sig;
  aiSignal.className=sig==='BUY'?'ai-signal-buy':sig==='SELL'?'ai-signal-sell':'ai-signal-hold';
}

// Update status indicator
function updateStatusIndicator(isLive) {
  if (isLive) {
    statusIndicator.className = 'status-indicator status-live';
    statusIndicator.title = 'Live data connection active';
  } else {
    statusIndicator.className = 'status-indicator status-offline';
    statusIndicator.title = 'No live data connection';
  }
}

// Update last update time
function updateLastUpdateTime() {
  const now = new Date();
  lastUpdateEl.textContent = 'Last: ' + now.toLocaleTimeString();
}

/* ===== Fetch + Render ===== */
async function analyze(){
  const pair=pairSelect.value, tf=timeframeSelect.value;
  try {
    const r=await fetch(`/api/analyze?pair=${pair}&timeframe=${tf}`); 
    const j=await r.json();
    
    // Update price series chart
    if (j.price_series && j.price_series.length > 0) {
      const c = j.price_series.map(p => ({
        time: fmt(p.date),
        open: +p.open,
        high: +p.high,
        low: +p.low,
        close: +p.close
      }));
      
      candle.setData(c);
      const closes = c.map(d => d.close);
      const ema = calcEMA(closes, 26).map((v, i) => ({time: c[i].time, value: v}));
      ema26.setData(ema);
      
      const {macd, sig, hist} = calcMACDSeries(closes);
      macdLine.setData(macd.map((v, i) => ({time: c[i].time, value: v})));
      macdSignal.setData(sig.map((v, i) => ({time: c[i].time, value: v})));
      macdHist.setData(hist.map((v, i) => ({time: c[i].time, value: v})));
      
      lastCandle = c.at(-1);
    }
    
    // Update technical values
    const t = j.technical_analysis || {};
    macdValEl.textContent = t.momentum?.macd?.toFixed(4) || '-';
    rsiEl.textContent = t.momentum?.rsi?.toFixed(2) || '-';
    adxEl.textContent = t.trend?.adx?.toFixed(2) || '-';
    atrEl.textContent = t.volatility?.atr?.toFixed(4) || '-';
    volEl.textContent = t.volatility?.volatility_pct ? (t.volatility.volatility_pct * 100).toFixed(2) + '%' : '-';
    
    // Update price data
    const priceData = j.price_data || {};
    livePriceEl.textContent = priceData.current?.toFixed(4) || '-';
    
    // Update pair ticker
    const change = priceData.change_pct || 0;
    changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
    changeEl.style.color = change >= 0 ? '#16a34a' : '#dc2626';
    
    // Update AI analysis
    const ai = j.ai_analysis || {};
    aiSummaryEl.textContent = ai.analysis_summary || '-';
    setSignal(ai.signal || 'HOLD');
    aiConfidence.textContent = (ai.confidence || '-') + '%';
    aiRisk.textContent = ai.risk_level || '-';
    aiEntry.textContent = ai.entry_price || '-';
    aiSL.textContent = ai.stop_loss || '-';
    aiTP1.textContent = ai.take_profit_1 || '-';
    aiTP2.textContent = ai.take_profit_2 || '-';
    
    // Update fundamental news
    fundNews.textContent = j.fundamental_analysis || '-';
    
    // Update provider info
    document.getElementById('aiProviderTxt').textContent = ai.ai_provider || 'DeepSeek AI';
    
    updateStatusIndicator(true);
    updateLastUpdateTime();
    
  } catch (error) {
    console.error('Analysis error:', error);
    updateStatusIndicator(false);
  }
}

/* ===== Live Price Update ===== */
let prevPrice = null;
async function updateLivePrice() {
  const pair = pairSelect.value;
  try {
    // Use the analyze endpoint to get updated price data
    const r = await fetch(`/api/analyze?pair=${pair}&timeframe=${timeframeSelect.value}`);
    const j = await r.json();
    
    const priceData = j.price_data || {};
    const currentPrice = priceData.current;
    
    if (currentPrice) {
      livePriceEl.textContent = currentPrice.toFixed(4);
      
      // Update price change
      const change = priceData.change_pct || 0;
      changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
      changeEl.style.color = change >= 0 ? '#16a34a' : '#dc2626';
      
      // Update current candle with live price
      if (lastCandle) {
        const updatedCandle = {
          time: lastCandle.time,
          open: lastCandle.open,
          high: Math.max(lastCandle.high, currentPrice),
          low: Math.min(lastCandle.low, currentPrice),
          close: currentPrice
        };
        candle.update(updatedCandle);
        
        // Update EMA with new close price
        const closes = [...candle.data().map(d => d.close)];
        closes[closes.length - 1] = currentPrice;
        const ema = calcEMA(closes, 26);
        const lastEma = ema[ema.length - 1];
        ema26.update({time: lastCandle.time, value: lastEma});
        
        // Update MACD with new close price
        const {macd, sig, hist} = calcMACDSeries(closes);
        const lastMacd = macd[macd.length - 1];
        const lastSig = sig[sig.length - 1];
        const lastHist = hist[hist.length - 1];
        
        macdLine.update({time: lastCandle.time, value: lastMacd});
        macdSignal.update({time: lastCandle.time, value: lastSig});
        macdHist.update({time: lastCandle.time, value: lastHist});
        
        macdValEl.textContent = lastMacd.toFixed(4);
      }
      
      updateStatusIndicator(true);
      updateLastUpdateTime();
    }
  } catch (error) {
    console.error('Live price error:', error);
    updateStatusIndicator(false);
  }
}

/* ===== Backtest Functions ===== */
function showBacktestModal() {
  const modal = new bootstrap.Modal(document.getElementById('backtestModal'));
  modal.show();
}

async function runBacktest() {
  const pair = pairSelect.value;
  const timeframe = timeframeSelect.value;
  const initialBalance = document.getElementById('initialBalance').value;
  const days = document.getElementById('backtestDays').value;
  const backtestType = document.getElementById('backtestType').value;
  
  backtestStatusEl.textContent = 'Running...';
  backtestStatusEl.className = 'badge bg-warning';
  backtestResultsEl.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Running backtest...</div>';
  
  try {
    const endpoint = backtestType === 'advanced' ? '/api/advanced_backtest' : '/api/backtest';
    
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        pair: pair,
        timeframe: timeframe,
        days: parseInt(days),
        initial_balance: parseFloat(initialBalance)
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success' || result.status === 'no_trades') {
      displayBacktestResults(result);
      backtestStatusEl.textContent = 'Completed';
      backtestStatusEl.className = 'badge bg-success';
    } else {
      throw new Error(result.error || 'Backtest failed');
    }
    
  } catch (error) {
    console.error('Backtest error:', error);
    backtestResultsEl.innerHTML = `<div class="alert alert-danger">Backtest failed: ${error.message}</div>`;
    backtestStatusEl.textContent = 'Failed';
    backtestStatusEl.className = 'badge bg-danger';
  }
}

function displayBacktestResults(result) {
  const summary = result.summary || {};
  const tradeAnalysis = result.trade_analysis || {};
  
  let html = '';
  
  // Performance Grade
  const grade = result.performance_grade || 'N/A';
  const gradeClass = grade.startsWith('A') ? 'grade-a' : 
                    grade.startsWith('B') ? 'grade-b' :
                    grade.startsWith('C') ? 'grade-c' : 'grade-d';
  
  html += `<div class="performance-grade ${gradeClass}">Performance: ${grade}</div>`;
  
  // Summary Metrics
  html += `
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Total Trades</div>
          <div class="metric-value">${summary.total_trades || 0}</div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Win Rate</div>
          <div class="metric-value ${(summary.win_rate || 0) >= 50 ? 'backtest-positive' : 'backtest-negative'}">
            ${(summary.win_rate || 0).toFixed(1)}%
          </div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Total Profit</div>
          <div class="metric-value ${(summary.total_profit || 0) >= 0 ? 'backtest-positive' : 'backtest-negative'}">
            $${(summary.total_profit || 0).toFixed(2)}
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Final Balance</div>
          <div class="metric-value">$${(summary.final_balance || 0).toFixed(2)}</div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Return %</div>
          <div class="metric-value ${(summary.return_percentage || 0) >= 0 ? 'backtest-positive' : 'backtest-negative'}">
            ${(summary.return_percentage || 0).toFixed(2)}%
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Max Drawdown</div>
          <div class="metric-value backtest-negative">${(summary.max_drawdown || 0).toFixed(2)}%</div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Profit Factor</div>
          <div class="metric-value">${(summary.profit_factor || 0).toFixed(2)}</div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Sharpe Ratio</div>
          <div class="metric-value">${(summary.sharpe_ratio || 0).toFixed(2)}</div>
        </div>
      </div>
    </div>
  `;
  
  // Trade Analysis
  if (tradeAnalysis.long_trades || tradeAnalysis.short_trades) {
    html += `
      <div class="mt-3">
        <h6>Trade Analysis</h6>
        <div class="small-muted">Long Trades: ${tradeAnalysis.long_trades || 0} (Win Rate: ${(tradeAnalysis.long_win_rate || 0).toFixed(1)}%)</div>
        <div class="small-muted">Short Trades: ${tradeAnalysis.short_trades || 0} (Win Rate: ${(tradeAnalysis.short_win_rate || 0).toFixed(1)}%)</div>
      </div>
    `;
  }
  
  // Risk Metrics
  html += `
    <div class="mt-3">
      <h6>Risk Metrics</h6>
      <div class="small-muted">Avg Win: $${(summary.avg_win || 0).toFixed(2)}</div>
      <div class="small-muted">Avg Loss: $${(summary.avg_loss || 0).toFixed(2)}</div>
      <div class="small-muted">Max Consecutive Losses: ${summary.max_consecutive_losses || 0}</div>
    </div>
  `;
  
  backtestResultsEl.innerHTML = html;
}

/* ===== Event Listeners ===== */
document.getElementById('analyzeBtn').addEventListener('click', analyze);
document.getElementById('runBacktestBtn').addEventListener('click', showBacktestModal);
document.getElementById('startBacktestBtn').addEventListener('click', runBacktest);

document.getElementById('toggleAutoRefresh').addEventListener('click', function() {
  auto = !auto;
  const toggleBtn = document.getElementById('toggleAutoRefresh');
  toggleBtn.textContent = 'Auto Refresh: ' + (auto ? 'ON' : 'OFF');
  
  if (auto) {
    // Start live price updates every 30 seconds
    livePriceInterval = setInterval(updateLivePrice, 30000);
    // Start analysis updates every 2 minutes
    autoRefreshInterval = setInterval(analyze, 120000);
    toggleBtn.classList.remove('btn-outline-secondary');
    toggleBtn.classList.add('btn-success');
  } else {
    clearInterval(livePriceInterval);
    clearInterval(autoRefreshInterval);
    toggleBtn.classList.remove('btn-success');
    toggleBtn.classList.add('btn-outline-secondary');
  }
});

pairSelect.addEventListener('change', analyze);
timeframeSelect.addEventListener('change', analyze);

// Initialize dashboard
analyze();

// Start live price updates every 5 seconds for responsive UI
setInterval(updateLivePrice, 5000);
</script>
</body>
</html>
