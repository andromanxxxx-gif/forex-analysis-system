<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Trading Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --profit-color: #27ae60;
            --loss-color: #e74c3c;
            --warning-color: #f39c12;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 20px auto;
            padding: 25px;
        }
        
        .header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .currency-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid var(--accent-color);
        }
        
        .currency-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .currency-card.up {
            border-left-color: var(--profit-color);
        }
        
        .currency-card.down {
            border-left-color: var(--loss-color);
        }
        
        .signal-beli-kuat {
            background: linear-gradient(135deg, #27ae60, #16a085);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .signal-beli {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .signal-jual-kuat {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .signal-jual {
            background: linear-gradient(135deg, #e74c3c, #d35400);
            color: white;
        }
        
        .signal-tunggu {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .indicator-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .progress {
            height: 8px;
            margin: 5px 0;
        }
        
        .news-item {
            background: #f8f9fa;
            border-left: 3px solid var(--accent-color);
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .macd-chart-container {
            position: relative;
            height: 200px;
            margin: 20px 0;
        }
        
        .risk-tinggi { color: var(--loss-color); font-weight: bold; }
        .risk-sedang { color: var(--warning-color); font-weight: bold; }
        .risk-rendah { color: var(--profit-color); font-weight: bold; }
        
        .confidence-bar {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #ecf0f1;
        }
        
        .confidence-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .chart-controls {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .ai-badge {
            font-size: 0.7em;
            vertical-align: super;
        }
        
        .signal-explanation {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .data-info {
            font-size: 0.8em;
            color: #6c757d;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                <div class="dashboard-container">
                    <!-- Header -->
                    <div class="header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h1 class="display-5 fw-bold text-primary">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Forex Trading Analysis
                                </h1>
                                <p class="text-muted">Analisis teknikal & fundamental real-time untuk pair JPY</p>
                                <div id="aiStatusBadge" class="badge bg-info">
                                    <i class="fas fa-robot me-1"></i>
                                    <span id="aiStatusText">Checking AI Status...</span>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-primary" onclick="loadQuickOverview()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                    <button class="btn btn-outline-info" onclick="showPerformance()">
                                        <i class="fas fa-chart-bar"></i> Performance
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label class="form-label">Pair Mata Uang</label>
                            <select class="form-select" id="pairSelect">
                                <option value="USDJPY">USD/JPY</option>
                                <option value="GBPJPY">GBP/JPY</option>
                                <option value="EURJPY">EUR/JPY</option>
                                <option value="CHFJPY">CHF/JPY</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Timeframe</label>
                            <select class="form-select" id="timeframeSelect">
                                <option value="1H">1 Jam</option>
                                <option value="4H" selected>4 Jam</option>
                                <option value="1D">Harian</option>
                                <option value="1W">Mingguan</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Period</label>
                            <select class="form-select" id="dataPeriodSelect">
                                <option value="auto">Auto (Rekomendasi)</option>
                                <option value="7">7 Hari</option>
                                <option value="30">30 Hari</option>
                                <option value="90">90 Hari</option>
                                <option value="180">180 Hari</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check form-switch me-3">
                                <input class="form-check-input" type="checkbox" id="useHistorySwitch" checked>
                                <label class="form-check-label" for="useHistorySwitch">Gunakan Data Historis</label>
                            </div>
                            <button class="btn btn-primary w-100" onclick="getAnalysis()">
                                <i class="fas fa-analytics me-2"></i>Analisis
                            </button>
                        </div>
                    </div>

                    <!-- Quick Overview -->
                    <div class="row mb-4" id="quickOverview">
                        <div class="col-12">
                            <h5><i class="fas fa-globe me-2"></i>Market Overview</h5>
                            <div class="row" id="overviewCards">
                                <!-- Overview cards will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div class="loading" id="loadingIndicator">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Menganalisis data market...</p>
                    </div>

                    <!-- Analysis Results -->
                    <div id="analysisResults" style="display: none;">
                        <!-- Results will be populated here -->
                    </div>

                    <!-- Performance Metrics -->
                    <div id="performanceMetrics" style="display: none;">
                        <div class="row">
                            <div class="col-12">
                                <h5><i class="fas fa-tachometer-alt me-2"></i>Performance Metrics</h5>
                                <div id="performanceContent"></div>
                                <button class="btn btn-secondary mt-3" onclick="hidePerformance()">
                                    <i class="fas fa-arrow-left me-2"></i>Kembali ke Analisis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let priceChart = null;
        let macdChart = null;
        let chartIndicators = {
            ema200: true,
            macd: true
        };
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadQuickOverview();
            checkAIStatus();
        });
        
        // Check AI Status
        async function checkAIStatus() {
            try {
                const response = await fetch('/ai_status');
                const data = await response.json();
                
                const badge = document.getElementById('aiStatusBadge');
                const text = document.getElementById('aiStatusText');
                
                if (data.ai_available) {
                    badge.className = 'badge bg-success';
                    text.textContent = 'AI DeepSeek Active';
                } else {
                    badge.className = 'badge bg-warning';
                    text.textContent = 'AI Fallback Mode';
                }
            } catch (error) {
                console.error('Error checking AI status:', error);
            }
        }
        
        // Load quick overview of all pairs
        async function loadQuickOverview() {
            try {
                const response = await fetch('/quick_overview');
                const data = await response.json();
                
                const overviewCards = document.getElementById('overviewCards');
                overviewCards.innerHTML = '';
                
                Object.entries(data).forEach(([pair, info]) => {
                    const changeClass = info.change > 0 ? 'text-success' : info.change < 0 ? 'text-danger' : 'text-muted';
                    const trendClass = info.change > 0 ? 'up' : info.change < 0 ? 'down' : '';
                    const changeIcon = info.change > 0 ? 'fa-arrow-up' : info.change < 0 ? 'fa-arrow-down' : 'fa-minus';
                    
                    const card = `
                        <div class="col-sm-6 col-md-3">
                            <div class="currency-card ${trendClass}">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-1">${pair}</h6>
                                        <h4 class="mb-0">${info.price ? info.price.toFixed(4) : 'N/A'}</h4>
                                    </div>
                                    <div class="col-4 text-end">
                                        <i class="fas ${changeIcon} ${changeClass} fa-2x"></i>
                                        <small class="d-block ${changeClass}">${info.change > 0 ? '+' : ''}${info.change.toFixed(2)}%</small>
                                    </div>
                                </div>
                                <small class="text-muted">Sumber: ${info.source}</small>
                            </div>
                        </div>
                    `;
                    overviewCards.innerHTML += card;
                });
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }
        
        // Get detailed analysis
        async function getAnalysis() {
            const pair = document.getElementById('pairSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            const useHistory = document.getElementById('useHistorySwitch').checked;
            const dataPeriod = document.getElementById('dataPeriodSelect').value;
            
            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('performanceMetrics').style.display = 'none';
            
            try {
                let url = `/get_analysis?pair=${pair}&timeframe=${timeframe}&use_history=${useHistory ? '1' : '0'}`;
                if (dataPeriod !== 'auto') {
                    url += `&days=${dataPeriod}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayAnalysisResults(data);
            } catch (error) {
                alert('Error: ' + error.message);
                console.error('Analysis error:', error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        // Display analysis results
        function displayAnalysisResults(data) {
            const resultsDiv = document.getElementById('analysisResults');
            const tech = data.technical_indicators;
            const ai = data.ai_analysis;
            const chartData = data.chart_data;
            
            // Determine signal class
            const signalClass = `signal-${ai.SIGNAL.toLowerCase().replace(' ', '-')}`;
            
            resultsDiv.innerHTML = `
                <div class="row">
                    <!-- Main Signal Card -->
                    <div class="col-lg-4">
                        <div class="card ${signalClass} mb-4">
                            <div class="card-body text-center">
                                <h2 class="card-title">
                                    <i class="fas fa-bullhorn me-2"></i>${ai.SIGNAL}
                                    <span class="ai-badge badge bg-dark">${data.ai_provider}</span>
                                </h2>
                                <h1 class="display-4 fw-bold">${data.current_price.toFixed(4)}</h1>
                                <p class="mb-2">${data.pair} • ${data.timeframe}</p>
                                
                                <div class="confidence-bar mb-3">
                                    <div class="confidence-fill bg-success" style="width: ${ai.CONFIDENCE_LEVEL}%"></div>
                                </div>
                                <p>Confidence: <strong>${ai.CONFIDENCE_LEVEL}%</strong></p>
                                
                                <div class="row text-start mt-3">
                                    <div class="col-6">
                                        <small>Entry: <strong>${ai.ENTRY_PRICE}</strong></small><br>
                                        <small>Stop Loss: <strong>${ai.STOP_LOSS}</strong></small>
                                    </div>
                                    <div class="col-6">
                                        <small>TP1: <strong>${ai.TAKE_PROFIT_1}</strong></small><br>
                                        <small>TP2: <strong>${ai.TAKE_PROFIT_2}</strong></small>
                                    </div>
                                </div>
                                
                                <p class="mt-3 small">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Risk: <span class="risk-${ai.RISK_LEVEL.toLowerCase()}">${ai.RISK_LEVEL}</span>
                                </p>
                                <p class="signal-explanation">${getSignalExplanation(ai.SIGNAL)}</p>
                            </div>
                        </div>
                        
                        <!-- Trading Advice -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Rekomendasi Trading</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${ai.TRADING_ADVICE}</p>
                                <small class="text-muted">Expected movement: ${ai.EXPECTED_MOVEMENT}</small>
                            </div>
                        </div>

                        <!-- Technical Indicators -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Indikator Teknikal</h6>
                            </div>
                            <div class="card-body">
                                ${createIndicatorHTML('RSI', tech.RSI, 30, 70)}
                                ${createIndicatorHTML('MACD', tech.MACD, -0.001, 0.001)}
                                ${createIndicatorHTML('MACD Signal', tech.MACD_Signal, -0.001, 0.001)}
                                ${createIndicatorHTML('MACD Histogram', tech.MACD_Histogram, -0.001, 0.001)}
                                ${createIndicatorHTML('SMA 20', tech.SMA20, data.current_price * 0.99, data.current_price * 1.01, true)}
                                ${createIndicatorHTML('SMA 50', tech.SMA50, data.current_price * 0.98, data.current_price * 1.02, true)}
                                ${createIndicatorHTML('EMA 200', tech.EMA200, data.current_price * 0.95, data.current_price * 1.05, true)}
                                ${createIndicatorHTML('Volatility', tech.Volatility + '%', 0, 5)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="col-lg-8">
                        <!-- Data Info -->
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Data:</strong> ${data.data_source} | 
                                <strong>Points:</strong> ${data.data_points || chartData.dates.length} | 
                                <strong>Processed in:</strong> ${data.processing_time}s
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleDataDensity()">
                                    <i class="fas fa-chart-line me-1"></i>Toggle Density
                                </button>
                            </div>
                        </div>
                        
                        <!-- Price Chart with EMA200 -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Price Chart dengan EMA200</h6>
                                <div class="chart-controls">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input indicator-toggle" type="checkbox" id="toggleEMA200" checked 
                                               onchange="toggleIndicator('ema200', this.checked)">
                                        <label class="form-check-label" for="toggleEMA200">EMA200</label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="priceChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MACD Chart -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>MACD Indicator</h6>
                                <div class="chart-controls">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input indicator-toggle" type="checkbox" id="toggleMACD" checked 
                                               onchange="toggleIndicator('macd', this.checked)">
                                        <label class="form-check-label" for="toggleMACD">MACD</label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="macd-chart-container">
                                    <canvas id="macdChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Support & Resistance and News -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Support & Resistance</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <h5 class="text-danger">${tech.Resistance}</h5>
                                                <small class="text-muted">Resistance</small>
                                            </div>
                                            <div class="col-4">
                                                <h5 class="text-primary">${data.current_price.toFixed(4)}</h5>
                                                <small class="text-muted">Current</small>
                                            </div>
                                            <div class="col-4">
                                                <h5 class="text-success">${tech.Support}</h5>
                                                <small class="text-muted">Support</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-newspaper me-2"></i>Berita Fundamental</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="news-item">
                                            <p class="mb-0">${data.fundamental_news}</p>
                                        </div>
                                        <small class="text-muted">Sumber: ${data.data_source}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create charts
            createPriceChart(chartData);
            createMACDChart(chartData);
            
            resultsDiv.style.display = 'block';
        }
        
        // Get signal explanation
        function getSignalExplanation(signal) {
            const explanations = {
                "BELI KUAT": "Kondisi oversold dengan momentum bullish kuat",
                "BELI": "Signal beli dengan konfirmasi teknikal",
                "JUAL KUAT": "Kondisi overbought dengan momentum bearish kuat", 
                "JUAL": "Signal jual dengan konfirmasi teknikal",
                "TUNGGU": "Market konsolidasi, tunggu konfirmasi breakout"
            };
            return explanations[signal] || "Analisis berdasarkan indikator teknikal dan fundamental";
        }
        
        // Create indicator HTML with visual representation
        function createIndicatorHTML(name, value, min, max, isPrice = false) {
            let valueClass = '';
            let barWidth = 50;
            
            if (typeof value === 'number') {
                const range = max - min;
                const normalized = Math.max(0, Math.min(100, ((value - min) / range) * 100));
                barWidth = normalized;
                
                if (name === 'RSI') {
                    if (value < 30) valueClass = 'text-success';
                    else if (value > 70) valueClass = 'text-danger';
                } else if (name.includes('MACD')) {
                    if (value > 0) valueClass = 'text-success';
                    else if (value < 0) valueClass = 'text-danger';
                }
            }
            
            const displayValue = typeof value === 'number' ? (isPrice ? value.toFixed(4) : value.toFixed(4)) : value;
            
            return `
                <div class="indicator-item mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small">${name}:</span>
                        <span class="${valueClass} fw-bold">${displayValue}</span>
                    </div>
                    ${typeof value === 'number' ? `
                    <div class="progress">
                        <div class="progress-bar ${valueClass.includes('success') ? 'bg-success' : valueClass.includes('danger') ? 'bg-danger' : 'bg-primary'}" 
                             style="width: ${barWidth}%"></div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Optimize chart data for performance
        let currentDataDensity = 'normal'; // 'normal' or 'high'
        
        function optimizeChartData(chartData, maxPoints = 200) {
            // If data points are less than maxPoints, return original
            if (chartData.dates.length <= maxPoints || currentDataDensity === 'high') {
                return chartData;
            }
            
            // Reduce data points for performance
            const step = Math.ceil(chartData.dates.length / maxPoints);
            const reducedDates = [];
            const reducedClose = [];
            const reducedEma200 = [];
            const reducedMacdLine = [];
            const reducedMacdSignal = [];
            const reducedMacdHistogram = [];
            
            for (let i = 0; i < chartData.dates.length; i += step) {
                reducedDates.push(chartData.dates[i]);
                reducedClose.push(chartData.close[i]);
                reducedEma200.push(chartData.ema200[i]);
                reducedMacdLine.push(chartData.macd_line[i]);
                reducedMacdSignal.push(chartData.macd_signal[i]);
                reducedMacdHistogram.push(chartData.macd_histogram[i]);
            }
            
            console.log(`Reduced data from ${chartData.dates.length} to ${reducedDates.length} points`);
            
            return {
                dates: reducedDates,
                close: reducedClose,
                ema200: reducedEma200,
                macd_line: reducedMacdLine,
                macd_signal: reducedMacdSignal,
                macd_histogram: reducedMacdHistogram
            };
        }
        
        // Toggle data density
        function toggleDataDensity() {
            currentDataDensity = currentDataDensity === 'normal' ? 'high' : 'normal';
            
            // Recreate charts with new density
            const analysisResults = document.getElementById('analysisResults');
            if (analysisResults.style.display !== 'none') {
                // Re-fetch analysis to get fresh data
                getAnalysis();
            }
        }
        
        // Create price chart with EMA200
        function createPriceChart(chartData) {
            console.log('Creating price chart with:', chartData.dates.length, 'data points');
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Optimize data if too many points
            const displayData = optimizeChartData(chartData, 200);
            
            // Validate data
            if (!displayData.dates || !displayData.close) {
                console.error('❌ Missing required chart data');
                return;
            }
            
            try {
                const labels = displayData.dates;
                const prices = displayData.close;
                const ema200 = displayData.ema200;
                
                // Determine trend color
                const firstPrice = prices[0];
                const lastPrice = prices[prices.length - 1];
                const trendColor = lastPrice >= firstPrice ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)';
                
                const datasets = [
                    {
                        label: 'Harga',
                        data: prices,
                        borderColor: trendColor,
                        backgroundColor: trendColor.replace('0.8', '0.1'),
                        borderWidth: 1.2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: currentDataDensity === 'high' ? 1 : 0,
                        pointHoverRadius: 3,
                        yAxisID: 'y'
                    }
                ];
                
                // Add EMA200 if available and enabled
                if (ema200 && ema200.length > 0 && chartIndicators.ema200) {
                    datasets.push({
                        label: 'EMA 200',
                        data: ema200,
                        borderColor: 'rgba(155, 89, 182, 0.8)',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 1.2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: currentDataDensity === 'high' ? 1 : 0,
                        pointHoverRadius: 3,
                        yAxisID: 'y'
                    });
                }
                
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(4);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Waktu'
                                },
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxTicksLimit: 10,
                                    callback: function(value, index, values) {
                                        // Show only some labels to avoid overcrowding
                                        if (index % Math.ceil(values.length / 8) === 0) {
                                            return this.getLabelForValue(value);
                                        }
                                        return '';
                                    }
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Harga'
                                },
                                position: 'left'
                            }
                        }
                    }
                });
                
                console.log('✅ Price chart created with', labels.length, 'data points');
            } catch (error) {
                console.error('❌ Error creating price chart:', error);
            }
        }
        
        // Create MACD chart
        function createMACDChart(chartData) {
            const ctx = document.getElementById('macdChart').getContext('2d');
            
            if (macdChart) {
                macdChart.destroy();
            }
            
            // Optimize data for MACD too
            const displayData = optimizeChartData(chartData, 200);
            
            const macdLine = displayData.macd_line;
            const macdSignal = displayData.macd_signal;
            const macdHistogram = displayData.macd_histogram;
            
            // Only create MACD chart if data is available and enabled
            if (!macdLine || macdLine.length === 0 || !chartIndicators.macd) {
                document.getElementById('macdChart').style.display = 'none';
                return;
            }
            
            document.getElementById('macdChart').style.display = 'block';
            
            try {
                const datasets = [
                    {
                        label: 'MACD Line',
                        data: macdLine,
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 1.2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: currentDataDensity === 'high' ? 1 : 0
                    },
                    {
                        label: 'Signal Line',
                        data: macdSignal,
                        borderColor: 'rgba(231, 76, 60, 1)',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 1.2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: currentDataDensity === 'high' ? 1 : 0
                    },
                    {
                        label: 'MACD Histogram',
                        data: macdHistogram,
                        type: 'bar',
                        backgroundColor: macdHistogram.map(value => 
                            value >= 0 ? 'rgba(39, 174, 96, 0.7)' : 'rgba(231, 76, 60, 0.7)'
                        ),
                        borderColor: macdHistogram.map(value => 
                            value >= 0 ? 'rgba(39, 174, 96, 1)' : 'rgba(231, 76, 60, 1)'
                        ),
                        borderWidth: 0.5,
                        order: 3
                    }
                ];
                
                macdChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: displayData.dates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Waktu'
                                },
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxTicksLimit: 10,
                                    callback: function(value, index, values) {
                                        if (index % Math.ceil(values.length / 8) === 0) {
                                            return this.getLabelForValue(value);
                                        }
                                        return '';
                                    }
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Nilai MACD'
                                },
                                position: 'left'
                            }
                        }
                    }
                });
                
                console.log('✅ MACD chart created with', displayData.dates.length, 'data points');
            } catch (error) {
                console.error('❌ Error creating MACD chart:', error);
            }
        }
        
        // Toggle indicators on/off
        function toggleIndicator(indicator, isVisible) {
            chartIndicators[indicator] = isVisible;
            
            // Recreate charts with updated visibility
            const analysisResults = document.getElementById('analysisResults');
            if (analysisResults.style.display !== 'none') {
                // Re-fetch analysis to get fresh data
                getAnalysis();
            }
        }
        
        // Show performance metrics
        async function showPerformance() {
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('quickOverview').style.display = 'none';
            
            try {
                const response = await fetch('/performance');
                const data = await response.json();
                
                let html = '<div class="row">';
                
                if (data.error) {
                    html = `<div class="alert alert-warning">${data.error}</div>`;
                } else if (data.length === 0) {
                    html = `<div class="alert alert-info">Belum ada data performa. Lakukan analisis terlebih dahulu.</div>`;
                } else {
                    data.forEach(item => {
                        html += `
                            <div class="col-md-6 col-lg-3 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5>${item.pair}</h5>
                                        <div class="display-6 fw-bold text-primary">${item.analysis_count}</div>
                                        <small>Analisis (24h)</small>
                                        <div class="mt-2">
                                            <span class="badge bg-${item.avg_confidence > 70 ? 'success' : item.avg_confidence > 50 ? 'warning' : 'danger'}">
                                                ${item.avg_confidence}% Confidence
                                            </span>
                                        </div>
                                        <small class="text-muted">AI: ${item.ai_provider}</small>
                                        <br>
                                        <small class="text-muted">Terakhir: ${new Date(item.last_analysis).toLocaleTimeString()}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('performanceContent').innerHTML = html;
                document.getElementById('performanceMetrics').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading performance:', error);
                document.getElementById('performanceContent').innerHTML = '<div class="alert alert-danger">Error loading performance data</div>';
            }
        }
        
        // Hide performance metrics
        function hidePerformance() {
            document.getElementById('performanceMetrics').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('quickOverview').style.display = 'block';
        }
        
        // Auto-refresh overview every 30 seconds
        setInterval(loadQuickOverview, 30000);
    </script>
</body>
</html>
