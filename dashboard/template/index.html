<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ANDRO-FX Precision Forex Trading</title>

  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --deepseek-primary: #0066cc;
      --deepseek-secondary: #00aaff;
      --deepseek-accent: #004499;
      --signal-buy: #10b981;
      --signal-sell: #ef4444;
      --signal-hold: #f59e0b;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --bg-primary: #f8fafc;
      --bg-card: #ffffff;
      --border-radius: 12px;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: "Inter", "Segoe UI", sans-serif;
      padding: 18px;
      margin: 0;
    }

    .topbar {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 15px 20px;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--deepseek-primary);
    }

    .brand-logo i {
      color: var(--deepseek-secondary);
    }

    .card-soft {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--deepseek-primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--deepseek-secondary);
    }

    #chartRoot, #macdRoot {
      width: 100%;
      background: var(--bg-card);
    }
    
    #chartRoot { 
      height: 400px; 
    }
    
    #macdRoot { 
      height: 150px; 
      margin-top: 10px;
    }

    .muted { 
      color: var(--text-secondary); 
      font-size: 0.95rem; 
    }

    .ai-signal-buy, .ai-signal-sell, .ai-signal-hold {
      color: white; 
      padding: 8px 16px; 
      border-radius: 8px; 
      font-weight: 700;
      font-size: 1.2rem;
      text-align: center;
      margin: 10px 0;
    }

    .ai-signal-buy { 
      background: var(--signal-buy);
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
    }

    .ai-signal-sell { 
      background: var(--signal-sell);
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
    }

    .ai-signal-hold { 
      background: var(--signal-hold);
      box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>

<!-- Simple Loading Screen -->
<div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); display: flex; justify-content: center; align-items: center; z-index: 9999;">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <div>Loading ANDRO-FX Trading System...</div>
  </div>
</div>

<div class="topbar">
  <div class="brand-logo">
    <i class="fas fa-brain"></i>
    <span>ANDRO-FX Precision Forex Trading</span>
  </div>
  
  <div class="d-flex flex-wrap gap-3 align-items-center ms-auto">
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Pair</label>
      <select id="pairSelect" class="form-select form-select-sm" style="width:130px;">
        <option>USDJPY</option>
        <option>EURJPY</option>
        <option>GBPJPY</option>
        <option>GBPUSD</option>
      </select>
    </div>
    
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Timeframe</label>
      <select id="timeframeSelect" class="form-select form-select-sm" style="width:100px;">
        <option value="1D">1D</option>
        <option value="4H">4H</option>
        <option value="1H">1H</option>
      </select>
    </div>
    
    <button id="analyzeBtn" class="btn btn-primary">
      <i class="fas fa-chart-line me-2"></i>Analyze
    </button>
    
    <div class="d-flex align-items-center ms-3">
      <span class="price-ticker me-2" id="currentPair">USDJPY –</span>
      <span id="livePrice" class="price-ticker">0.0000</span>
      <span id="statusIndicator" class="badge bg-secondary ms-2">Offline</span>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-chart-candlestick"></i>
        <span>Price Chart</span>
      </div>
      <div id="chartRoot">
        <div class="loading">
          <i class="fas fa-chart-line fa-2x mb-3"></i>
          <div>Loading chart data...</div>
        </div>
      </div>
      <div id="macdRoot">
        <div class="loading">
          <div>Loading MACD indicator...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-robot"></i>
        <span>Trading Signal</span>
      </div>
      <div id="aiSignalBadge" class="ai-signal-hold">LOADING...</div>
      <div id="aiSummary" class="muted">Initializing analysis system...</div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-shield-alt"></i>
        <span>Risk Management</span>
      </div>
      <div id="riskStatus" class="muted">Assessing risk...</div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-layer-group"></i>
        <span>Technical Analysis</span>
      </div>
      <div id="techIndicators" class="muted">Calculating indicators...</div>
    </div>
  </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Simple initialization with minimal dependencies
console.log('Starting ANDRO-FX Frontend...');

// Hide loading screen when page is ready
window.addEventListener('load', function() {
  console.log('Page fully loaded');
  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
    initializeApp();
  }, 1000);
});

// Simple error handler
window.addEventListener('error', function(e) {
  console.error('Global error:', e.error);
  document.getElementById('aiSummary').textContent = 'Error: ' + e.error.message;
  document.getElementById('loadingScreen').style.display = 'none';
});

async function initializeApp() {
  console.log('Initializing application...');
  
  try {
    // Initialize basic UI
    await initializeBasicUI();
    
    // Load charts only if Lightweight Charts is available
    if (typeof LightweightCharts !== 'undefined') {
      await initializeCharts();
    } else {
      console.warn('Lightweight Charts not available, using simple display');
      document.getElementById('chartRoot').innerHTML = '<div class="alert alert-info">Chart library loading...</div>';
    }
    
    // Perform initial analysis
    await analyze();
    
    console.log('Application initialized successfully');
    
  } catch (error) {
    console.error('Failed to initialize app:', error);
    showError('Initialization failed: ' + error.message);
  }
}

async function initializeBasicUI() {
  console.log('Initializing basic UI...');
  
  // Set up event listeners
  document.getElementById('analyzeBtn').addEventListener('click', analyze);
  document.getElementById('pairSelect').addEventListener('change', analyze);
  document.getElementById('timeframeSelect').addEventListener('change', analyze);
  
  // Update current pair display
  document.getElementById('currentPair').textContent = document.getElementById('pairSelect').value + ' –';
  
  console.log('Basic UI initialized');
}

async function initializeCharts() {
  console.log('Initializing charts...');
  
  try {
    const chartRoot = document.getElementById('chartRoot');
    const macdRoot = document.getElementById('macdRoot');
    
    // Clear loading messages
    chartRoot.innerHTML = '';
    macdRoot.innerHTML = '';
    
    // Create main chart
    const chart = LightweightCharts.createChart(chartRoot, {
      width: chartRoot.clientWidth,
      height: 400,
      layout: {
        background: { color: '#ffffff' },
        textColor: '#333',
      },
      grid: {
        vertLines: { color: '#f0f3fa' },
        horzLines: { color: '#f0f3fa' },
      },
    });
    
    // Create candlestick series
    const candleSeries = chart.addCandlestickSeries({
      upColor: '#26a69a',
      downColor: '#ef5350',
      borderVisible: false,
      wickUpColor: '#26a69a',
      wickDownColor: '#ef5350',
    });
    
    // Create MACD chart
    const macdChart = LightweightCharts.createChart(macdRoot, {
      width: macdRoot.clientWidth,
      height: 150,
      layout: {
        background: { color: '#ffffff' },
        textColor: '#333',
      },
      grid: {
        vertLines: { color: '#f0f3fa' },
        horzLines: { color: '#f0f3fa' },
      },
    });
    
    const macdLineSeries = macdChart.addLineSeries({
      color: '#2962FF',
      lineWidth: 1,
    });
    
    // Store chart instances globally
    window.tradingCharts = {
      mainChart: chart,
      candleSeries: candleSeries,
      macdChart: macdChart,
      macdLineSeries: macdLineSeries
    };
    
    console.log('Charts initialized successfully');
    
  } catch (error) {
    console.error('Chart initialization failed:', error);
    throw new Error('Could not initialize charts: ' + error.message);
  }
}

async function analyze() {
  console.log('Starting analysis...');
  
  const pair = document.getElementById('pairSelect').value;
  const timeframe = document.getElementById('timeframeSelect').value;
  
  try {
    // Show loading state
    document.getElementById('aiSignalBadge').className = 'ai-signal-hold';
    document.getElementById('aiSignalBadge').textContent = 'ANALYZING...';
    document.getElementById('aiSummary').textContent = 'Fetching market data...';
    document.getElementById('riskStatus').textContent = 'Calculating risk...';
    
    // Fetch analysis data
    const analysisData = await fetchAnalysisData(pair, timeframe);
    
    // Update UI with analysis results
    updateTradingSignal(analysisData);
    updateRiskAssessment(analysisData);
    updateTechnicalIndicators(analysisData);
    updatePriceData(analysisData);
    
    // Update charts if available
    if (window.tradingCharts) {
      await updateCharts(analysisData);
    }
    
    console.log('Analysis completed successfully');
    
  } catch (error) {
    console.error('Analysis failed:', error);
    showError('Analysis failed: ' + error.message);
  }
}

async function fetchAnalysisData(pair, timeframe) {
  console.log(`Fetching analysis for ${pair} ${timeframe}...`);
  
  try {
    const response = await fetch(`/api/analyze?pair=${pair}&timeframe=${timeframe}`);
    
    if (!response.ok) {
      throw new Error(`Server returned ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Analysis data received:', data);
    return data;
    
  } catch (error) {
    console.error('Failed to fetch analysis data:', error);
    
    // Return sample data as fallback
    return generateSampleData(pair, timeframe);
  }
}

function generateSampleData(pair, timeframe) {
  console.log('Generating sample data...');
  
  const samplePrice = 148.75 + (Math.random() - 0.5) * 2;
  const signal = Math.random() > 0.6 ? 'BUY' : Math.random() > 0.3 ? 'SELL' : 'HOLD';
  
  return {
    ai_analysis: {
      signal: signal,
      confidence: Math.floor(60 + Math.random() * 35),
      analysis_summary: `Sample analysis for ${pair} on ${timeframe}. Market shows ${signal.toLowerCase()} signals.`,
      entry_price: (samplePrice * 0.998).toFixed(4),
      stop_loss: (samplePrice * 0.99).toFixed(4),
      take_profit_1: (samplePrice * 1.01).toFixed(4)
    },
    price_data: {
      current: samplePrice,
      change_pct: (Math.random() - 0.5) * 2
    },
    technical_analysis: {
      momentum: {
        rsi: (30 + Math.random() * 40).toFixed(2),
        macd: (Math.random() - 0.5).toFixed(4)
      },
      trend: {
        adx: (20 + Math.random() * 30).toFixed(2),
        trend_direction: Math.random() > 0.5 ? 'Bullish' : 'Bearish'
      }
    },
    risk_assessment: {
      risk_score: Math.floor(Math.random() * 10),
      approved: Math.random() > 0.3
    }
  };
}

function updateTradingSignal(analysisData) {
  const aiAnalysis = analysisData.ai_analysis || {};
  const signal = aiAnalysis.signal || 'HOLD';
  const confidence = aiAnalysis.confidence || 0;
  
  const signalElement = document.getElementById('aiSignalBadge');
  signalElement.textContent = signal;
  
  // Update signal color
  if (signal === 'BUY') {
    signalElement.className = 'ai-signal-buy';
  } else if (signal === 'SELL') {
    signalElement.className = 'ai-signal-sell';
  } else {
    signalElement.className = 'ai-signal-hold';
  }
  
  // Update summary
  document.getElementById('aiSummary').textContent = 
    aiAnalysis.analysis_summary || `${signal} signal with ${confidence}% confidence`;
}

function updateRiskAssessment(analysisData) {
  const risk = analysisData.risk_assessment || {};
  const score = risk.risk_score || 0;
  const approved = risk.approved;
  
  let riskText = `Risk Score: ${score}/10 - `;
  riskText += approved ? 'APPROVED' : 'REVIEW NEEDED';
  
  document.getElementById('riskStatus').textContent = riskText;
  
  // Update risk color
  const riskElement = document.getElementById('riskStatus');
  riskElement.className = '';
  if (score <= 3) {
    riskElement.classList.add('text-success');
  } else if (score <= 6) {
    riskElement.classList.add('text-warning');
  } else {
    riskElement.classList.add('text-danger');
  }
}

function updateTechnicalIndicators(analysisData) {
  const tech = analysisData.technical_analysis || {};
  const momentum = tech.momentum || {};
  const trend = tech.trend || {};
  
  let html = `
    <div class="row">
      <div class="col-6"><strong>RSI:</strong> ${momentum.rsi || 'N/A'}</div>
      <div class="col-6"><strong>MACD:</strong> ${momentum.macd || 'N/A'}</div>
    </div>
    <div class="row mt-2">
      <div class="col-6"><strong>ADX:</strong> ${trend.adx || 'N/A'}</div>
      <div class="col-6"><strong>Trend:</strong> ${trend.trend_direction || 'N/A'}</div>
    </div>
  `;
  
  document.getElementById('techIndicators').innerHTML = html;
}

function updatePriceData(analysisData) {
  const priceData = analysisData.price_data || {};
  const currentPrice = priceData.current || 0;
  const change = priceData.change_pct || 0;
  
  document.getElementById('livePrice').textContent = currentPrice.toFixed(4);
  document.getElementById('currentPair').textContent = 
    document.getElementById('pairSelect').value + ' –';
  
  // Update status indicator
  const statusElement = document.getElementById('statusIndicator');
  statusElement.textContent = 'Live';
  statusElement.className = 'badge bg-success ms-2';
}

async function updateCharts(analysisData) {
  console.log('Updating charts...');
  
  try {
    const charts = window.tradingCharts;
    if (!charts || !charts.candleSeries) {
      console.warn('Charts not available for update');
      return;
    }
    
    // Generate sample chart data
    const chartData = generateChartData();
    
    // Update main chart
    charts.candleSeries.setData(chartData);
    
    // Generate MACD data
    const macdData = generateMACDData(chartData);
    
    // Update MACD chart
    charts.macdLineSeries.setData(macdData);
    
    console.log('Charts updated successfully');
    
  } catch (error) {
    console.error('Failed to update charts:', error);
  }
}

function generateChartData() {
  const data = [];
  const basePrice = 148.75;
  const now = new Date();
  
  for (let i = 100; i >= 0; i--) {
    const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
    
    const open = basePrice + (Math.random() - 0.5) * 2;
    const close = open + (Math.random() - 0.5) * 1.5;
    const high = Math.max(open, close) + Math.random() * 1;
    const low = Math.min(open, close) - Math.random() * 1;
    
    data.push({
      time: date.toISOString().split('T')[0],
      open: parseFloat(open.toFixed(4)),
      high: parseFloat(high.toFixed(4)),
      low: parseFloat(low.toFixed(4)),
      close: parseFloat(close.toFixed(4))
    });
  }
  
  return data;
}

function generateMACDData(chartData) {
  return chartData.map((item, index) => ({
    time: item.time,
    value: (Math.sin(index * 0.1) * 0.5 + (Math.random() - 0.5) * 0.2)
  }));
}

function showError(message) {
  console.error('Displaying error:', message);
  
  // Update UI to show error
  document.getElementById('aiSignalBadge').className = 'ai-signal-hold';
  document.getElementById('aiSignalBadge').textContent = 'ERROR';
  document.getElementById('aiSummary').textContent = message;
  document.getElementById('aiSummary').style.color = '#ef4444';
  
  document.getElementById('riskStatus').textContent = 'Risk assessment unavailable';
  document.getElementById('techIndicators').textContent = 'Technical data unavailable';
  
  document.getElementById('statusIndicator').textContent = 'Error';
  document.getElementById('statusIndicator').className = 'badge bg-danger ms-2';
}

// Handle window resize
window.addEventListener('resize', function() {
  if (window.tradingCharts && window.tradingCharts.mainChart) {
    try {
      const chartRoot = document.getElementById('chartRoot');
      const macdRoot = document.getElementById('macdRoot');
      
      window.tradingCharts.mainChart.resize(chartRoot.clientWidth, 400);
      window.tradingCharts.macdChart.resize(macdRoot.clientWidth, 150);
    } catch (error) {
      console.log('Resize error:', error);
    }
  }
});

// Export functions for global access
window.analyze = analyze;
window.initializeApp = initializeApp;

console.log('ANDRO-FX Frontend script loaded');
</script>
</body>
</html>
