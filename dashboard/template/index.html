<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AndroFX - Precision Forex Trading</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* CSS styling tetap sama seperti sebelumnya */
    :root {
      --andro-primary: #0f172a;
      --andro-secondary: #1e293b;
      --andro-accent: #3b82f6;
      --andro-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      --andro-success: #10b981;
      --andro-danger: #ef4444;
      --andro-warning: #f59e0b;
      --andro-info: #06b6d4;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --bg-primary: #0f172a;
      --bg-card: #1e293b;
      --border-radius: 16px;
      --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.15);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    * {
      font-family: 'Inter', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text-primary);
      padding: 20px;
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      padding: 20px 30px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-glow);
      border: 1px solid rgba(59, 130, 246, 0.2);
      backdrop-filter: blur(10px);
    }

    .brand-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 2rem;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    .brand-tagline {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--andro-info);
      font-style: italic;
      letter-spacing: 1px;
    }

    .brand-logo i {
      color: #3b82f6;
      font-size: 2.2rem;
      filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
    }

    .card-soft {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow-card);
      margin-bottom: 25px;
      border: 1px solid rgba(59, 130, 246, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card-soft::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--andro-gradient);
    }

    .card-soft:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .section-title i {
      color: var(--andro-accent);
      background: rgba(59, 130, 246, 0.1);
      padding: 10px;
      border-radius: 12px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #chartRoot { 
      height: 520px; 
      border-radius: var(--border-radius); 
      background: var(--bg-card);
      box-shadow: inset 0 2px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(59, 130, 246, 0.1);
    }
    
    #macdRoot { 
      height: 160px; 
      margin-top: 15px; 
      border-radius: var(--border-radius); 
      background: var(--bg-card);
      box-shadow: inset 0 2px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .muted { 
      color: var(--text-secondary); 
      font-size: 0.95rem; 
      line-height: 1.5;
    }

    .ai-signal-buy { 
      color: white; 
      background: linear-gradient(135deg, var(--andro-success) 0%, #059669 100%);
      padding: 15px 25px; 
      border-radius: 12px; 
      font-weight: 700;
      font-size: 1.4rem;
      text-align: center;
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .ai-signal-buy::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }

    .ai-signal-buy:hover::before {
      left: 100%;
    }

    .ai-signal-sell { 
      color: white; 
      background: linear-gradient(135deg, var(--andro-danger) 0%, #dc2626 100%);
      padding: 15px 25px; 
      border-radius: 12px; 
      font-weight: 700;
      font-size: 1.4rem;
      text-align: center;
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .ai-signal-hold { 
      color: white; 
      background: linear-gradient(135deg, var(--andro-warning) 0%, #d97706 100%);
      padding: 15px 25px; 
      border-radius: 12px; 
      font-weight: 700;
      font-size: 1.4rem;
      text-align: center;
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .small-muted { 
      color: var(--text-secondary); 
      font-size: 0.85rem; 
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 0 15px currentColor;
    }

    .status-live { 
      background-color: var(--andro-success);
      animation: pulse 2s infinite;
    }

    .status-offline { 
      background-color: var(--andro-danger);
    }

    @keyframes pulse {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .metric-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid var(--andro-accent);
      transition: all 0.3s ease;
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .metric-card:hover {
      transform: translateX(5px);
      border-color: rgba(59, 130, 246, 0.3);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .metric-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text-primary);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .backtest-panel {
      max-height: 400px;
      overflow-y: auto;
    }

    .performance-grade {
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .grade-a { background: linear-gradient(135deg, #065f46 0%, #047857 100%); color: #ffffff; }
    .grade-b { background: linear-gradient(135deg, #92400e 0%, #b45309 100%); color: #ffffff; }
    .grade-c { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); color: #ffffff; }
    .grade-d { background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%); color: #ffffff; }

    .trading-level {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 12px 16px;
      border-radius: 10px;
      margin: 8px 0;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .trading-level:hover {
      transform: translateX(8px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .level-entry { 
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
      color: var(--andro-success);
      border-left: 4px solid var(--andro-success);
    }

    .level-sl { 
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
      color: var(--andro-danger);
      border-left: 4px solid var(--andro-danger);
    }

    .level-tp { 
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.15) 100%);
      color: #22c55e;
      border-left: 4px solid #22c55e;
    }

    .btn-androfx {
      background: var(--andro-gradient);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      transition: all 0.3s ease;
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
      position: relative;
      overflow: hidden;
    }

    .btn-androfx::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }

    .btn-androfx:hover::before {
      left: 100%;
    }

    .btn-androfx:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.5);
      color: white;
    }

    .btn-action {
      background: linear-gradient(135deg, var(--andro-info) 0%, #0891b2 100%);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      transition: all 0.3s ease;
      box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
    }

    .btn-action:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(6, 182, 212, 0.5);
      color: white;
    }

    .price-ticker {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .price-change {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .change-positive { color: var(--andro-success); }
    .change-negative { color: var(--andro-danger); }

    .risk-approved { 
      color: var(--andro-success); 
      font-weight: 700;
      font-size: 1.1rem;
    }

    .risk-rejected { 
      color: var(--andro-danger); 
      font-weight: 700;
      font-size: 1.1rem;
    }

    .tech-indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .tech-indicator:hover {
      background: rgba(59, 130, 246, 0.05);
      border-radius: 8px;
      padding: 12px 10px;
      transform: translateX(5px);
    }

    .indicator-value {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .news-container {
      max-height: 120px;
      overflow-y: auto;
      padding: 15px;
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
      border-radius: 10px;
      border-left: 4px solid var(--andro-accent);
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    /* Risk Management Styles */
    .risk-meter-bar {
      background: #374151;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .risk-meter-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.5s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .risk-meter-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .risk-factor-card {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 10px;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .risk-factor-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .risk-factor-card.low {
      border-left: 4px solid var(--andro-success);
    }

    .risk-factor-card.medium {
      border-left: 4px solid var(--andro-warning);
    }

    .risk-factor-card.high {
      border-left: 4px solid var(--andro-danger);
    }

    .risk-factor-card.pending {
      border-left: 4px solid #6b7280;
    }

    .risk-factor-name {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .risk-factor-status {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .risk-tip {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.85rem;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .risk-tip:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }

    /* Support Resistance Styles */
    .levels-container {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .level-card {
      flex: 1;
      padding: 18px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .level-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .support-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .resistance-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .level-title {
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .support-title {
      color: var(--andro-success);
    }

    .resistance-title {
      color: var(--andro-danger);
    }

    .level-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .level-distance {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
      font-weight: 500;
    }

    .pivot-levels {
      margin-top: 18px;
    }

    .pivot-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .pivot-row:hover {
      background: rgba(59, 130, 246, 0.05);
      border-radius: 6px;
      padding: 8px 10px;
    }

    .pivot-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .pivot-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--andro-accent);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2563eb;
    }

    /* Form controls styling */
    .form-select, .form-control {
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 10px 12px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: #1e293b;
      color: var(--text-primary);
    }

    .form-select:focus, .form-control:focus {
      border-color: var(--andro-accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: #1e293b;
      color: var(--text-primary);
    }

    /* Badge styling */
    .badge {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
    }

    /* Alert styling */
    .alert {
      border-radius: 10px;
      border: none;
      font-size: 0.85rem;
    }

    /* Modal styling */
    .modal-content {
      border-radius: 16px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .modal-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px 25px;
    }

    .modal-body {
      padding: 25px;
    }

    .modal-footer {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px 25px;
    }

    .btn-close {
      filter: invert(1);
    }

    /* Loading states */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div class="topbar">
  <div class="brand-container">
    <div class="brand-logo">
      <i class="fas fa-robot"></i>
      <span>AndroFX</span>
    </div>
    <div class="brand-tagline">PRECISION TRADING</div>
  </div>
  
  <div class="d-flex flex-wrap gap-3 align-items-center ms-auto">
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Pair</label>
      <select id="pairSelect" class="form-select form-select-sm" style="width:130px;">
        <option>USDJPY</option>
        <option>EURJPY</option>
        <option>GBPJPY</option>
        <option>CHFJPY</option>
        <option>GBPUSD</option>
        <option>USDCHF</option>
        <option>AUDUSD</option>
        <option>USDCAD</option>
        <option>NZDUSD</option>
      </select>
    </div>
    
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Timeframe</label>
      <select id="timeframeSelect" class="form-select form-select-sm" style="width:100px;">
        <option>1D</option>
        <option>4H</option>
        <option>1H</option>
        <option>M30</option>
      </select>
    </div>
    
    <button id="analyzeBtn" class="btn btn-androfx">
      <i class="fas fa-chart-line me-2"></i>Analyze
    </button>
    
    <button id="runBacktestBtn" class="btn btn-action">
      <i class="fas fa-play-circle me-2"></i>Backtest
    </button>
    
    <div id="pairTicker" class="d-flex align-items-center ms-3">
      <span class="price-ticker me-2">USDJPY –</span>
      <span id="livePrice" class="price-ticker">0.0000</span>
      <span id="pairChange" class="price-change ms-2">(0.00%)</span>
      <span id="statusIndicator" class="status-indicator status-offline ms-2"></span>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card-soft">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <div class="section-title">
            <i class="fas fa-chart-candlestick"></i>
            <span>Live Price Chart</span>
          </div>
          <div class="muted" id="chartSubtitle">Real-time Candlestick · EMA26 · MACD</div>
        </div>
        <div class="text-end">
          <div class="small-muted">Current Price</div>
          <div class="price-ticker" id="currentPrice">-</div>
        </div>
      </div>
      <div id="chartRoot"></div>
      <div id="macdRoot"></div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-robot"></i>
        <span>AI Trading Signal</span>
      </div>
      
      <div id="aiSummary" class="muted mb-3">No analysis yet. Click Analyze to start.</div>
      
      <div class="mb-3">
        <div class="small-muted mb-2">TRADING SIGNAL</div>
        <div id="aiSignalBadge" class="ai-signal-hold">HOLD</div>
      </div>
      
      <div class="row mb-3">
        <div class="col-6">
          <div class="metric-card">
            <div class="small-muted">Confidence</div>
            <div class="metric-value" id="aiConfidence">-</div>
          </div>
        </div>
        <div class="col-6">
          <div class="metric-card">
            <div class="small-muted">Risk Level</div>
            <div class="metric-value" id="aiRisk">-</div>
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <div class="small-muted mb-2">TRADING LEVELS</div>
        <div class="trading-level level-entry">
          <i class="fas fa-sign-in-alt me-2"></i>Entry: <span id="aiEntry">-</span>
        </div>
        <div class="trading-level level-sl">
          <i class="fas fa-stop-circle me-2"></i>Stop Loss: <span id="aiSL">-</span>
        </div>
        <div class="trading-level level-tp">
          <i class="fas fa-target me-2"></i>Take Profit 1: <span id="aiTP1">-</span>
        </div>
        <div class="trading-level level-tp">
          <i class="fas fa-bullseye me-2"></i>Take Profit 2: <span id="aiTP2">-</span>
        </div>
      </div>
    </div>

    <!-- Risk Management Card -->
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-shield-alt"></i>
        <span>Risk Management</span>
      </div>
      
      <!-- Risk Status dengan Visual yang Lebih Menarik -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="small-muted">TRADE APPROVAL STATUS</div>
          <div id="riskScoreBadge" class="badge bg-secondary">Score: -/10</div>
        </div>
        
        <div id="riskStatus" class="text-center p-4 rounded-3 mb-3" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%); border: 2px solid rgba(59, 130, 246, 0.3);">
          <div class="risk-icon mb-2">
            <i class="fas fa-question-circle fa-2x text-muted"></i>
          </div>
          <div id="riskMainStatus" class="fw-bold fs-5">Awaiting Analysis</div>
          <div id="riskSubStatus" class="small text-muted mt-1">No risk assessment data available</div>
        </div>
      </div>

      <!-- Risk Score Visualization -->
      <div class="mb-4">
        <div class="small-muted mb-2">RISK SCORE BREAKDOWN</div>
        <div class="risk-score-container">
          <div class="risk-meter mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Low Risk</span>
              <span class="small">High Risk</span>
            </div>
            <div class="risk-meter-bar">
              <div id="riskMeterFill" class="risk-meter-fill" style="width: 0%"></div>
            </div>
            <div class="risk-meter-labels">
              <span>0</span>
              <span>2</span>
              <span>4</span>
              <span>6</span>
              <span>8</span>
              <span>10</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Factors Grid -->
      <div class="mb-4">
        <div class="small-muted mb-2">RISK FACTORS</div>
        <div id="riskFactors" class="row g-2">
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Market Volatility</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Position Size</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Correlation</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Daily Limits</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Details -->
      <div id="riskDetails" style="display: none;">
        <div class="small-muted mb-2">DETAILED ANALYSIS</div>
        <div id="riskWarnings" class="alert alert-warning py-2 small">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span>No warnings detected</span>
        </div>
        <div id="riskRejections" class="alert alert-danger py-2 small" style="display: none;">
          <i class="fas fa-times-circle me-2"></i>
          <span>Rejection reasons will appear here</span>
        </div>
      </div>

      <!-- Risk Management Tips -->
      <div class="mt-3 pt-3 border-top">
        <div class="small-muted mb-2">RISK MANAGEMENT TIPS</div>
        <div class="risk-tips">
          <div class="risk-tip">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            <span class="small">Always use stop-loss orders</span>
          </div>
          <div class="risk-tip">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            <span class="small">Risk only 1-2% per trade</span>
          </div>
          <div class="risk-tip">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            <span class="small">Monitor correlation between pairs</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Support & Resistance Card -->
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-layer-group"></i>
        <span>Support & Resistance</span>
      </div>
      
      <div class="levels-container">
        <div class="level-card support-card">
          <div class="level-title support-title">SUPPORT</div>
          <div class="level-value" id="supportLevel">-</div>
          <div class="level-distance" id="supportDistance">-</div>
        </div>
        <div class="level-card resistance-card">
          <div class="level-title resistance-title">RESISTANCE</div>
          <div class="level-value" id="resistanceLevel">-</div>
          <div class="level-distance" id="resistanceDistance">-</div>
        </div>
      </div>

      <div class="pivot-levels">
        <div class="small-muted mb-2">PIVOT POINTS</div>
        <div class="pivot-row">
          <span class="pivot-label">R3</span>
          <span class="pivot-value" id="pivotR3">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">R2</span>
          <span class="pivot-value" id="pivotR2">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">R1</span>
          <span class="pivot-value" id="pivotR1">-</span>
        </div>
        <div class="pivot-row" style="border-bottom: 2px solid #3b82f6;">
          <span class="pivot-label">PIVOT</span>
          <span class="pivot-value" id="pivotPoint">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">S1</span>
          <span class="pivot-value" id="pivotS1">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">S2</span>
          <span class="pivot-value" id="pivotS2">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">S3</span>
          <span class="pivot-value" id="pivotS3">-</span>
        </div>
      </div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-newspaper"></i>
        <span>Market News</span>
      </div>
      <div class="news-container" id="fundamentalNews">
        No news available. Analyzing market conditions...
      </div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-chart-bar"></i>
        <span>Technical Analysis</span>
      </div>
      
      <div class="tech-indicator">
        <span class="small-muted">RSI</span>
        <span class="indicator-value" id="rsiVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">MACD</span>
        <span class="indicator-value" id="macdVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">MACD Histogram</span>
        <span class="indicator-value" id="macdHistVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">ADX</span>
        <span class="indicator-value" id="adxVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">ATR</span>
        <span class="indicator-value" id="atrVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">Volatility</span>
        <span class="indicator-value" id="volVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">Trend</span>
        <span class="indicator-value" id="trendVal">-</span>
      </div>
    </div>
    
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-chart-line"></i>
        <span>Backtest Results</span>
        <span id="backtestStatus" class="badge bg-secondary ms-2">Not Run</span>
      </div>
      <div id="backtestResults" class="backtest-panel">
        <div class="text-center muted">Run backtest to see performance results</div>
      </div>
    </div>
  </div>
</div>

<!-- Backtest Configuration Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-play-circle me-2"></i>Run Backtest
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Initial Balance ($)</label>
          <input type="number" class="form-control" id="initialBalance" value="10000" min="1000" step="1000">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Period (Days)</label>
          <input type="number" class="form-control" id="backtestDays" value="30" min="7" max="365">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Type</label>
          <select class="form-select" id="backtestType">
            <option value="advanced">Advanced Backtest</option>
            <option value="basic">Basic Backtest</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-androfx" id="startBacktestBtn">
          <i class="fas fa-play me-2"></i>Start Backtest
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global state untuk menyimpan data chart
let currentChartData = [];
let currentEmaData = [];
let currentMacdData = { macd: [], signal: [], hist: [] };
let lastCandleTime = null;

// API Base URL - sesuaikan dengan backend Flask
const API_BASE_URL = 'http://localhost:5000';

/* ===== Utilities ===== */
function calcEMA(values, period){
  if (!values || values.length === 0) return [];
  const k=2/(period+1);
  let ema=[values[0]];
  for(let i=1;i<values.length;i++) {
    ema.push(values[i]*k+ema[i-1]*(1-k));
  }
  return ema;
}

function calcMACDSeries(c,short=12,long=26,signal=9){
  if (!c || c.length === 0) return {macd: [], sig: [], hist: []};
  const emaS=calcEMA(c,short),emaL=calcEMA(c,long);
  const macd=c.map((_,i)=>emaS[i]-emaL[i]);
  const sig=calcEMA(macd,signal);
  const hist=macd.map((v,i)=>v-(sig[i]||0));
  return {macd,sig,hist};
}

// Improved date formatting function
function fmt(d){
  try {
    if (typeof d === 'string') {
      if (d.includes('T')) {
        return d.split('T')[0];
      } else {
        return d;
      }
    } else if (d instanceof Date) {
      return d.toISOString().split('T')[0];
    }
    return String(d);
  } catch (e) {
    console.error('Date formatting error:', e, d);
    return '2023-01-01';
  }
}

// Clean data - remove null/undefined values
function cleanChartData(data) {
  return data.filter(item => 
    item && 
    item.time && 
    item.open !== null && item.open !== undefined &&
    item.high !== null && item.high !== undefined &&
    item.low !== null && item.low !== undefined &&
    item.close !== null && item.close !== undefined
  ).map(item => ({
    time: item.time,
    open: parseFloat(item.open) || 0,
    high: parseFloat(item.high) || 0,
    low: parseFloat(item.low) || 0,
    close: parseFloat(item.close) || 0
  }));
}

/* ===== Risk Management Functions ===== */
function updateRiskAssessment(riskData) {
  const riskScore = riskData.risk_score || 0;
  const approved = riskData.approved;
  const rejectionReasons = riskData.rejection_reasons || [];
  const riskFactors = riskData.risk_factors || [];
  
  // Update risk score badge
  const riskScoreBadge = document.getElementById('riskScoreBadge');
  riskScoreBadge.textContent = `Score: ${riskScore}/10`;
  riskScoreBadge.className = `badge ${
    riskScore <= 3 ? 'bg-success' : 
    riskScore <= 6 ? 'bg-warning' : 'bg-danger'
  }`;
  
  // Update risk status display
  const riskMainStatus = document.getElementById('riskMainStatus');
  const riskSubStatus = document.getElementById('riskSubStatus');
  const riskStatus = document.getElementById('riskStatus');
  const riskIcon = riskStatus.querySelector('.risk-icon i');
  
  if (approved) {
    riskMainStatus.textContent = 'APPROVED';
    riskSubStatus.textContent = 'Trade meets risk criteria';
    riskStatus.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1))';
    riskStatus.style.border = '2px solid rgba(16, 185, 129, 0.3)';
    riskIcon.className = 'fas fa-check-circle fa-2x text-success';
  } else {
    riskMainStatus.textContent = 'REJECTED';
    riskSubStatus.textContent = rejectionReasons.length > 0 ? 
      rejectionReasons[0] : 'Trade does not meet risk criteria';
    riskStatus.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1))';
    riskStatus.style.border = '2px solid rgba(239, 68, 68, 0.3)';
    riskIcon.className = 'fas fa-times-circle fa-2x text-danger';
  }
  
  // Update risk meter
  const riskMeterFill = document.getElementById('riskMeterFill');
  riskMeterFill.style.width = `${riskScore * 10}%`;
  riskMeterFill.style.background = riskScore <= 3 ? '#10b981' : 
                                  riskScore <= 6 ? '#f59e0b' : '#ef4444';
  
  // Update risk factors
  const riskFactorsContainer = document.getElementById('riskFactors');
  riskFactorsContainer.innerHTML = '';
  
  if (riskFactors.length > 0) {
    riskFactors.forEach(factor => {
      const factorElement = document.createElement('div');
      factorElement.className = 'col-6';
      
      let statusClass = 'pending';
      let statusIcon = 'clock';
      
      if (factor.status === 'low') {
        statusClass = 'low';
        statusIcon = 'check-circle';
      } else if (factor.status === 'medium') {
        statusClass = 'medium';
        statusIcon = 'exclamation-triangle';
      } else if (factor.status === 'high') {
        statusClass = 'high';
        statusIcon = 'times-circle';
      }
      
      factorElement.innerHTML = `
        <div class="risk-factor-card ${statusClass}">
          <i class="fas fa-${statusIcon} me-2"></i>
          <div>
            <div class="risk-factor-name">${factor.name}</div>
            <div class="risk-factor-status">${factor.status.toUpperCase()}</div>
          </div>
        </div>
      `;
      riskFactorsContainer.appendChild(factorElement);
    });
  }
  
  // Update risk details
  const riskDetails = document.getElementById('riskDetails');
  const riskWarnings = document.getElementById('riskWarnings');
  const riskRejections = document.getElementById('riskRejections');
  
  if (rejectionReasons.length > 0) {
    riskDetails.style.display = 'block';
    riskWarnings.style.display = 'none';
    riskRejections.style.display = 'block';
    riskRejections.innerHTML = `<i class="fas fa-times-circle me-2"></i><span>${rejectionReasons.join(', ')}</span>`;
  } else if (riskScore > 6) {
    riskDetails.style.display = 'block';
    riskWarnings.style.display = 'block';
    riskRejections.style.display = 'none';
    riskWarnings.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i><span>High risk score detected - proceed with caution</span>`;
  } else {
    riskDetails.style.display = 'none';
  }
}

/* ===== Support & Resistance Functions ===== */
function updateSupportResistance(data) {
  const srData = data.support_resistance || {};
  const currentPrice = data.price_data?.current || 0;
  
  // Update Support & Resistance levels
  const supportLevel = srData.support || (currentPrice * 0.995).toFixed(4);
  const resistanceLevel = srData.resistance || (currentPrice * 1.005).toFixed(4);
  
  document.getElementById('supportLevel').textContent = supportLevel;
  document.getElementById('resistanceLevel').textContent = resistanceLevel;
  
  // Calculate and display distances
  if (currentPrice > 0) {
    const supportDistance = ((currentPrice - supportLevel) / currentPrice * 100).toFixed(2);
    const resistanceDistance = ((resistanceLevel - currentPrice) / currentPrice * 100).toFixed(2);
    
    document.getElementById('supportDistance').textContent = `${supportDistance}% below`;
    document.getElementById('resistanceDistance').textContent = `${resistanceDistance}% above`;
  }
}

/* ===== Chart Setup ===== */
const chart = LightweightCharts.createChart(document.getElementById('chartRoot'), {
  layout: { 
    backgroundColor: '#1e293b', 
    textColor: '#f8fafc' 
  },
  grid: {
    vertLines: { color: '#374151' },
    horzLines: { color: '#374151' }
  },
  timeScale: {
    borderColor: '#475569',
    timeVisible: true,
    secondsVisible: false
  },
  rightPriceScale: {
    borderColor: '#475569'
  },
  width: document.getElementById('chartRoot').clientWidth,
  height: 520
});

const candle = chart.addCandlestickSeries({
  upColor: '#10b981',
  downColor: '#ef4444', 
  borderVisible: true,
  wickUpColor: '#10b981',
  wickDownColor: '#ef4444'
});

const ema26 = chart.addLineSeries({
  color: '#3b82f6',
  lineWidth: 1.5,
  priceScaleId: 'right'
});

const macdChart = LightweightCharts.createChart(document.getElementById('macdRoot'), {
  layout: { 
    backgroundColor: '#1e293b', 
    textColor: '#f8fafc' 
  },
  grid: {
    vertLines: { color: '#374151' },
    horzLines: { color: '#374151' }
  },
  timeScale: {
    borderColor: '#475569',
    timeVisible: true,
    secondsVisible: false
  },
  width: document.getElementById('macdRoot').clientWidth,
  height: 160
});

const macdLine = macdChart.addLineSeries({
  color: '#3b82f6',
  lineWidth: 1
});

const macdSignal = macdChart.addLineSeries({
  color: '#f59e0b', 
  lineWidth: 1
});

const macdHist = macdChart.addHistogramSeries({
  color: '#8b5cf6',
  priceFormat: {
    type: 'volume',
  }
});

// Sync time scales between charts
chart.timeScale().subscribeVisibleTimeRangeChange((timeRange) => {
  try {
    macdChart.timeScale().setVisibleRange(timeRange);
  } catch (e) {
    console.log('Time scale sync error:', e);
  }
});

/* ===== DOM refs ===== */
const livePriceEl = document.getElementById('livePrice');
const pairSelect = document.getElementById('pairSelect');
const timeframeSelect = document.getElementById('timeframeSelect');
const aiSummaryEl = document.getElementById('aiSummary');
const aiSignal = document.getElementById('aiSignalBadge');
const aiConfidence = document.getElementById('aiConfidence');
const aiRisk = document.getElementById('aiRisk');
const aiEntry = document.getElementById('aiEntry');
const aiSL = document.getElementById('aiSL');
const aiTP1 = document.getElementById('aiTP1');
const aiTP2 = document.getElementById('aiTP2');
const fundNews = document.getElementById('fundamentalNews');
const rsiEl = document.getElementById('rsiVal');
const macdValEl = document.getElementById('macdVal');
const macdHistVal = document.getElementById('macdHistVal');
const adxEl = document.getElementById('adxVal');
const atrEl = document.getElementById('atrVal');
const volEl = document.getElementById('volVal');
const trendEl = document.getElementById('trendVal');
const changeEl = document.getElementById('pairChange');
const statusIndicator = document.getElementById('statusIndicator');
const backtestResultsEl = document.getElementById('backtestResults');
const backtestStatusEl = document.getElementById('backtestStatus');
const currentPriceEl = document.getElementById('currentPrice');
const analyzeBtn = document.getElementById('analyzeBtn');

/* ===== Data state ===== */
let auto = false, autoRefreshInterval = null, livePriceInterval = null;
let currentSignal = 'HOLD';

function setSignal(sig){
  aiSignal.textContent = sig;
  currentSignal = sig;
  aiSignal.className = sig === 'BUY' ? 'ai-signal-buy' : 
                     sig === 'SELL' ? 'ai-signal-sell' : 'ai-signal-hold';
}

// Update status indicator
function updateStatusIndicator(isLive) {
  if (isLive) {
    statusIndicator.className = 'status-indicator status-live';
    statusIndicator.title = 'Live data connection active';
  } else {
    statusIndicator.className = 'status-indicator status-offline';
    statusIndicator.title = 'No live data connection';
  }
}

// Show loading state
function setLoadingState(loading) {
  if (loading) {
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<span class="spinner"></span> Analyzing...';
    document.body.classList.add('loading');
  } else {
    analyzeBtn.disabled = false;
    analyzeBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>Analyze';
    document.body.classList.remove('loading');
  }
}

// Generate sample price data for testing
function generateSamplePriceData() {
  const data = [];
  const basePrice = 148.75;
  const now = new Date();
  
  for (let i = 100; i >= 0; i--) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    
    const open = basePrice + (Math.random() - 0.5) * 2;
    const close = open + (Math.random() - 0.5) * 1.5;
    const high = Math.max(open, close) + Math.random() * 0.8;
    const low = Math.min(open, close) - Math.random() * 0.8;
    
    data.push({
      time: fmt(date),
      open: open,
      high: high,
      low: low,
      close: close
    });
  }
  
  return data;
}

// Generate sample risk assessment data
function generateSampleRiskAssessment() {
  const riskScore = Math.floor(Math.random() * 11); // 0-10
  const approved = riskScore <= 7;
  
  const riskFactors = [
    { name: 'Market Volatility', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' },
    { name: 'Position Size', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' },
    { name: 'Correlation', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' },
    { name: 'Daily Limits', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' }
  ];
  
  const rejectionReasons = approved ? [] : [
    'Position size exceeds daily limit',
    'High correlation with existing positions',
    'Market volatility too high'
  ].slice(0, Math.floor(Math.random() * 2) + 1);
  
  return {
    risk_score: riskScore,
    approved: approved,
    rejection_reasons: rejectionReasons,
    risk_factors: riskFactors
  };
}

// Generate sample support resistance data
function generateSampleSupportResistance(currentPrice) {
  const support = (currentPrice * (1 - (Math.random() * 0.02 + 0.005))).toFixed(4);
  const resistance = (currentPrice * (1 + (Math.random() * 0.02 + 0.005))).toFixed(4);
  
  return {
    support: support,
    resistance: resistance
  };
}

/* ===== Fetch + Render ===== */
async function analyze(){
  const pair = pairSelect.value, tf = timeframeSelect.value;
  
  setLoadingState(true);
  aiSummaryEl.textContent = 'Analyzing market data...';
  aiSummaryEl.style.color = '';
  
  try {
    console.log(`Fetching analysis for ${pair}-${tf}...`);
    
    // Gunakan endpoint yang sesuai dengan backend Flask
    const response = await fetch(`${API_BASE_URL}/api/analyze?pair=${pair}&timeframe=${tf}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Analysis response:', data);
    
    // Update price series chart
    let chartData = [];
    
    if (data.price_series && data.price_series.length > 0) {
      console.log(`Processing ${data.price_series.length} price series data points`);
      chartData = data.price_series.map(p => ({
        time: fmt(p.date || p.time),
        open: parseFloat(p.open) || 0,
        high: parseFloat(p.high) || 0,
        low: parseFloat(p.low) || 0,
        close: parseFloat(p.close) || 0
      }));
    } else {
      console.warn('No price_series data, using sample data');
      chartData = generateSamplePriceData();
    }
    
    // Clean and set chart data
    const cleanData = cleanChartData(chartData);
    currentChartData = cleanData;
    
    if (cleanData.length > 0) {
      candle.setData(cleanData);
      
      const closes = cleanData.map(d => d.close);
      
      // Calculate and update EMA
      const ema = calcEMA(closes, 26);
      currentEmaData = ema.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      ema26.setData(currentEmaData);
      
      // Calculate and update MACD
      const {macd, sig, hist} = calcMACDSeries(closes);
      currentMacdData = { 
        macd: macd.map(v => isNaN(v) ? 0 : v),
        signal: sig.map(v => isNaN(v) ? 0 : v),
        hist: hist.map(v => isNaN(v) ? 0 : v)
      };
      
      const macdSeriesData = macd.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      const signalSeriesData = sig.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      const histSeriesData = hist.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      
      macdLine.setData(macdSeriesData);
      macdSignal.setData(signalSeriesData);
      macdHist.setData(histSeriesData);
      
      lastCandleTime = cleanData[cleanData.length - 1]?.time;
      
      // Resize charts
      setTimeout(() => {
        try {
          chart.resize(document.getElementById('chartRoot').clientWidth, 520);
          macdChart.resize(document.getElementById('macdRoot').clientWidth, 160);
        } catch (e) {
          console.log('Chart resize error:', e);
        }
      }, 100);
    }
    
    // Update technical values
    const technical = data.technical_analysis || {};
    console.log('Technical analysis:', technical);
    
    // Handle momentum indicators
    if (technical.momentum) {
      rsiEl.textContent = (technical.momentum.rsi || 0).toFixed(2);
      macdValEl.textContent = (technical.momentum.macd || 0).toFixed(4);
      macdHistVal.textContent = (technical.momentum.macd_histogram || 0).toFixed(4);
    } else {
      rsiEl.textContent = '-';
      macdValEl.textContent = '-';
      macdHistVal.textContent = '-';
    }
    
    // Handle trend indicators
    if (technical.trend) {
      adxEl.textContent = (technical.trend.adx || 0).toFixed(2);
      trendEl.textContent = technical.trend.trend_direction || '-';
    } else {
      adxEl.textContent = '-';
      trendEl.textContent = '-';
    }
    
    // Handle volatility indicators
    if (technical.volatility) {
      atrEl.textContent = (technical.volatility.atr || 0).toFixed(4);
      volEl.textContent = technical.volatility.volatility_pct ? 
        (technical.volatility.volatility_pct * 100).toFixed(2) + '%' : '-';
    } else {
      atrEl.textContent = '-';
      volEl.textContent = '-';
    }
    
    // Update price data
    const priceData = data.price_data || {};
    const currentPrice = priceData.current || (technical.levels && technical.levels.current_price);
    livePriceEl.textContent = currentPrice ? currentPrice.toFixed(4) : '-';
    currentPriceEl.textContent = currentPrice ? currentPrice.toFixed(4) : '-';
    
    // Update pair ticker with change
    const change = priceData.change_pct || 0;
    changeEl.textContent = '(' + (change >= 0 ? '+' : '') + change.toFixed(2) + '%)';
    changeEl.className = change >= 0 ? 'price-change change-positive' : 'price-change change-negative';
    
    // Update AI analysis
    const ai = data.ai_analysis || {};
    console.log('AI analysis:', ai);
    
    aiSummaryEl.textContent = ai.analysis_summary || 'Analysis completed';
    setSignal(ai.signal || 'HOLD');
    aiConfidence.textContent = ai.confidence ? ai.confidence + '%' : '-';
    aiRisk.textContent = ai.risk_level || '-';
    aiEntry.textContent = ai.entry_price || '-';
    aiSL.textContent = ai.stop_loss || '-';
    aiTP1.textContent = ai.take_profit_1 || '-';
    aiTP2.textContent = ai.take_profit_2 || '-';
    
    // Update fundamental news
    fundNews.textContent = data.fundamental_analysis || 'Market conditions stable';
    
    // Update risk assessment with new function
    const risk = data.risk_assessment || generateSampleRiskAssessment();
    updateRiskAssessment(risk);
    
    // Update Support & Resistance
    const srData = {
      support_resistance: data.support_resistance || generateSampleSupportResistance(currentPrice),
      price_data: data.price_data || { current: currentPrice },
      price_series: data.price_series || []
    };
    updateSupportResistance(srData);
    
    updateStatusIndicator(true);
    
  } catch (error) {
    console.error('Analysis error:', error);
    updateStatusIndicator(false);
    
    // Show error to user
    aiSummaryEl.textContent = `Error: ${error.message}`;
    aiSummaryEl.style.color = '#ef4444';
    
    // Fallback to sample data for demonstration
    console.log('Using fallback sample data...');
    const currentPrice = 148.75;
    livePriceEl.textContent = currentPrice.toFixed(4);
    currentPriceEl.textContent = currentPrice.toFixed(4);
    
    // Generate sample chart data
    const sampleData = generateSamplePriceData();
    candle.setData(sampleData);
    
    // Update with sample technical data
    rsiEl.textContent = '52.34';
    macdValEl.textContent = '0.0023';
    macdHistVal.textContent = '0.0008';
    adxEl.textContent = '28.45';
    atrEl.textContent = '0.0087';
    volEl.textContent = '0.85%';
    trendEl.textContent = 'BULLISH';
    
    setSignal('BUY');
    aiConfidence.textContent = '76%';
    aiRisk.textContent = 'MEDIUM';
    
    fundNews.textContent = 'USD strengthens against JPY on positive economic data';
  } finally {
    setLoadingState(false);
  }
}

/* ===== Live Price Update ===== */
let prevPrice = null;
async function updateLivePrice() {
  const pair = pairSelect.value;
  try {
    // Use the analyze endpoint to get updated price data
    const response = await fetch(`${API_BASE_URL}/api/analyze?pair=${pair}&timeframe=${timeframeSelect.value}`);
    
    if (!response.ok) return;
    
    const data = await response.json();
    
    const priceData = data.price_data || {};
    const technical = data.technical_analysis || {};
    const currentPrice = priceData.current || (technical.levels && technical.levels.current_price);
    
    if (currentPrice && currentChartData.length > 0) {
      livePriceEl.textContent = currentPrice.toFixed(4);
      currentPriceEl.textContent = currentPrice.toFixed(4);
      
      // Update price change
      const change = priceData.change_pct || 0;
      changeEl.textContent = '(' + (change >= 0 ? '+' : '') + change.toFixed(2) + '%)';
      changeEl.className = change >= 0 ? 'price-change change-positive' : 'price-change change-negative';
      
      // Update current candle with live price
      const lastIndex = currentChartData.length - 1;
      const lastCandle = currentChartData[lastIndex];
      
      if (lastCandle) {
        const updatedCandle = {
          time: lastCandle.time,
          open: lastCandle.open,
          high: Math.max(lastCandle.high, currentPrice),
          low: Math.min(lastCandle.low, currentPrice),
          close: currentPrice
        };
        
        // Update our stored data
        currentChartData[lastIndex] = updatedCandle;
        
        // Update the chart
        candle.update(updatedCandle);
        
        // Update EMA with new close price
        const closes = currentChartData.map(d => d.close);
        const ema = calcEMA(closes, 26);
        const lastEma = ema[ema.length - 1];
        
        if (lastEma && !isNaN(lastEma)) {
          const updatedEma = {
            time: lastCandle.time,
            value: lastEma
          };
          currentEmaData[lastIndex] = updatedEma;
          ema26.update(updatedEma);
        }
        
        // Update MACD with new close price
        const {macd, sig, hist} = calcMACDSeries(closes);
        const lastMacd = macd[macd.length - 1];
        const lastSig = sig[sig.length - 1];
        const lastHist = hist[hist.length - 1];
        
        if (lastMacd !== undefined && !isNaN(lastMacd)) {
          currentMacdData.macd[lastIndex] = lastMacd;
          currentMacdData.signal[lastIndex] = lastSig;
          currentMacdData.hist[lastIndex] = lastHist;
          
          macdLine.update({time: lastCandle.time, value: lastMacd});
          macdSignal.update({time: lastCandle.time, value: lastSig});
          macdHist.update({time: lastCandle.time, value: lastHist});
          
          macdValEl.textContent = lastMacd.toFixed(4);
          macdHistVal.textContent = lastHist.toFixed(4);
        }
      }
      
      updateStatusIndicator(true);
    }
  } catch (error) {
    console.error('Live price error:', error);
    updateStatusIndicator(false);
  }
}

/* ===== Backtest Functions ===== */
function showBacktestModal() {
  const modal = new bootstrap.Modal(document.getElementById('backtestModal'));
  modal.show();
}

async function runBacktest() {
  const pair = pairSelect.value;
  const timeframe = timeframeSelect.value;
  const initialBalance = document.getElementById('initialBalance').value;
  const days = document.getElementById('backtestDays').value;
  const backtestType = document.getElementById('backtestType').value;
  
  backtestStatusEl.textContent = 'Running...';
  backtestStatusEl.className = 'badge bg-warning';
  backtestResultsEl.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Running backtest...</div>';
  
  try {
    const endpoint = backtestType === 'advanced' ? '/api/advanced_backtest' : '/api/backtest';
    
    console.log('Starting backtest with:', { pair, timeframe, days, initialBalance, backtestType });
    
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        pair: pair,
        timeframe: timeframe,
        days: parseInt(days),
        initial_balance: parseFloat(initialBalance)
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('Backtest result:', result);
    
    if (result.status === 'success' || result.status === 'no_trades') {
      displayBacktestResults(result);
      backtestStatusEl.textContent = 'Completed';
      backtestStatusEl.className = 'badge bg-success';
    } else {
      throw new Error(result.error || 'Backtest failed');
    }
    
  } catch (error) {
    console.error('Backtest error:', error);
    backtestResultsEl.innerHTML = `<div class="alert alert-danger">Backtest failed: ${error.message}</div>`;
    backtestStatusEl.textContent = 'Failed';
    backtestStatusEl.className = 'badge bg-danger';
  }
}

function displayBacktestResults(result) {
  const summary = result.summary || {};
  const tradeAnalysis = result.trade_analysis || {};
  
  let html = '';
  
  if (result.status === 'no_trades') {
    html = `<div class="alert alert-warning">No trades were executed during the backtest period.</div>`;
    backtestResultsEl.innerHTML = html;
    return;
  }
  
  // Performance Grade
  const grade = result.performance_grade || 'N/A';
  const gradeClass = grade.startsWith('A') ? 'grade-a' : 
                    grade.startsWith('B') ? 'grade-b' :
                    grade.startsWith('C') ? 'grade-c' : 'grade-d';
  
  html += `<div class="performance-grade ${gradeClass}">Performance: ${grade}</div>`;
  
  // Summary Metrics
  html += `
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Total Trades</div>
          <div class="metric-value">${summary.total_trades || 0}</div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Win Rate</div>
          <div class="metric-value ${(summary.win_rate || 0) >= 50 ? 'change-positive' : 'change-negative'}">
            ${(summary.win_rate || 0).toFixed(1)}%
          </div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Total Profit</div>
          <div class="metric-value ${(summary.total_profit || 0) >= 0 ? 'change-positive' : 'change-negative'}">
            $${(summary.total_profit || 0).toFixed(2)}
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Final Balance</div>
          <div class="metric-value">$${(summary.final_balance || 0).toFixed(2)}</div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Return %</div>
          <div class="metric-value ${(summary.return_percentage || 0) >= 0 ? 'change-positive' : 'change-negative'}">
            ${(summary.return_percentage || 0).toFixed(2)}%
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Max Drawdown</div>
          <div class="metric-value change-negative">${(summary.max_drawdown || 0).toFixed(2)}%</div>
        </div>
      </div>
    </div>
  `;
  
  // Trade Analysis
  if (tradeAnalysis.long_trades || tradeAnalysis.short_trades) {
    html += `
      <div class="mt-3">
        <div class="small-muted mb-1">Trade Analysis</div>
        <div class="small-muted">Long Trades: ${tradeAnalysis.long_trades || 0} (Win Rate: ${(tradeAnalysis.long_win_rate || 0).toFixed(1)}%)</div>
        <div class="small-muted">Short Trades: ${tradeAnalysis.short_trades || 0} (Win Rate: ${(tradeAnalysis.short_win_rate || 0).toFixed(1)}%)</div>
      </div>
    `;
  }
  
  backtestResultsEl.innerHTML = html;
}

/* ===== Event Listeners ===== */
document.getElementById('analyzeBtn').addEventListener('click', analyze);
document.getElementById('runBacktestBtn').addEventListener('click', showBacktestModal);
document.getElementById('startBacktestBtn').addEventListener('click', runBacktest);

pairSelect.addEventListener('change', analyze);
timeframeSelect.addEventListener('change', analyze);

// Initialize dashboard
analyze();

// Start live price updates every 5 seconds for responsive UI
setInterval(updateLivePrice, 5000);

// Handle window resize
window.addEventListener('resize', () => {
  try {
    chart.resize(document.getElementById('chartRoot').clientWidth, 520);
    macdChart.resize(document.getElementById('macdRoot').clientWidth, 160);
  } catch (e) {
    console.log('Resize error:', e);
  }
});
</script>
</body>
</html>
