<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Forex Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background:#0d1117; color:#e6edf3; margin:0; }
    header { padding:15px; background:#161b22; text-align:center; font-size:22px; }
    .container { padding:20px; display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .card { background:#161b22; padding:15px; border-radius:10px; }
    h3 { margin-top:0; }
    canvas { background:#0d1117; border-radius:8px; }
    .ai-buy{color:#2ecc71;font-weight:bold}
    .ai-sell{color:#e74c3c;font-weight:bold}
    .ai-hold{color:#f1c40f;font-weight:bold}
    footer { text-align:center; padding:10px; font-size:13px; background:#161b22; }
    select,button,input{padding:5px;margin:5px;background:#21262d;color:#e6edf3;border:1px solid #30363d;border-radius:5px}
  </style>
</head>
<body>
<header>üìä Forex Dashboard (Dark Mode)</header>
<div class="container">
  <div class="card" style="grid-column:span 2;">
    <label>Pair:</label><select id="pair"></select>
    <label>Timeframe:</label><select id="timeframe"></select>
    <label><input type="checkbox" id="useHistory"> Use Historical Data</label>
    <button onclick="analyze()">Analyze</button>
  </div>
  
  <div class="card" style="grid-column:span 2;">
    <canvas id="priceChart" height="120"></canvas>
  </div>
  
  <div class="card">
    <h3>ü§ñ AI Analysis</h3>
    <p>Signal: <span id="ai_signal"></span></p>
    <p>Entry: <span id="ai_entry"></span></p>
    <p>Stop Loss: <span id="ai_sl"></span></p>
    <p>TP1: <span id="ai_tp1"></span> | TP2: <span id="ai_tp2"></span></p>
    <p>Confidence: <span id="ai_conf"></span></p>
    <p id="ai_advice"></p>
  </div>
  
  <div class="card">
    <h3>üìà Indicators</h3>
    <p>RSI: <span id="ind_rsi"></span></p>
    <p>MACD: <span id="ind_macd"></span> | Signal: <span id="ind_macdsig"></span></p>
    <p>SMA20: <span id="ind_sma20"></span> | SMA50: <span id="ind_sma50"></span></p>
    <p>EMA200: <span id="ind_ema200"></span></p>
    <p>OBV: <span id="ind_obv"></span></p>
    <p>Support: <span id="ind_support"></span> | Resistance: <span id="ind_resistance"></span></p>
  </div>
  
  <div class="card">
    <h3>üì∞ News</h3>
    <p id="fundamental_news"></p>
  </div>
  
  <div class="card" style="grid-column:span 2;">
    <h3>üåç Quick Overview</h3>
    <div id="quick_overview"></div>
  </div>
</div>
<footer>Data: TwelveData + Historical CSV + DeepSeek + AlphaVantage</footer>

<script>
let chart;
async function loadPairs(){
  const r=await fetch("/get_pairs");const data=await r.json();
  const pairSel=document.getElementById("pair");
  pairSel.innerHTML="";
  for(const p of Object.keys(data)){ 
    const opt=document.createElement("option"); opt.value=p; opt.text=p; pairSel.appendChild(opt);
  }
  pairSel.onchange=()=>{ 
    const tfSel=document.getElementById("timeframe"); tfSel.innerHTML="";
    const tfs=data[pairSel.value]; for(const tf of tfs){ 
      const o=document.createElement("option"); o.value=tf; o.text=tf; tfSel.appendChild(o);
    }
  }
  pairSel.onchange(); // trigger initial
}
async function analyze(){
  const pair=document.getElementById("pair").value;
  const tf=document.getElementById("timeframe").value;
  const useHist=document.getElementById("useHistory").checked?"1":"0";
  const r=await fetch(`/get_analysis?pair=${pair}&timeframe=${tf}&use_history=${useHist}`);
  const data=await r.json(); if(data.error){alert(data.error);return;}
  
  const sig=data.ai_analysis.SIGNAL;
  const sigClass=sig==="BUY"?"ai-buy":sig==="SELL"?"ai-sell":"ai-hold";
  document.getElementById("ai_signal").innerHTML=`<span class="${sigClass}">${sig}</span>`;
  document.getElementById("ai_entry").innerText=data.ai_analysis.ENTRY_PRICE;
  document.getElementById("ai_sl").innerText=data.ai_analysis.STOP_LOSS;
  document.getElementById("ai_tp1").innerText=data.ai_analysis.TAKE_PROFIT_1;
  document.getElementById("ai_tp2").innerText=data.ai_analysis.TAKE_PROFIT_2;
  document.getElementById("ai_conf").innerText=data.ai_analysis.CONFIDENCE_LEVEL+"%";
  document.getElementById("ai_advice").innerText=data.ai_analysis.TRADING_ADVICE;
  
  const ind=data.technical_indicators;
  document.getElementById("ind_rsi").innerText=ind.RSI;
  document.getElementById("ind_macd").innerText=ind.MACD;
  document.getElementById("ind_macdsig").innerText=ind.MACD_SIGNAL;
  document.getElementById("ind_sma20").innerText=ind.SMA20;
  document.getElementById("ind_sma50").innerText=ind.SMA50;
  document.getElementById("ind_ema200").innerText=ind.EMA200;
  document.getElementById("ind_obv").innerText=ind.OBV;
  document.getElementById("ind_support").innerText=ind.Support;
  document.getElementById("ind_resistance").innerText=ind.Resistance;
  document.getElementById("fundamental_news").innerText=data.fundamental_news;
  
  const ctx=document.getElementById("priceChart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{labels:data.chart_data.dates,datasets:[
      {label:pair+" Close",data:data.chart_data.close,borderColor:"#58a6ff",fill:false,tension:0.25},
      {label:"EMA20",data:movingAverage(data.chart_data.close,20),borderColor:"#2ecc71",fill:false,tension:0.25},
      {label:"EMA200",data:movingAverage(data.chart_data.close,200),borderColor:"#e74c3c",fill:false,tension:0.25}
    ]},
    options:{responsive:true,plugins:{legend:{labels:{color:"#e6edf3"}}},
      scales:{x:{ticks:{color:"#9da7b3"},grid:{color:"#21262d"}},
              y:{ticks:{color:"#9da7b3"},grid:{color:"#21262d"}}}}
  });
}
function movingAverage(vals,period){let k=2/(period+1),ema=[],prev=vals[0];vals.forEach((v,i)=>{prev=i===0?v:v*k+prev*(1-k);ema.push(prev);});return ema;}
async function quickOverview(){const r=await fetch("/quick_overview");const data=await r.json();let h="<table>";for(const [p,v] of Object.entries(data)){h+=`<tr><td><b>${p}</b></td><td>${v.price}</td></tr>`;}h+="</table>";document.getElementById("quick_overview").innerHTML=h;}
loadPairs(); quickOverview();
</script>
</body>
</html>
