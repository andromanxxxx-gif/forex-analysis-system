<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>AI Forex Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#0f172a;color:#e2e8f0;margin:0;}
    header{background:#1e293b;padding:15px;text-align:center;font-size:20px;font-weight:bold;color:#38bdf8;}
    .container{max-width:1300px;margin:20px auto;padding:0 20px;}
    .controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
    select,button,input[type="checkbox"]{padding:8px 12px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#e2e8f0;}
    button{cursor:pointer;font-weight:bold;}
    button.primary{background:linear-gradient(90deg,#38bdf8,#34d399);color:#022140;border:none;}
    .card{background:#1e293b;border-radius:10px;padding:15px;margin-bottom:20px;}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}}
    .big-price{font-size:28px;font-weight:bold;margin-top:10px;}
    .badge{display:inline-block;padding:6px 12px;border-radius:20px;font-weight:bold;}
    .buy{background:#10b981;color:#022c22;}
    .sell{background:#ef4444;color:#fff;}
    .hold{background:#475569;color:#fff;}
    .indicators{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    .ind-item{background:#334155;padding:8px;border-radius:6px;text-align:center;}
    .quick-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;}
    .quick-card{background:#334155;border-radius:8px;padding:10px;text-align:center;}
    .chart-wrapper{position:relative;height:180px;max-height:180px;}
    footer{text-align:center;padding:15px;background:#1e293b;color:#94a3b8;font-size:14px;}
    .advice-normal{color:#94a3b8;}
    .advice-error{color:#ef4444;font-weight:bold;}
    #fundamentalNews{margin-top:12px;font-size:13px;color:#cbd5e1;background:#334155;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <header>ðŸ“Š AI Forex Dashboard</header>
  <div class="container">

    <div class="quick-grid" id="quickOverview"></div>

    <div class="controls">
      <select id="pairSelect"><option>USDJPY</option><option>GBPJPY</option><option>EURJPY</option><option>CHFJPY</option></select>
      <select id="timeframeSelect"><option>1H</option><option>4H</option><option>1D</option></select>
      <label><input type="checkbox" id="useHistory"> Use Historical Data</label>
      <button class="primary" onclick="getAnalysis()">Analyze</button>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div id="pairTitle" style="font-weight:bold">-</div>
              <div id="dataSource" style="font-size:13px;color:#94a3b8">-</div>
            </div>
            <div style="text-align:right">
              <div id="currentPrice" class="big-price">-</div>
              <div id="signalBadge" class="badge hold">-</div>
            </div>
          </div>
        </div>

        <div class="card chart-card">
          <h3>Price Chart</h3>
          <div class="chart-wrapper">
            <canvas id="priceChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>Technical Indicators</h3>
          <div class="indicators" id="technicalIndicators"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Trading Recommendations (AI)</h3>
          <div><b>Signal:</b> <span id="signalType">-</span></div>
          <div><b>Entry:</b> <span id="entryPrice">-</span></div>
          <div><b>Stop Loss:</b> <span id="stopLoss">-</span></div>
          <div><b>Take Profit 1:</b> <span id="takeProfit1">-</span></div>
          <div><b>Take Profit 2:</b> <span id="takeProfit2">-</span></div>
          <div><b>Confidence:</b> <span id="confidenceText">-</span></div>
          <p id="tradingAdvice" class="advice-normal" style="margin-top:10px;font-size:14px">-</p>
          <div id="fundamentalNews">-</div>
        </div>
      </div>
    </div>
  </div>

  <footer>Data source: Twelve Data + Alpha Vantage + DeepSeek AI</footer>

  <script>
    let priceChart;

    async function getQuickOverview(){
      const res=await fetch("/quick_overview"); const data=await res.json();
      const container=document.getElementById("quickOverview");
      container.innerHTML="";
      for(const [pair,info] of Object.entries(data)){
        const div=document.createElement("div");
        div.className="quick-card";
        div.innerHTML=`<div style="font-weight:bold">${pair}</div><div>${info.price.toFixed(3)}</div>`;
        container.appendChild(div);
      }
    }

    async function getAnalysis(){
      const pair=document.getElementById("pairSelect").value;
      const tf=document.getElementById("timeframeSelect").value;
      const useHist=document.getElementById("useHistory").checked;
      let url=`/get_analysis?pair=${pair}&timeframe=${tf}`;
      if(useHist) url+="&use_history=1";
      try{
        const res=await fetch(url); const data=await res.json();
        if(data.error){alert(data.error);return;}
        updateUI(data);
      }catch(e){alert("Error: "+e.message);}
    }

    function updateUI(data){
      document.getElementById("pairTitle").textContent=`${data.pair} â€” ${data.timeframe}`;
      document.getElementById("dataSource").textContent="Data source: "+data.data_source;
      document.getElementById("currentPrice").textContent=data.current_price;

      const ai=data.ai_analysis;
      const sig=ai.SIGNAL;
      const badge=document.getElementById("signalBadge");
      badge.textContent=sig;
      badge.className="badge "+(sig==="BUY"?"buy":sig==="SELL"?"sell":"hold");

      document.getElementById("signalType").textContent=sig;
      document.getElementById("entryPrice").textContent=ai.ENTRY_PRICE;
      document.getElementById("stopLoss").textContent=ai.STOP_LOSS;
      document.getElementById("takeProfit1").textContent=ai.TAKE_PROFIT_1;
      document.getElementById("takeProfit2").textContent=ai.TAKE_PROFIT_2;
      document.getElementById("confidenceText").textContent=ai.CONFIDENCE_LEVEL+"%";

      const
