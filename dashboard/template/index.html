<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forex Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0; padding: 0;
    }
    header {
      background: #273c75;
      color: white;
      padding: 15px;
      text-align: center;
    }
    main {
      display: flex;
      gap: 20px;
      padding: 20px;
    }
    .left, .right {
      flex: 1;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1em;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    .chart-container {
      height: 300px;
    }
    .analysis-table {
      width: 100%;
      border-collapse: collapse;
    }
    .analysis-table td {
      padding: 6px 10px;
      border-bottom: 1px solid #eee;
    }
    .signal-buy { color: green; font-weight: bold; }
    .signal-sell { color: red; font-weight: bold; }
    .signal-hold { color: orange; font-weight: bold; }
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .overview-item {
      background: #f1f2f6;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }
    select, button {
      padding: 6px 10px;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä Forex Dashboard</h1>
  </header>

  <main>
    <!-- LEFT SIDE -->
    <div class="left">
      <div class="card">
        <h2>Settings</h2>
        <label>Pair:
          <select id="pair">
            <option value="USDJPY">USDJPY</option>
            <option value="EURJPY">EURJPY</option>
            <option value="GBPJPY">GBPJPY</option>
            <option value="CHFJPY">CHFJPY</option>
          </select>
        </label>
        <br>
        <label>Timeframe:
          <select id="timeframe">
            <option value="1H">1H</option>
            <option value="4H">4H</option>
            <option value="1D">1D</option>
          </select>
        </label>
        <br>
        <label><input type="checkbox" id="use_history"> Use Historical Data</label>
        <br>
        <button onclick="loadAnalysis()">üîç Analyze</button>
      </div>

      <div class="card">
        <h2>Chart</h2>
        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="right">
      <div class="card">
        <h2>AI Analysis</h2>
        <table class="analysis-table" id="aiAnalysis"></table>
      </div>

      <div class="card">
        <h2>Fundamental News</h2>
        <div id="news">Loading...</div>
      </div>

      <div class="card">
        <h2>Quick Overview</h2>
        <div class="overview-grid" id="overview"></div>
      </div>
    </div>
  </main>

  <script>
    let chart;

    async function loadAnalysis() {
      const pair = document.getElementById("pair").value;
      const timeframe = document.getElementById("timeframe").value;
      const useHistory = document.getElementById("use_history").checked ? "1" : "0";

      try {
        const res = await fetch(`/get_analysis?pair=${pair}&timeframe=${timeframe}&use_history=${useHistory}`);
        const data = await res.json();
        if (data.error) {
          alert("Error: " + data.error);
          return;
        }

        // === Update Chart ===
        const ctx = document.getElementById("chart").getContext("2d");
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.chart_data.dates,
            datasets: [{
              label: pair,
              data: data.chart_data.close,
              borderColor: "#273c75",
              backgroundColor: "rgba(39,60,117,0.2)",
              fill: true,
              tension: 0.2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { display: false } }
          }
        });

        // === Update AI Analysis ===
        const ai = data.ai_analysis;
        const table = document.getElementById("aiAnalysis");
        let signalClass = "signal-hold";
        if (ai.SIGNAL === "BUY") signalClass = "signal-buy";
        else if (ai.SIGNAL === "SELL") signalClass = "signal-sell";

        table.innerHTML = `
          <tr><td>Signal</td><td class="${signalClass}">${ai.SIGNAL}</td></tr>
          <tr><td>Entry</td><td>${ai.ENTRY_PRICE}</td></tr>
          <tr><td>Stop Loss</td><td>${ai.STOP_LOSS}</td></tr>
          <tr><td>Take Profit 1</td><td>${ai.TAKE_PROFIT_1}</td></tr>
          <tr><td>Take Profit 2</td><td>${ai.TAKE_PROFIT_2}</td></tr>
          <tr><td>Confidence</td><td>${ai.CONFIDENCE_LEVEL}%</td></tr>
          <tr><td colspan="2"><em>${ai.TRADING_ADVICE}</em></td></tr>
        `;

        // === Update News ===
        document.getElementById("news").innerText = data.fundamental_news;

      } catch (err) {
        alert("Failed to fetch data: " + err);
      }
    }

    async function loadOverview() {
      try {
        const res = await fetch("/quick_overview");
        const data = await res.json();
        const container = document.getElementById("overview");
        container.innerHTML = "";
        for (const pair in data) {
          const price = data[pair].price.toFixed(4);
          container.innerHTML += `<div class="overview-item"><b>${pair}</b><br>${price}</div>`;
        }
      } catch (err) {
        console.error("Overview error:", err);
      }
    }

    loadOverview();
    setInterval(loadOverview, 10000);
  </script>
</body>
</html>
