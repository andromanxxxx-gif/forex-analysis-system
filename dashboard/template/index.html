<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ANDRO-FX Precision Forex Trading</title>

  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FIX: Load Lightweight Charts properly -->
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      --deepseek-primary: #0066cc;
      --deepseek-secondary: #00aaff;
      --deepseek-accent: #004499;
      --signal-buy: #10b981;
      --signal-sell: #ef4444;
      --signal-hold: #f59e0b;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --bg-primary: #f8fafc;
      --bg-card: #ffffff;
      --border-radius: 12px;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: "Inter", "Segoe UI", sans-serif;
      padding: 18px;
      margin: 0;
    }

    .topbar {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 15px 20px;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--deepseek-primary);
    }

    .brand-logo i {
      color: var(--deepseek-secondary);
    }

    .card-soft {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--deepseek-primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--deepseek-secondary);
    }

    #chartRoot, #macdRoot {
      width: 100%;
      background: var(--bg-card);
      border-radius: 8px;
    }
    
    #chartRoot { 
      height: 400px; 
    }
    
    #macdRoot { 
      height: 150px; 
      margin-top: 10px;
    }

    .muted { 
      color: var(--text-secondary); 
      font-size: 0.95rem; 
    }

    .ai-signal-buy, .ai-signal-sell, .ai-signal-hold {
      color: white; 
      padding: 12px 16px; 
      border-radius: 8px; 
      font-weight: 700;
      font-size: 1.2rem;
      text-align: center;
      margin: 10px 0;
    }

    .ai-signal-buy { 
      background: var(--signal-buy);
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
    }

    .ai-signal-sell { 
      background: var(--signal-sell);
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
    }

    .ai-signal-hold { 
      background: var(--signal-hold);
      box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
    }

    .price-ticker {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--deepseek-primary);
    }

    .price-change {
      font-size: 1rem;
      font-weight: 600;
    }

    .change-positive { color: var(--signal-buy); }
    .change-negative { color: var(--signal-sell); }

    .metric-card {
      background: var(--bg-primary);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid var(--deepseek-secondary);
    }

    .metric-value {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .tech-indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .indicator-value {
      font-weight: 700;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>

<!-- Simple Loading Screen -->
<div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column;">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 class="text-primary">ANDRO-FX Trading System</h4>
    <p class="text-muted">Initializing trading dashboard...</p>
    <div id="loadStatus" class="small text-muted mt-2">Loading libraries...</div>
  </div>
</div>

<div class="topbar">
  <div class="brand-logo">
    <i class="fas fa-brain"></i>
    <span>ANDRO-FX Precision Forex Trading</span>
  </div>
  
  <div class="d-flex flex-wrap gap-3 align-items-center ms-auto">
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Pair</label>
      <select id="pairSelect" class="form-select form-select-sm" style="width:130px;">
        <option>USDJPY</option>
        <option>EURJPY</option>
        <option>GBPJPY</option>
        <option>GBPUSD</option>
      </select>
    </div>
    
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Timeframe</label>
      <select id="timeframeSelect" class="form-select form-select-sm" style="width:100px;">
        <option value="1D">1D</option>
        <option value="4H">4H</option>
        <option value="1H">1H</option>
      </select>
    </div>
    
    <button id="analyzeBtn" class="btn btn-primary">
      <i class="fas fa-chart-line me-2"></i>Analyze
    </button>
    
    <div class="d-flex align-items-center ms-3">
      <span class="price-ticker me-2" id="currentPair">USDJPY â€“</span>
      <span id="livePrice" class="price-ticker">0.0000</span>
      <span id="pairChange" class="price-change ms-2">(0.00%)</span>
      <span id="statusIndicator" class="badge bg-secondary ms-2">Offline</span>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-chart-candlestick"></i>
        <span>Live Price Chart</span>
      </div>
      <div id="chartRoot">
        <div class="loading">
          <i class="fas fa-chart-line fa-2x mb-3"></i>
          <div>Loading chart data...</div>
        </div>
      </div>
      <div id="macdRoot">
        <div class="loading">
          <div>Loading MACD indicator...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-robot"></i>
        <span>AI Trading Signal</span>
      </div>
      
      <div id="aiSummary" class="muted mb-3">Initializing analysis system...</div>
      
      <div class="mb-3">
        <div class="small-muted mb-2">TRADING SIGNAL</div>
        <div id="aiSignalBadge" class="ai-signal-hold">LOADING</div>
      </div>
      
      <div class="row mb-3">
        <div class="col-6">
          <div class="metric-card">
            <div class="small-muted">Confidence</div>
            <div class="metric-value" id="aiConfidence">-</div>
          </div>
        </div>
        <div class="col-6">
          <div class="metric-card">
            <div class="small-muted">Risk Level</div>
            <div class="metric-value" id="aiRisk">-</div>
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <div class="small-muted mb-2">TRADING LEVELS</div>
        <div class="d-flex justify-content-between mb-2">
          <span class="muted">Entry:</span>
          <span id="aiEntry" class="fw-bold">-</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="muted">Stop Loss:</span>
          <span id="aiSL" class="fw-bold text-danger">-</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="muted">Take Profit:</span>
          <span id="aiTP1" class="fw-bold text-success">-</span>
        </div>
      </div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-shield-alt"></i>
        <span>Risk Management</span>
      </div>
      
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="small-muted">RISK SCORE</span>
          <span id="riskScore" class="badge bg-secondary">-/10</span>
        </div>
        <div class="progress mb-3" style="height: 8px;">
          <div id="riskProgress" class="progress-bar" style="width: 0%"></div>
        </div>
      </div>
      
      <div id="riskStatus" class="muted">Assessing risk parameters...</div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-chart-bar"></i>
        <span>Technical Analysis</span>
      </div>
      
      <div id="techIndicators">
        <div class="tech-indicator">
          <span class="muted">RSI</span>
          <span class="indicator-value" id="rsiVal">-</span>
        </div>
        <div class="tech-indicator">
          <span class="muted">MACD</span>
          <span class="indicator-value" id="macdVal">-</span>
        </div>
        <div class="tech-indicator">
          <span class="muted">ADX</span>
          <span class="indicator-value" id="adxVal">-</span>
        </div>
        <div class="tech-indicator">
          <span class="muted">Trend</span>
          <span class="indicator-value" id="trendVal">-</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Enhanced initialization with proper library checking
console.log('Starting ANDRO-FX Frontend...');

// Update loading status
function updateLoadStatus(message) {
  const statusElement = document.getElementById('loadStatus');
  if (statusElement) {
    statusElement.textContent = message;
  }
  console.log('Load Status:', message);
}

// Check if Lightweight Charts is available
function checkLightweightCharts() {
  if (typeof LightweightCharts === 'undefined') {
    console.error('Lightweight Charts is not available');
    updateLoadStatus('Chart library failed to load - using fallback');
    return false;
  }
  console.log('Lightweight Charts is available');
  return true;
}

// Hide loading screen when everything is ready
function hideLoadingScreen() {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'none';
    console.log('Loading screen hidden');
  }
}

// Global error handler
window.addEventListener('error', function(e) {
  console.error('Global error:', e.error);
  updateLoadStatus('Error: ' + e.error.message);
});

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM fully loaded');
  updateLoadStatus('DOM ready - initializing application...');
  
  // Check for required libraries
  const librariesReady = checkLightweightCharts();
  
  if (librariesReady) {
    initializeApp();
  } else {
    // Try to initialize anyway with fallback
    setTimeout(initializeApp, 1000);
  }
});

async function initializeApp() {
  console.log('Initializing application...');
  updateLoadStatus('Initializing trading dashboard...');
  
  try {
    // Initialize basic UI first
    await initializeBasicUI();
    
    // Initialize charts if library is available
    if (typeof LightweightCharts !== 'undefined') {
      await initializeCharts();
    } else {
      console.warn('Lightweight Charts not available, using simple display');
      showChartFallback();
    }
    
    // Perform initial analysis
    await analyze();
    
    console.log('Application initialized successfully');
    updateLoadStatus('Dashboard ready!');
    
    // Hide loading screen after everything is set up
    setTimeout(hideLoadingScreen, 500);
    
  } catch (error) {
    console.error('Failed to initialize app:', error);
    updateLoadStatus('Initialization failed: ' + error.message);
    showError('Initialization failed: ' + error.message);
    // Still hide loading screen to show error state
    setTimeout(hideLoadingScreen, 1000);
  }
}

async function initializeBasicUI() {
  console.log('Initializing basic UI...');
  
  // Set up event listeners
  document.getElementById('analyzeBtn').addEventListener('click', analyze);
  document.getElementById('pairSelect').addEventListener('change', function() {
    document.getElementById('currentPair').textContent = this.value + ' â€“';
    analyze();
  });
  document.getElementById('timeframeSelect').addEventListener('change', analyze);
  
  console.log('Basic UI initialized');
}

async function initializeCharts() {
  console.log('Initializing charts...');
  updateLoadStatus('Initializing charts...');
  
  try {
    const chartRoot = document.getElementById('chartRoot');
    const macdRoot = document.getElementById('macdRoot');
    
    // Clear loading messages
    chartRoot.innerHTML = '';
    macdRoot.innerHTML = '';
    
    // Create main chart
    const chart = LightweightCharts.createChart(chartRoot, {
      width: chartRoot.clientWidth,
      height: 400,
      layout: {
        background: { color: '#ffffff' },
        textColor: '#374151',
      },
      grid: {
        vertLines: { color: '#f3f4f6' },
        horzLines: { color: '#f3f4f6' },
      },
      timeScale: {
        timeVisible: true,
        secondsVisible: false,
      }
    });
    
    // Create candlestick series
    const candleSeries = chart.addCandlestickSeries({
      upColor: '#10b981',
      downColor: '#ef4444',
      borderVisible: false,
      wickUpColor: '#10b981',
      wickDownColor: '#ef4444',
    });
    
    // Create MACD chart
    const macdChart = LightweightCharts.createChart(macdRoot, {
      width: macdRoot.clientWidth,
      height: 150,
      layout: {
        background: { color: '#ffffff' },
        textColor: '#374151',
      },
      grid: {
        vertLines: { color: '#f3f4f6' },
        horzLines: { color: '#f3f4f6' },
      },
    });
    
    const macdLineSeries = macdChart.addLineSeries({
      color: '#3b82f6',
      lineWidth: 1,
    });
    
    // Store chart instances globally
    window.tradingCharts = {
      mainChart: chart,
      candleSeries: candleSeries,
      macdChart: macdChart,
      macdLineSeries: macdLineSeries
    };
    
    console.log('Charts initialized successfully');
    
  } catch (error) {
    console.error('Chart initialization failed:', error);
    showChartFallback();
    throw new Error('Could not initialize charts: ' + error.message);
  }
}

function showChartFallback() {
  const chartRoot = document.getElementById('chartRoot');
  const macdRoot = document.getElementById('macdRoot');
  
  chartRoot.innerHTML = `
    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i>
      Chart display unavailable. Analysis data is still functional.
    </div>
  `;
  
  macdRoot.innerHTML = `
    <div class="alert alert-secondary">
      MACD indicator unavailable
    </div>
  `;
}

async function analyze() {
  console.log('Starting analysis...');
  
  const pair = document.getElementById('pairSelect').value;
  const timeframe = document.getElementById('timeframeSelect').value;
  
  try {
    // Show loading state
    document.getElementById('aiSignalBadge').className = 'ai-signal-hold';
    document.getElementById('aiSignalBadge').textContent = 'ANALYZING...';
    document.getElementById('aiSummary').textContent = 'Fetching market data...';
    document.getElementById('statusIndicator').className = 'badge bg-warning ms-2';
    document.getElementById('statusIndicator').textContent = 'Analyzing';
    
    // Fetch analysis data
    const analysisData = await fetchAnalysisData(pair, timeframe);
    
    // Update UI with analysis results
    updateTradingSignal(analysisData);
    updateRiskAssessment(analysisData);
    updateTechnicalIndicators(analysisData);
    updatePriceData(analysisData);
    
    // Update charts if available
    if (window.tradingCharts) {
      await updateCharts(analysisData);
    }
    
    console.log('Analysis completed successfully');
    
  } catch (error) {
    console.error('Analysis failed:', error);
    showError('Analysis failed: ' + error.message);
  }
}

async function fetchAnalysisData(pair, timeframe) {
  console.log(`Fetching analysis for ${pair} ${timeframe}...`);
  
  try {
    const response = await fetch(`/api/analyze?pair=${pair}&timeframe=${timeframe}`);
    
    if (!response.ok) {
      throw new Error(`Server returned ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Analysis data received:', data);
    return data;
    
  } catch (error) {
    console.error('Failed to fetch analysis data:', error);
    
    // Return sample data as fallback
    return generateSampleData(pair, timeframe);
  }
}

function generateSampleData(pair, timeframe) {
  console.log('Generating sample data...');
  
  const samplePrice = 148.75 + (Math.random() - 0.5) * 2;
  const signal = Math.random() > 0.6 ? 'BUY' : Math.random() > 0.3 ? 'SELL' : 'HOLD';
  
  return {
    ai_analysis: {
      signal: signal,
      confidence: Math.floor(60 + Math.random() * 35),
      analysis_summary: `AI analysis for ${pair} on ${timeframe} timeframe. Market shows ${signal.toLowerCase()} signals with strong momentum.`,
      entry_price: (samplePrice * 0.998).toFixed(4),
      stop_loss: (samplePrice * 0.99).toFixed(4),
      take_profit_1: (samplePrice * 1.01).toFixed(4),
      risk_level: Math.random() > 0.7 ? 'High' : Math.random() > 0.4 ? 'Medium' : 'Low'
    },
    price_data: {
      current: samplePrice,
      change_pct: (Math.random() - 0.5) * 2
    },
    technical_analysis: {
      momentum: {
        rsi: (30 + Math.random() * 40).toFixed(2),
        macd: (Math.random() - 0.5).toFixed(4)
      },
      trend: {
        adx: (20 + Math.random() * 30).toFixed(2),
        trend_direction: Math.random() > 0.5 ? 'Bullish' : 'Bearish'
      }
    },
    risk_assessment: {
      risk_score: Math.floor(Math.random() * 10),
      approved: Math.random() > 0.3
    }
  };
}

function updateTradingSignal(analysisData) {
  const aiAnalysis = analysisData.ai_analysis || {};
  const signal = aiAnalysis.signal || 'HOLD';
  const confidence = aiAnalysis.confidence || 0;
  
  const signalElement = document.getElementById('aiSignalBadge');
  signalElement.textContent = signal;
  
  // Update signal color
  if (signal === 'BUY') {
    signalElement.className = 'ai-signal-buy';
  } else if (signal === 'SELL') {
    signalElement.className = 'ai-signal-sell';
  } else {
    signalElement.className = 'ai-signal-hold';
  }
  
  // Update confidence and risk
  document.getElementById('aiConfidence').textContent = confidence + '%';
  document.getElementById('aiRisk').textContent = aiAnalysis.risk_level || 'Medium';
  
  // Update trading levels
  document.getElementById('aiEntry').textContent = aiAnalysis.entry_price || '-';
  document.getElementById('aiSL').textContent = aiAnalysis.stop_loss || '-';
  document.getElementById('aiTP1').textContent = aiAnalysis.take_profit_1 || '-';
  
  // Update summary
  document.getElementById('aiSummary').textContent = 
    aiAnalysis.analysis_summary || `${signal} signal with ${confidence}% confidence`;
}

function updateRiskAssessment(analysisData) {
  const risk = analysisData.risk_assessment || {};
  const score = risk.risk_score || 0;
  const approved = risk.approved;
  
  document.getElementById('riskScore').textContent = score + '/10';
  
  // Update progress bar color
  const progressBar = document.getElementById('riskProgress');
  progressBar.style.width = (score * 10) + '%';
  
  if (score <= 3) {
    progressBar.className = 'progress-bar bg-success';
    document.getElementById('riskStatus').textContent = 'Low Risk - Trade Approved';
    document.getElementById('riskStatus').className = 'text-success fw-bold';
  } else if (score <= 6) {
    progressBar.className = 'progress-bar bg-warning';
    document.getElementById('riskStatus').textContent = 'Medium Risk - Proceed with Caution';
    document.getElementById('riskStatus').className = 'text-warning fw-bold';
  } else {
    progressBar.className = 'progress-bar bg-danger';
    document.getElementById('riskStatus').textContent = 'High Risk - Not Recommended';
    document.getElementById('riskStatus').className = 'text-danger fw-bold';
  }
}

function updateTechnicalIndicators(analysisData) {
  const tech = analysisData.technical_analysis || {};
  const momentum = tech.momentum || {};
  const trend = tech.trend || {};
  
  document.getElementById('rsiVal').textContent = momentum.rsi || '-';
  document.getElementById('macdVal').textContent = momentum.macd || '-';
  document.getElementById('adxVal').textContent = trend.adx || '-';
  document.getElementById('trendVal').textContent = trend.trend_direction || '-';
}

function updatePriceData(analysisData) {
  const priceData = analysisData.price_data || {};
  const currentPrice = priceData.current || 0;
  const change = priceData.change_pct || 0;
  
  document.getElementById('livePrice').textContent = currentPrice.toFixed(4);
  
  // Update change indicator
  const changeElement = document.getElementById('pairChange');
  changeElement.textContent = '(' + (change >= 0 ? '+' : '') + change.toFixed(2) + '%)';
  changeElement.className = change >= 0 ? 'price-change change-positive ms-2' : 'price-change change-negative ms-2';
  
  // Update status indicator
  document.getElementById('statusIndicator').textContent = 'Live';
  document.getElementById('statusIndicator').className = 'badge bg-success ms-2';
}

async function updateCharts(analysisData) {
  console.log('Updating charts...');
  
  try {
    const charts = window.tradingCharts;
    if (!charts || !charts.candleSeries) {
      console.warn('Charts not available for update');
      return;
    }
    
    // Generate sample chart data
    const chartData = generateChartData();
    
    // Update main chart
    charts.candleSeries.setData(chartData);
    
    // Generate MACD data
    const macdData = generateMACDData(chartData);
    
    // Update MACD chart
    charts.macdLineSeries.setData(macdData);
    
    console.log('Charts updated successfully');
    
  } catch (error) {
    console.error('Failed to update charts:', error);
  }
}

function generateChartData() {
  const data = [];
  const basePrice = 148.75;
  const now = new Date();
  
  for (let i = 100; i >= 0; i--) {
    const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
    
    const open = basePrice + (Math.random() - 0.5) * 2;
    const close = open + (Math.random() - 0.5) * 1.5;
    const high = Math.max(open, close) + Math.random() * 1;
    const low = Math.min(open, close) - Math.random() * 1;
    
    data.push({
      time: date.toISOString().split('T')[0],
      open: parseFloat(open.toFixed(4)),
      high: parseFloat(high.toFixed(4)),
      low: parseFloat(low.toFixed(4)),
      close: parseFloat(close.toFixed(4))
    });
  }
  
  return data;
}

function generateMACDData(chartData) {
  return chartData.map((item, index) => ({
    time: item.time,
    value: (Math.sin(index * 0.1) * 0.5 + (Math.random() - 0.5) * 0.2)
  }));
}

function showError(message) {
  console.error('Displaying error:', message);
  
  // Update UI to show error
  document.getElementById('aiSignalBadge').className = 'ai-signal-hold';
  document.getElementById('aiSignalBadge').textContent = 'ERROR';
  document.getElementById('aiSummary').textContent = message;
  document.getElementById('aiSummary').style.color = '#ef4444';
  
  document.getElementById('riskStatus').textContent = 'Risk assessment unavailable';
  
  document.getElementById('statusIndicator').textContent = 'Error';
  document.getElementById('statusIndicator').className = 'badge bg-danger ms-2';
}

// Handle window resize
window.addEventListener('resize', function() {
  if (window.tradingCharts && window.tradingCharts.mainChart) {
    try {
      const chartRoot = document.getElementById('chartRoot');
      const macdRoot = document.getElementById('macdRoot');
      
      window.tradingCharts.mainChart.resize(chartRoot.clientWidth, 400);
      window.tradingCharts.macdChart.resize(macdRoot.clientWidth, 150);
    } catch (error) {
      console.log('Resize error:', error);
    }
  }
});

console.log('ANDRO-FX Frontend script loaded');
</script>
</body>
</html>
