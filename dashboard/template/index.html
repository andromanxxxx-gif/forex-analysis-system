<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ANDRO-FX Precision Forex Trading</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --deepseek-primary: #0066cc;
      --deepseek-secondary: #00aaff;
      --deepseek-accent: #004499;
      --signal-buy: #10b981;
      --signal-sell: #ef4444;
      --signal-hold: #f59e0b;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --bg-primary: #f8fafc;
      --bg-card: #ffffff;
      --border-radius: 12px;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: "Inter", "Segoe UI", sans-serif;
      padding: 18px;
    }

    .topbar {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 15px 20px;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--deepseek-primary);
    }

    .brand-logo i {
      color: var(--deepseek-secondary);
    }

    .card-soft {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--deepseek-primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--deepseek-secondary);
    }

    #chartRoot { 
      height: 520px; 
      border-radius: var(--border-radius); 
      background: var(--bg-card);
    }
    
    #macdRoot { 
      height: 160px; 
      margin-top: 15px; 
      border-radius: var(--border-radius); 
      background: var(--bg-card);
    }

    .muted { 
      color: var(--text-secondary); 
      font-size: 0.95rem; 
    }

    .ai-signal-buy { 
      color: white; 
      background: var(--signal-buy); 
      padding: 8px 16px; 
      border-radius: 8px; 
      font-weight: 700;
      font-size: 1.2rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
    }

    .ai-signal-sell { 
      color: white; 
      background: var(--signal-sell); 
      padding: 8px 16px; 
      border-radius: 8px; 
      font-weight: 700;
      font-size: 1.2rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
    }

    .ai-signal-hold { 
      color: white; 
      background: var(--signal-hold); 
      padding: 8px 16px; 
      border-radius: 8px; 
      font-weight: 700;
      font-size: 1.2rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
    }

    .small-muted { 
      color: var(--text-secondary); 
      font-size: 0.9rem; 
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-live { background-color: var(--signal-buy); }
    .status-offline { background-color: var(--signal-sell); }

    .metric-card {
      background: var(--bg-primary);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid var(--deepseek-secondary);
    }

    .metric-value {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .backtest-panel {
      max-height: 400px;
      overflow-y: auto;
    }

    .performance-grade {
      font-size: 1.6rem;
      font-weight: bold;
      text-align: center;
      padding: 12px;
      border-radius: 10px;
      margin: 12px 0;
    }

    .grade-a { background: #d1fae5; color: #065f46; }
    .grade-b { background: #fef3c7; color: #92400e; }
    .grade-c { background: #fde68a; color: #78350f; }
    .grade-d { background: #fecaca; color: #991b1b; }

    .trading-level {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 8px;
      margin: 5px 0;
    }

    .level-entry { 
      background: rgba(16, 185, 129, 0.1); 
      color: var(--signal-buy);
      border-left: 4px solid var(--signal-buy);
    }

    .level-sl { 
      background: rgba(239, 68, 68, 0.1); 
      color: var(--signal-sell);
      border-left: 4px solid var(--signal-sell);
    }

    .level-tp { 
      background: rgba(34, 197, 94, 0.1); 
      color: #16a34a;
      border-left: 4px solid #16a34a;
    }

    .btn-deepseek {
      background: var(--deepseek-primary);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
    }

    .btn-deepseek:hover {
      background: var(--deepseek-accent);
      color: white;
    }

    .btn-action {
      background: var(--deepseek-secondary);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
    }

    .btn-action:hover {
      background: var(--deepseek-primary);
      color: white;
    }

    .price-ticker {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--deepseek-primary);
    }

    .price-change {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .change-positive { color: var(--signal-buy); }
    .change-negative { color: var(--signal-sell); }

    .risk-approved { 
      color: var(--signal-buy); 
      font-weight: 700;
      font-size: 1.1rem;
    }

    .risk-rejected { 
      color: var(--signal-sell); 
      font-weight: 700;
      font-size: 1.1rem;
    }

    .tech-indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .indicator-value {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .news-container {
      max-height: 120px;
      overflow-y: auto;
      padding: 10px;
      background: var(--bg-primary);
      border-radius: 8px;
      border-left: 4px solid var(--deepseek-secondary);
    }

    /* Risk Management Styles */
    .risk-meter-bar {
      background: #e5e7eb;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .risk-meter-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .risk-meter-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .risk-factor-card {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
    }

    .risk-factor-card.low {
      border-left: 4px solid #10b981;
    }

    .risk-factor-card.medium {
      border-left: 4px solid #f59e0b;
    }

    .risk-factor-card.high {
      border-left: 4px solid #ef4444;
    }

    .risk-factor-card.pending {
      border-left: 4px solid #6b7280;
    }

    .risk-factor-name {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .risk-factor-status {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .risk-tip {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      font-size: 0.8rem;
    }

    .risk-tip:last-child {
      margin-bottom: 0;
    }

    /* Support Resistance Styles */
    .levels-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .level-card {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .support-card {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .resistance-card {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .level-title {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .support-title {
      color: #10b981;
    }

    .resistance-title {
      color: #ef4444;
    }

    .level-value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .level-distance {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 3px;
    }

    .pivot-levels {
      margin-top: 15px;
    }

    .pivot-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .pivot-label {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .pivot-value {
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* Loading Spinner */
    .spinner-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .chart-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>

<div class="topbar">
  <div class="brand-logo">
    <i class="fas fa-brain"></i>
    <span>ANDRO-FX Precision Forex Trading</span>
  </div>
  
  <div class="d-flex flex-wrap gap-3 align-items-center ms-auto">
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Pair</label>
      <select id="pairSelect" class="form-select form-select-sm" style="width:130px;">
        <option>USDJPY</option>
        <option>EURJPY</option>
        <option>GBPJPY</option>
        <option>CHFJPY</option>
        <option>GBPUSD</option>
        <option>USDCHF</option>
        <option>AUDUSD</option>
        <option>USDCAD</option>
        <option>NZDUSD</option>
      </select>
    </div>
    
    <div class="d-flex align-items-center">
      <label class="small-muted mb-0 me-2">Timeframe</label>
      <select id="timeframeSelect" class="form-select form-select-sm" style="width:100px;">
        <option>1D</option>
        <option>4H</option>
        <option>1H</option>
        <option>M30</option>
      </select>
    </div>
    
    <button id="analyzeBtn" class="btn btn-deepseek">
      <i class="fas fa-chart-line me-2"></i>Analyze
    </button>
    
    <button id="runBacktestBtn" class="btn btn-action">
      <i class="fas fa-play-circle me-2"></i>Backtest
    </button>
    
    <div id="pairTicker" class="d-flex align-items-center ms-3">
      <span id="selectedPair" class="price-ticker me-2">USDJPY –</span>
      <span id="livePrice" class="price-ticker">0.0000</span>
      <span id="pairChange" class="price-change ms-2">(0.00%)</span>
      <span id="statusIndicator" class="status-indicator status-offline ms-2"></span>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card-soft position-relative">
      <div class="chart-loading" id="chartLoading">
        <div class="spinner-border text-primary" role="status"></div>
        <span class="ms-2">Loading chart data...</span>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <div class="section-title">
            <i class="fas fa-chart-candlestick"></i>
            <span>Live Price Chart</span>
          </div>
          <div class="muted" id="chartSubtitle">Real-time Candlestick · EMA26 · MACD</div>
        </div>
        <div class="text-end">
          <div class="small-muted">Current Price</div>
          <div class="price-ticker" id="currentPrice">-</div>
        </div>
      </div>
      <div id="chartRoot"></div>
      <div id="macdRoot"></div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-robot"></i>
        <span>AI Trading Signal</span>
      </div>
      
      <div id="aiSummary" class="muted mb-3">No analysis yet. Click Analyze to start.</div>
      
      <div class="mb-3">
        <div class="small-muted mb-2">TRADING SIGNAL</div>
        <div id="aiSignalBadge" class="ai-signal-hold">HOLD</div>
      </div>
      
      <div class="row mb-3">
        <div class="col-6">
          <div class="metric-card">
            <div class="small-muted">Confidence</div>
            <div class="metric-value" id="aiConfidence">-</div>
          </div>
        </div>
        <div class="col-6">
          <div class="metric-card">
            <div class="small-muted">Risk Level</div>
            <div class="metric-value" id="aiRisk">-</div>
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <div class="small-muted mb-2">TRADING LEVELS</div>
        <div class="trading-level level-entry">
          <i class="fas fa-sign-in-alt me-2"></i>Entry: <span id="aiEntry">-</span>
        </div>
        <div class="trading-level level-sl">
          <i class="fas fa-stop-circle me-2"></i>Stop Loss: <span id="aiSL">-</span>
        </div>
        <div class="trading-level level-tp">
          <i class="fas fa-target me-2"></i>Take Profit 1: <span id="aiTP1">-</span>
        </div>
        <div class="trading-level level-tp">
          <i class="fas fa-bullseye me-2"></i>Take Profit 2: <span id="aiTP2">-</span>
        </div>
      </div>
    </div>

    <!-- Risk Management Card -->
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-shield-alt"></i>
        <span>Risk Management</span>
      </div>
      
      <!-- Risk Status dengan Visual yang Lebih Menarik -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="small-muted">TRADE APPROVAL STATUS</div>
          <div id="riskScoreBadge" class="badge bg-secondary">Score: -/10</div>
        </div>
        
        <div id="riskStatus" class="text-center p-4 rounded-3 mb-3" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 2px solid #bae6fd;">
          <div class="risk-icon mb-2">
            <i class="fas fa-question-circle fa-2x text-muted"></i>
          </div>
          <div id="riskMainStatus" class="fw-bold fs-5">Awaiting Analysis</div>
          <div id="riskSubStatus" class="small text-muted mt-1">No risk assessment data available</div>
        </div>
      </div>

      <!-- Risk Score Visualization -->
      <div class="mb-4">
        <div class="small-muted mb-2">RISK SCORE BREAKDOWN</div>
        <div class="risk-score-container">
          <div class="risk-meter mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Low Risk</span>
              <span class="small">High Risk</span>
            </div>
            <div class="risk-meter-bar">
              <div id="riskMeterFill" class="risk-meter-fill" style="width: 0%"></div>
            </div>
            <div class="risk-meter-labels">
              <span>0</span>
              <span>2</span>
              <span>4</span>
              <span>6</span>
              <span>8</span>
              <span>10</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Factors Grid -->
      <div class="mb-4">
        <div class="small-muted mb-2">RISK FACTORS</div>
        <div id="riskFactors" class="row g-2">
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Market Volatility</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Position Size</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Correlation</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="risk-factor-card pending">
              <i class="fas fa-clock me-2"></i>
              <div>
                <div class="risk-factor-name">Daily Limits</div>
                <div class="risk-factor-status">Pending</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Details -->
      <div id="riskDetails" style="display: none;">
        <div class="small-muted mb-2">DETAILED ANALYSIS</div>
        <div id="riskWarnings" class="alert alert-warning py-2 small">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span>No warnings detected</span>
        </div>
        <div id="riskRejections" class="alert alert-danger py-2 small" style="display: none;">
          <i class="fas fa-times-circle me-2"></i>
          <span>Rejection reasons will appear here</span>
        </div>
      </div>

      <!-- Risk Management Tips -->
      <div class="mt-3 pt-3 border-top">
        <div class="small-muted mb-2">RISK MANAGEMENT TIPS</div>
        <div class="risk-tips">
          <div class="risk-tip">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            <span class="small">Always use stop-loss orders</span>
          </div>
          <div class="risk-tip">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            <span class="small">Risk only 1-2% per trade</span>
          </div>
          <div class="risk-tip">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            <span class="small">Monitor correlation between pairs</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Support & Resistance Card -->
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-layer-group"></i>
        <span>Support & Resistance</span>
      </div>
      
      <div class="levels-container">
        <div class="level-card support-card">
          <div class="level-title support-title">SUPPORT</div>
          <div class="level-value" id="supportLevel">-</div>
          <div class="level-distance" id="supportDistance">-</div>
        </div>
        <div class="level-card resistance-card">
          <div class="level-title resistance-title">RESISTANCE</div>
          <div class="level-value" id="resistanceLevel">-</div>
          <div class="level-distance" id="resistanceDistance">-</div>
        </div>
      </div>

      <div class="pivot-levels">
        <div class="small-muted mb-2">PIVOT POINTS</div>
        <div class="pivot-row">
          <span class="pivot-label">R3</span>
          <span class="pivot-value" id="pivotR3">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">R2</span>
          <span class="pivot-value" id="pivotR2">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">R1</span>
          <span class="pivot-value" id="pivotR1">-</span>
        </div>
        <div class="pivot-row" style="border-bottom: 2px solid #3b82f6;">
          <span class="pivot-label">PIVOT</span>
          <span class="pivot-value" id="pivotPoint">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">S1</span>
          <span class="pivot-value" id="pivotS1">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">S2</span>
          <span class="pivot-value" id="pivotS2">-</span>
        </div>
        <div class="pivot-row">
          <span class="pivot-label">S3</span>
          <span class="pivot-value" id="pivotS3">-</span>
        </div>
      </div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-newspaper"></i>
        <span>Market News</span>
      </div>
      <div class="news-container" id="fundamentalNews">
        No news available. Analyzing market conditions...
      </div>
    </div>

    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-chart-bar"></i>
        <span>Technical Analysis</span>
      </div>
      
      <div class="tech-indicator">
        <span class="small-muted">RSI</span>
        <span class="indicator-value" id="rsiVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">MACD</span>
        <span class="indicator-value" id="macdVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">MACD Histogram</span>
        <span class="indicator-value" id="macdHistVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">ADX</span>
        <span class="indicator-value" id="adxVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">ATR</span>
        <span class="indicator-value" id="atrVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">Volatility</span>
        <span class="indicator-value" id="volVal">-</span>
      </div>
      <div class="tech-indicator">
        <span class="small-muted">Trend</span>
        <span class="indicator-value" id="trendVal">-</span>
      </div>
    </div>
    
    <div class="card-soft">
      <div class="section-title">
        <i class="fas fa-chart-line"></i>
        <span>Backtest Results</span>
        <span id="backtestStatus" class="badge bg-secondary ms-2">Not Run</span>
      </div>
      <div id="backtestResults" class="backtest-panel">
        <div class="text-center muted">Run backtest to see performance results</div>
      </div>
    </div>
  </div>
</div>

<!-- Backtest Configuration Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-play-circle me-2"></i>Run Backtest
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Initial Balance ($)</label>
          <input type="number" class="form-control" id="initialBalance" value="10000" min="1000" step="1000">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Period (Days)</label>
          <input type="number" class="form-control" id="backtestDays" value="30" min="7" max="365">
        </div>
        <div class="mb-3">
          <label class="form-label">Backtest Type</label>
          <select class="form-select" id="backtestType">
            <option value="advanced">Advanced Backtest</option>
            <option value="basic">Basic Backtest</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-deepseek" id="startBacktestBtn">
          <i class="fas fa-play me-2"></i>Start Backtest
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global state untuk menyimpan data chart
let currentChartData = [];
let currentEmaData = [];
let currentMacdData = { macd: [], signal: [], hist: [] };
let lastCandleTime = null;

/* ===== Utilities ===== */
function calcEMA(values, period){
  if (!values || values.length === 0) return [];
  const k=2/(period+1);
  let ema=[values[0]];
  for(let i=1;i<values.length;i++) {
    ema.push(values[i]*k+ema[i-1]*(1-k));
  }
  return ema;
}

function calcMACDSeries(c,short=12,long=26,signal=9){
  if (!c || c.length === 0) return {macd: [], sig: [], hist: []};
  const emaS=calcEMA(c,short),emaL=calcEMA(c,long);
  const macd=c.map((_,i)=>emaS[i]-emaL[i]);
  const sig=calcEMA(macd,signal);
  const hist=macd.map((v,i)=>v-(sig[i]||0));
  return {macd,sig,hist};
}

// Calculate Pivot Points
function calculatePivotPoints(high, low, close) {
  const pivot = (high + low + close) / 3;
  const r1 = (2 * pivot) - low;
  const s1 = (2 * pivot) - high;
  const r2 = pivot + (high - low);
  const s2 = pivot - (high - low);
  const r3 = high + 2 * (pivot - low);
  const s3 = low - 2 * (high - pivot);
  
  return {
    pivot: pivot,
    r1: r1,
    r2: r2,
    r3: r3,
    s1: s1,
    s2: s2,
    s3: s3
  };
}

// Improved date formatting function for different timeframes
function fmt(d, timeframe = '1D') {
  try {
    if (typeof d === 'string') {
      // Jika sudah string, return as-is untuk intraday
      if (timeframe !== '1D' && d.includes('T')) {
        return d; // Keep full datetime for intraday
      }
      return d.split('T')[0]; // Hanya date untuk daily
    } else if (d instanceof Date) {
      if (timeframe === '1D') {
        return d.toISOString().split('T')[0]; // YYYY-MM-DD untuk daily
      } else {
        // Untuk intraday, format dengan waktu
        return d.toISOString().replace('Z', ''); // YYYY-MM-DDTHH:mm:ss.sss
      }
    }
    return String(d);
  } catch (e) {
    console.error('Date formatting error:', e, d);
    return '2023-01-01';
  }
}

// Clean data - remove null/undefined values
function cleanChartData(data) {
  return data.filter(item => 
    item && 
    item.time && 
    item.open !== null && item.open !== undefined &&
    item.high !== null && item.high !== undefined &&
    item.low !== null && item.low !== undefined &&
    item.close !== null && item.close !== undefined
  ).map(item => ({
    time: item.time,
    open: parseFloat(item.open) || 0,
    high: parseFloat(item.high) || 0,
    low: parseFloat(item.low) || 0,
    close: parseFloat(item.close) || 0
  }));
}

/* ===== Pair Ticker Update Function ===== */
function updatePairTicker(pair) {
  document.getElementById('selectedPair').textContent = pair + ' –';
}

/* ===== Risk Management Functions ===== */
function updateRiskAssessment(riskData) {
  const riskScore = riskData.risk_score || 0;
  const approved = riskData.approved;
  const rejectionReasons = riskData.rejection_reasons || [];
  const riskFactors = riskData.risk_factors || [];
  
  // Update risk score badge
  const riskScoreBadge = document.getElementById('riskScoreBadge');
  riskScoreBadge.textContent = `Score: ${riskScore}/10`;
  riskScoreBadge.className = `badge ${
    riskScore <= 3 ? 'bg-success' : 
    riskScore <= 6 ? 'bg-warning' : 'bg-danger'
  }`;
  
  // Update risk status display
  const riskMainStatus = document.getElementById('riskMainStatus');
  const riskSubStatus = document.getElementById('riskSubStatus');
  const riskStatus = document.getElementById('riskStatus');
  const riskIcon = riskStatus.querySelector('.risk-icon i');
  
  if (approved) {
    riskMainStatus.textContent = 'APPROVED';
    riskSubStatus.textContent = 'Trade meets risk criteria';
    riskStatus.style.background = 'linear-gradient(135deg, #f0f9ff, #e0f2fe)';
    riskStatus.style.border = '2px solid #bae6fd';
    riskIcon.className = 'fas fa-check-circle fa-2x text-success';
  } else {
    riskMainStatus.textContent = 'REJECTED';
    riskSubStatus.textContent = rejectionReasons.length > 0 ? 
      rejectionReasons[0] : 'Trade does not meet risk criteria';
    riskStatus.style.background = 'linear-gradient(135deg, #fef2f2, #fee2e2)';
    riskStatus.style.border = '2px solid #fecaca';
    riskIcon.className = 'fas fa-times-circle fa-2x text-danger';
  }
  
  // Update risk meter
  const riskMeterFill = document.getElementById('riskMeterFill');
  riskMeterFill.style.width = `${riskScore * 10}%`;
  riskMeterFill.style.background = riskScore <= 3 ? '#10b981' : 
                                  riskScore <= 6 ? '#f59e0b' : '#ef4444';
  
  // Update risk factors
  const riskFactorsContainer = document.getElementById('riskFactors');
  riskFactorsContainer.innerHTML = '';
  
  if (riskFactors.length > 0) {
    riskFactors.forEach(factor => {
      const factorElement = document.createElement('div');
      factorElement.className = 'col-6';
      
      let statusClass = 'pending';
      let statusIcon = 'clock';
      
      if (factor.status === 'low') {
        statusClass = 'low';
        statusIcon = 'check-circle';
      } else if (factor.status === 'medium') {
        statusClass = 'medium';
        statusIcon = 'exclamation-triangle';
      } else if (factor.status === 'high') {
        statusClass = 'high';
        statusIcon = 'times-circle';
      }
      
      factorElement.innerHTML = `
        <div class="risk-factor-card ${statusClass}">
          <i class="fas fa-${statusIcon} me-2"></i>
          <div>
            <div class="risk-factor-name">${factor.name}</div>
            <div class="risk-factor-status">${factor.status.toUpperCase()}</div>
          </div>
        </div>
      `;
      riskFactorsContainer.appendChild(factorElement);
    });
  }
  
  // Update risk details
  const riskDetails = document.getElementById('riskDetails');
  const riskWarnings = document.getElementById('riskWarnings');
  const riskRejections = document.getElementById('riskRejections');
  
  if (rejectionReasons.length > 0) {
    riskDetails.style.display = 'block';
    riskWarnings.style.display = 'none';
    riskRejections.style.display = 'block';
    riskRejections.innerHTML = `<i class="fas fa-times-circle me-2"></i><span>${rejectionReasons.join(', ')}</span>`;
  } else if (riskScore > 6) {
    riskDetails.style.display = 'block';
    riskWarnings.style.display = 'block';
    riskRejections.style.display = 'none';
    riskWarnings.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i><span>High risk score detected - proceed with caution</span>`;
  } else {
    riskDetails.style.display = 'none';
  }
}

/* ===== Support & Resistance Functions ===== */
function updateSupportResistance(data) {
  const srData = data.support_resistance || {};
  const currentPrice = data.price_data?.current || 0;
  
  // Update Support & Resistance levels
  const supportLevel = srData.support || (currentPrice * 0.995).toFixed(4);
  const resistanceLevel = srData.resistance || (currentPrice * 1.005).toFixed(4);
  
  document.getElementById('supportLevel').textContent = supportLevel;
  document.getElementById('resistanceLevel').textContent = resistanceLevel;
  
  // Calculate and display distances
  if (currentPrice > 0) {
    const supportDistance = ((currentPrice - supportLevel) / currentPrice * 100).toFixed(2);
    const resistanceDistance = ((resistanceLevel - currentPrice) / currentPrice * 100).toFixed(2);
    
    document.getElementById('supportDistance').textContent = `${supportDistance}% below`;
    document.getElementById('resistanceDistance').textContent = `${resistanceDistance}% above`;
  }
  
  // Calculate and update Pivot Points
  const priceSeries = data.price_series || [];
  if (priceSeries.length > 0) {
    const lastDay = priceSeries[priceSeries.length - 1];
    const pivots = calculatePivotPoints(
      parseFloat(lastDay.high) || currentPrice * 1.01,
      parseFloat(lastDay.low) || currentPrice * 0.99,
      parseFloat(lastDay.close) || currentPrice
    );
    
    document.getElementById('pivotPoint').textContent = pivots.pivot.toFixed(4);
    document.getElementById('pivotR1').textContent = pivots.r1.toFixed(4);
    document.getElementById('pivotR2').textContent = pivots.r2.toFixed(4);
    document.getElementById('pivotR3').textContent = pivots.r3.toFixed(4);
    document.getElementById('pivotS1').textContent = pivots.s1.toFixed(4);
    document.getElementById('pivotS2').textContent = pivots.s2.toFixed(4);
    document.getElementById('pivotS3').textContent = pivots.s3.toFixed(4);
  }
}

/* ===== Chart Setup ===== */
const chart = LightweightCharts.createChart(document.getElementById('chartRoot'), {
  layout: { 
    backgroundColor: '#fff', 
    textColor: '#111' 
  },
  grid: {
    vertLines: { color: '#f3f4f6' },
    horzLines: { color: '#f3f4f6' }
  },
  timeScale: {
    borderColor: '#eee',
    timeVisible: true,
    secondsVisible: false
  },
  rightPriceScale: {
    borderColor: '#eee'
  },
  width: document.getElementById('chartRoot').clientWidth,
  height: 520
});

const candle = chart.addCandlestickSeries({
  upColor: '#16a34a',
  downColor: '#dc2626', 
  borderVisible: true,
  wickUpColor: '#16a34a',
  wickDownColor: '#dc2626'
});

const ema26 = chart.addLineSeries({
  color: '#2563eb',
  lineWidth: 1.5,
  priceScaleId: 'right'
});

const macdChart = LightweightCharts.createChart(document.getElementById('macdRoot'), {
  layout: { 
    backgroundColor: '#fff', 
    textColor: '#111' 
  },
  grid: {
    vertLines: { color: '#f3f4f6' },
    horzLines: { color: '#f3f4f6' }
  },
  timeScale: {
    borderColor: '#eee',
    timeVisible: true,
    secondsVisible: false
  },
  width: document.getElementById('macdRoot').clientWidth,
  height: 160
});

const macdLine = macdChart.addLineSeries({
  color: '#0ea5e9',
  lineWidth: 1
});

const macdSignal = macdChart.addLineSeries({
  color: '#f59e0b', 
  lineWidth: 1
});

const macdHist = macdChart.addHistogramSeries({
  color: '#a78bfa',
  priceFormat: {
    type: 'volume',
  }
});

// Sync time scales between charts
chart.timeScale().subscribeVisibleTimeRangeChange((timeRange) => {
  try {
    macdChart.timeScale().setVisibleRange(timeRange);
  } catch (e) {
    console.log('Time scale sync error:', e);
  }
});

/* ===== DOM refs ===== */
const livePriceEl = document.getElementById('livePrice');
const pairSelect = document.getElementById('pairSelect');
const timeframeSelect = document.getElementById('timeframeSelect');
const aiSummaryEl = document.getElementById('aiSummary');
const aiSignal = document.getElementById('aiSignalBadge');
const aiConfidence = document.getElementById('aiConfidence');
const aiRisk = document.getElementById('aiRisk');
const aiEntry = document.getElementById('aiEntry');
const aiSL = document.getElementById('aiSL');
const aiTP1 = document.getElementById('aiTP1');
const aiTP2 = document.getElementById('aiTP2');
const fundNews = document.getElementById('fundamentalNews');
const rsiEl = document.getElementById('rsiVal');
const macdValEl = document.getElementById('macdVal');
const macdHistVal = document.getElementById('macdHistVal');
const adxEl = document.getElementById('adxVal');
const atrEl = document.getElementById('atrVal');
const volEl = document.getElementById('volVal');
const trendEl = document.getElementById('trendVal');
const changeEl = document.getElementById('pairChange');
const statusIndicator = document.getElementById('statusIndicator');
const backtestResultsEl = document.getElementById('backtestResults');
const backtestStatusEl = document.getElementById('backtestStatus');
const currentPriceEl = document.getElementById('currentPrice');
const chartLoading = document.getElementById('chartLoading');

/* ===== Data state ===== */
let auto = false, autoRefreshInterval = null, livePriceInterval = null;
let currentSignal = 'HOLD';

function setSignal(sig){
  aiSignal.textContent = sig;
  currentSignal = sig;
  aiSignal.className = sig === 'BUY' ? 'ai-signal-buy' : 
                     sig === 'SELL' ? 'ai-signal-sell' : 'ai-signal-hold';
}

// Update status indicator
function updateStatusIndicator(isLive) {
  if (isLive) {
    statusIndicator.className = 'status-indicator status-live';
    statusIndicator.title = 'Live data connection active';
  } else {
    statusIndicator.className = 'status-indicator status-offline';
    statusIndicator.title = 'No live data connection';
  }
}

// Generate sample price data for testing - FIXED for timeframe 4H
function generateSamplePriceData(timeframe = '1D') {
  const data = [];
  const basePrice = 148.75;
  const now = new Date();
  
  let periods = 100;
  let timeIncrement;
  
  // Set time increment berdasarkan timeframe
  switch(timeframe) {
    case '4H':
      periods = 200; // More data for 4H
      timeIncrement = 4 * 60 * 60 * 1000; // 4 hours in milliseconds
      break;
    case '1H':
      periods = 400;
      timeIncrement = 60 * 60 * 1000; // 1 hour
      break;
    case 'M30':
      periods = 800;
      timeIncrement = 30 * 60 * 1000; // 30 minutes
      break;
    case '1D':
    default:
      periods = 100;
      timeIncrement = 24 * 60 * 60 * 1000; // 1 day
  }
  
  for (let i = periods; i >= 0; i--) {
    const date = new Date(now.getTime() - (i * timeIncrement));
    
    // Untuk intraday, pastikan waktu tidak selalu 00:00
    if (timeframe !== '1D') {
      // Set random hour within trading hours untuk variasi
      const hour = Math.floor(Math.random() * 24);
      const minute = timeframe === 'M30' ? (Math.random() > 0.5 ? 30 : 0) : 0;
      date.setHours(hour, minute, 0, 0);
    }
    
    const open = basePrice + (Math.random() - 0.5) * 2;
    const close = open + (Math.random() - 0.5) * 1.5;
    const high = Math.max(open, close) + Math.random() * 0.8;
    const low = Math.min(open, close) - Math.random() * 0.8;
    
    data.push({
      time: fmt(date, timeframe),
      open: open,
      high: high,
      low: low,
      close: close
    });
  }
  
  return data;
}

// Generate sample risk assessment data
function generateSampleRiskAssessment() {
  const riskScore = Math.floor(Math.random() * 11); // 0-10
  const approved = riskScore <= 7;
  
  const riskFactors = [
    { name: 'Market Volatility', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' },
    { name: 'Position Size', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' },
    { name: 'Correlation', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' },
    { name: 'Daily Limits', status: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low' }
  ];
  
  const rejectionReasons = approved ? [] : [
    'Position size exceeds daily limit',
    'High correlation with existing positions',
    'Market volatility too high'
  ].slice(0, Math.floor(Math.random() * 2) + 1);
  
  return {
    risk_score: riskScore,
    approved: approved,
    rejection_reasons: rejectionReasons,
    risk_factors: riskFactors
  };
}

// Generate sample support resistance data
function generateSampleSupportResistance(currentPrice) {
  const support = (currentPrice * (1 - (Math.random() * 0.02 + 0.005))).toFixed(4);
  const resistance = (currentPrice * (1 + (Math.random() * 0.02 + 0.005))).toFixed(4);
  
  return {
    support: support,
    resistance: resistance
  };
}

/* ===== Fetch + Render ===== */
async function analyze(){
  const pair = pairSelect.value, tf = timeframeSelect.value;
  
  // Show loading indicator
  chartLoading.style.display = 'block';
  
  // Update pair ticker text
  updatePairTicker(pair);
  
  try {
    console.log(`Fetching analysis for ${pair}-${tf}...`);
    const r = await fetch(`/api/analyze?pair=${pair}&timeframe=${tf}`); 
    
    if (!r.ok) {
      throw new Error(`HTTP error! status: ${r.status}`);
    }
    
    const j = await r.json();
    console.log('Analysis response:', j);
    
    // Update price series chart
    let chartData = [];
    
    if (j.price_series && j.price_series.length > 0) {
      console.log(`Processing ${j.price_series.length} price series data points`);
      chartData = j.price_series.map(p => ({
        time: fmt(p.date, tf), // Pass timeframe to formatter
        open: parseFloat(p.open) || 0,
        high: parseFloat(p.high) || 0,
        low: parseFloat(p.low) || 0,
        close: parseFloat(p.close) || 0
      }));
    } else {
      console.warn('No price_series data, using sample data');
      chartData = generateSamplePriceData(tf); // Pass timeframe to generator
    }
    
    // Clean and set chart data
    const cleanData = cleanChartData(chartData);
    currentChartData = cleanData;
    
    if (cleanData.length > 0) {
      candle.setData(cleanData);
      
      const closes = cleanData.map(d => d.close);
      
      // Calculate and update EMA
      const ema = calcEMA(closes, 26);
      currentEmaData = ema.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      ema26.setData(currentEmaData);
      
      // Calculate and update MACD
      const {macd, sig, hist} = calcMACDSeries(closes);
      currentMacdData = { 
        macd: macd.map(v => isNaN(v) ? 0 : v),
        signal: sig.map(v => isNaN(v) ? 0 : v),
        hist: hist.map(v => isNaN(v) ? 0 : v)
      };
      
      const macdSeriesData = macd.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      const signalSeriesData = sig.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      const histSeriesData = hist.map((v, i) => ({
        time: cleanData[i].time, 
        value: isNaN(v) ? 0 : v
      }));
      
      macdLine.setData(macdSeriesData);
      macdSignal.setData(signalSeriesData);
      macdHist.setData(histSeriesData);
      
      lastCandleTime = cleanData[cleanData.length - 1]?.time;
      
      // Update time scale format berdasarkan timeframe
      try {
        chart.timeScale().applyOptions({
          timeVisible: true,
          secondsVisible: false
        });
        macdChart.timeScale().applyOptions({
          timeVisible: true,
          secondsVisible: false
        });
      } catch (e) {
        console.log('Time scale update error:', e);
      }
      
      // Resize charts
      setTimeout(() => {
        try {
          chart.resize(document.getElementById('chartRoot').clientWidth, 520);
          macdChart.resize(document.getElementById('macdRoot').clientWidth, 160);
        } catch (e) {
          console.log('Chart resize error:', e);
        }
      }, 100);
    }
    
    // Update technical values
    const t = j.technical_analysis || {};
    console.log('Technical analysis:', t);
    
    // Handle momentum indicators
    if (t.momentum) {
      rsiEl.textContent = (t.momentum.rsi || 0).toFixed(2);
      macdValEl.textContent = (t.momentum.macd || 0).toFixed(4);
      macdHistVal.textContent = (t.momentum.macd_histogram || 0).toFixed(4);
    } else {
      rsiEl.textContent = '-';
      macdValEl.textContent = '-';
      macdHistVal.textContent = '-';
    }
    
    // Handle trend indicators
    if (t.trend) {
      adxEl.textContent = (t.trend.adx || 0).toFixed(2);
      trendEl.textContent = t.trend.trend_direction || '-';
    } else {
      adxEl.textContent = '-';
      trendEl.textContent = '-';
    }
    
    // Handle volatility indicators
    if (t.volatility) {
      atrEl.textContent = (t.volatility.atr || 0).toFixed(4);
      volEl.textContent = t.volatility.volatility_pct ? 
        (t.volatility.volatility_pct * 100).toFixed(2) + '%' : '-';
    } else {
      atrEl.textContent = '-';
      volEl.textContent = '-';
    }
    
    // Update price data
    const priceData = j.price_data || {};
    const currentPrice = priceData.current || (t.levels && t.levels.current_price);
    livePriceEl.textContent = currentPrice ? currentPrice.toFixed(4) : '-';
    currentPriceEl.textContent = currentPrice ? currentPrice.toFixed(4) : '-';
    
    // Update pair ticker with change
    const change = priceData.change_pct || 0;
    changeEl.textContent = '(' + (change >= 0 ? '+' : '') + change.toFixed(2) + '%)';
    changeEl.className = change >= 0 ? 'price-change change-positive' : 'price-change change-negative';
    
    // Update AI analysis
    const ai = j.ai_analysis || {};
    console.log('AI analysis:', ai);
    
    aiSummaryEl.textContent = ai.analysis_summary || 'No analysis available';
    setSignal(ai.signal || 'HOLD');
    aiConfidence.textContent = ai.confidence ? ai.confidence + '%' : '-';
    aiRisk.textContent = ai.risk_level || '-';
    aiEntry.textContent = ai.entry_price || '-';
    aiSL.textContent = ai.stop_loss || '-';
    aiTP1.textContent = ai.take_profit_1 || '-';
    aiTP2.textContent = ai.take_profit_2 || '-';
    
    // Update fundamental news
    fundNews.textContent = j.fundamental_analysis || 'No news available';
    
    // Update risk assessment with new function
    const risk = j.risk_assessment || generateSampleRiskAssessment();
    updateRiskAssessment(risk);
    
    // Update Support & Resistance
    const srData = {
      support_resistance: j.support_resistance || generateSampleSupportResistance(currentPrice),
      price_data: j.price_data || { current: currentPrice },
      price_series: j.price_series || []
    };
    updateSupportResistance(srData);
    
    updateStatusIndicator(true);
    
  } catch (error) {
    console.error('Analysis error:', error);
    updateStatusIndicator(false);
    
    // Show error to user
    aiSummaryEl.textContent = `Error: ${error.message}`;
    aiSummaryEl.style.color = '#ef4444';
  } finally {
    // Hide loading indicator
    chartLoading.style.display = 'none';
  }
}

/* ===== Live Price Update ===== */
let prevPrice = null;
async function updateLivePrice() {
  const pair = pairSelect.value;
  try {
    // Use the analyze endpoint to get updated price data
    const r = await fetch(`/api/analyze?pair=${pair}&timeframe=${timeframeSelect.value}`);
    
    if (!r.ok) return;
    
    const j = await r.json();
    
    const priceData = j.price_data || {};
    const t = j.technical_analysis || {};
    const currentPrice = priceData.current || (t.levels && t.levels.current_price);
    
    if (currentPrice && currentChartData.length > 0) {
      livePriceEl.textContent = currentPrice.toFixed(4);
      currentPriceEl.textContent = currentPrice.toFixed(4);
      
      // Update price change
      const change = priceData.change_pct || 0;
      changeEl.textContent = '(' + (change >= 0 ? '+' : '') + change.toFixed(2) + '%)';
      changeEl.className = change >= 0 ? 'price-change change-positive' : 'price-change change-negative';
      
      // Update current candle with live price - FIXED: Use our stored data instead of candle.data()
      const lastIndex = currentChartData.length - 1;
      const lastCandle = currentChartData[lastIndex];
      
      if (lastCandle) {
        const updatedCandle = {
          time: lastCandle.time,
          open: lastCandle.open,
          high: Math.max(lastCandle.high, currentPrice),
          low: Math.min(lastCandle.low, currentPrice),
          close: currentPrice
        };
        
        // Update our stored data
        currentChartData[lastIndex] = updatedCandle;
        
        // Update the chart
        candle.update(updatedCandle);
        
        // Update EMA with new close price
        const closes = currentChartData.map(d => d.close);
        const ema = calcEMA(closes, 26);
        const lastEma = ema[ema.length - 1];
        
        if (lastEma && !isNaN(lastEma)) {
          const updatedEma = {
            time: lastCandle.time,
            value: lastEma
          };
          currentEmaData[lastIndex] = updatedEma;
          ema26.update(updatedEma);
        }
        
        // Update MACD with new close price
        const {macd, sig, hist} = calcMACDSeries(closes);
        const lastMacd = macd[macd.length - 1];
        const lastSig = sig[sig.length - 1];
        const lastHist = hist[hist.length - 1];
        
        if (lastMacd !== undefined && !isNaN(lastMacd)) {
          currentMacdData.macd[lastIndex] = lastMacd;
          currentMacdData.signal[lastIndex] = lastSig;
          currentMacdData.hist[lastIndex] = lastHist;
          
          macdLine.update({time: lastCandle.time, value: lastMacd});
          macdSignal.update({time: lastCandle.time, value: lastSig});
          macdHist.update({time: lastCandle.time, value: lastHist});
          
          macdValEl.textContent = lastMacd.toFixed(4);
          macdHistVal.textContent = lastHist.toFixed(4);
        }
      }
      
      updateStatusIndicator(true);
    }
  } catch (error) {
    console.error('Live price error:', error);
    updateStatusIndicator(false);
  }
}

/* ===== Backtest Functions ===== */
function showBacktestModal() {
  const modal = new bootstrap.Modal(document.getElementById('backtestModal'));
  modal.show();
}

async function runBacktest() {
  const pair = pairSelect.value;
  const timeframe = timeframeSelect.value;
  const initialBalance = document.getElementById('initialBalance').value;
  const days = document.getElementById('backtestDays').value;
  const backtestType = document.getElementById('backtestType').value;
  
  backtestStatusEl.textContent = 'Running...';
  backtestStatusEl.className = 'badge bg-warning';
  backtestResultsEl.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Running backtest...</div>';
  
  try {
    const endpoint = backtestType === 'advanced' ? '/api/advanced_backtest' : '/api/backtest';
    
    console.log('Starting backtest with:', { pair, timeframe, days, initialBalance, backtestType });
    
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        pair: pair,
        timeframe: timeframe,
        days: parseInt(days),
        initial_balance: parseFloat(initialBalance)
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('Backtest result:', result);
    
    if (result.status === 'success' || result.status === 'no_trades') {
      displayBacktestResults(result);
      backtestStatusEl.textContent = 'Completed';
      backtestStatusEl.className = 'badge bg-success';
    } else {
      throw new Error(result.error || 'Backtest failed');
    }
    
  } catch (error) {
    console.error('Backtest error:', error);
    backtestResultsEl.innerHTML = `<div class="alert alert-danger">Backtest failed: ${error.message}</div>`;
    backtestStatusEl.textContent = 'Failed';
    backtestStatusEl.className = 'badge bg-danger';
  }
}

function displayBacktestResults(result) {
  const summary = result.summary || {};
  const tradeAnalysis = result.trade_analysis || {};
  
  let html = '';
  
  if (result.status === 'no_trades') {
    html = `<div class="alert alert-warning">No trades were executed during the backtest period.</div>`;
    backtestResultsEl.innerHTML = html;
    return;
  }
  
  // Performance Grade
  const grade = result.performance_grade || 'N/A';
  const gradeClass = grade.startsWith('A') ? 'grade-a' : 
                    grade.startsWith('B') ? 'grade-b' :
                    grade.startsWith('C') ? 'grade-c' : 'grade-d';
  
  html += `<div class="performance-grade ${gradeClass}">Performance: ${grade}</div>`;
  
  // Summary Metrics
  html += `
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Total Trades</div>
          <div class="metric-value">${summary.total_trades || 0}</div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Win Rate</div>
          <div class="metric-value ${(summary.win_rate || 0) >= 50 ? 'change-positive' : 'change-negative'}">
            ${(summary.win_rate || 0).toFixed(1)}%
          </div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Total Profit</div>
          <div class="metric-value ${(summary.total_profit || 0) >= 0 ? 'change-positive' : 'change-negative'}">
            $${(summary.total_profit || 0).toFixed(2)}
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Final Balance</div>
          <div class="metric-value">$${(summary.final_balance || 0).toFixed(2)}</div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Return %</div>
          <div class="metric-value ${(summary.return_percentage || 0) >= 0 ? 'change-positive' : 'change-negative'}">
            ${(summary.return_percentage || 0).toFixed(2)}%
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="metric-card">
          <div class="small-muted">Max Drawdown</div>
          <div class="metric-value change-negative">${(summary.max_drawdown || 0).toFixed(2)}%</div>
        </div>
      </div>
    </div>
  `;
  
  // Trade Analysis
  if (tradeAnalysis.long_trades || tradeAnalysis.short_trades) {
    html += `
      <div class="mt-3">
        <div class="small-muted mb-1">Trade Analysis</div>
        <div class="small-muted">Long Trades: ${tradeAnalysis.long_trades || 0} (Win Rate: ${(tradeAnalysis.long_win_rate || 0).toFixed(1)}%)</div>
        <div class="small-muted">Short Trades: ${tradeAnalysis.short_trades || 0} (Win Rate: ${(tradeAnalysis.short_win_rate || 0).toFixed(1)}%)</div>
      </div>
    `;
  }
  
  backtestResultsEl.innerHTML = html;
}

/* ===== Event Listeners ===== */
document.getElementById('analyzeBtn').addEventListener('click', analyze);
document.getElementById('runBacktestBtn').addEventListener('click', showBacktestModal);
document.getElementById('startBacktestBtn').addEventListener('click', runBacktest);

pairSelect.addEventListener('change', function() {
  updatePairTicker(this.value);
  analyze();
});
timeframeSelect.addEventListener('change', analyze);

// Initialize dashboard
updatePairTicker(pairSelect.value);
analyze();

// Start live price updates every 5 seconds for responsive UI
setInterval(updateLivePrice, 5000);

// Handle window resize
window.addEventListener('resize', () => {
  try {
    chart.resize(document.getElementById('chartRoot').clientWidth, 520);
    macdChart.resize(document.getElementById('macdRoot').clientWidth, 160);
  } catch (e) {
    console.log('Resize error:', e);
  }
});
</script>
</body>
</html>
