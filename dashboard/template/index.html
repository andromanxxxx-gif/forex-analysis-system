<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forex AI Dashboard — Live EMA26 & MACD</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    body {
      background:#f8fafc;
      color:#111827;
      font-family: "Inter","Segoe UI",sans-serif;
      padding:18px;
    }
    .topbar {
      display:flex; gap:12px; align-items:center; margin-bottom:14px;
    }
    .card-soft {
      background:#fff; border-radius:12px; padding:14px;
      box-shadow:0 6px 16px rgba(0,0,0,0.05); margin-bottom:14px;
    }
    #chartRoot { height:520px; border-radius:8px; background:#fff; }
    #macdRoot { height:140px; margin-top:10px; border-radius:8px; background:#fff; }
    .muted { color:#6b7280; font-size:.95rem; }
    .ai-signal-buy { color:#0f5132; background:#d1fae5; padding:3px 8px; border-radius:6px; font-weight:600; }
    .ai-signal-sell { color:#6b0f1a; background:#ffe5e5; padding:3px 8px; border-radius:6px; font-weight:600; }
    .ai-signal-hold { color:#6a5b00; background:#fff7cc; padding:3px 8px; border-radius:6px; font-weight:600; }
    .small-muted { color:#6b7280; font-size:.9rem; }
  </style>
</head>
<body>

<div class="topbar">
  <h4 class="m-0">Forex AI Dashboard</h4>
  <label class="small-muted mb-0 ms-3">Pair</label>
  <select id="pairSelect" class="form-select form-select-sm" style="width:120px;">
    <option>USDJPY</option><option>EURUSD</option><option>GBPJPY</option><option>CHFJPY</option>
  </select>
  <label class="small-muted mb-0">Timeframe</label>
  <select id="timeframeSelect" class="form-select form-select-sm" style="width:100px;">
    <option>1D</option><option>4H</option><option>1H</option>
  </select>
  <button id="analyzeBtn" class="btn btn-primary btn-sm ms-2">Analyze</button>
  <button id="toggleAutoRefresh" class="btn btn-outline-secondary btn-sm">Auto Refresh: OFF</button>
  <div id="pairTicker" class="ms-3 small-muted" style="font-weight:600; font-size:1.05rem;">
    USDJPY – 0.0000 (<span id="pairChange" style="color:gray;">0.00%</span>)
  </div>
</div>

<div class="row gx-3">
  <div class="col-lg-8">
    <div class="card-soft">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong id="chartTitle">Price Chart</strong>
          <div class="muted" id="chartSubtitle">Candlestick · EMA26 · MACD</div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">Live Price</div>
          <div style="font-weight:700; font-size:1.2rem" id="livePrice">-</div>
        </div>
      </div>
      <div id="chartRoot"></div>
      <div id="macdRoot"></div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-soft">
      <h5>AI Analysis <small class="muted" id="aiProviderTxt"></small></h5>
      <div id="aiSummary" class="muted">No analysis yet.</div>
      <div class="mt-2"><strong>Signal:</strong> <span id="aiSignalBadge">-</span></div>
      <div class="row mt-1">
        <div class="col"><small class="small-muted">Confidence</small><div id="aiConfidence">-</div></div>
        <div class="col"><small class="small-muted">Risk</small><div id="aiRisk">-</div></div>
      </div>
      <div class="row mt-2">
        <div class="col"><small class="small-muted">Entry</small><div id="aiEntry">-</div></div>
        <div class="col"><small class="small-muted">SL</small><div id="aiSL">-</div></div>
      </div>
      <div class="row mt-1">
        <div class="col"><small class="small-muted">TP1</small><div id="aiTP1">-</div></div>
        <div class="col"><small class="small-muted">TP2</small><div id="aiTP2">-</div></div>
      </div>
    </div>

    <div class="card-soft">
      <h6>Fundamental News</h6>
      <div id="fundamentalNews" class="muted">-</div>
    </div>

    <div class="card-soft">
      <h6>Technical Overview</h6>
      <div class="small-muted">RSI: <strong id="rsiVal">-</strong></div>
      <div class="small-muted">MACD: <strong id="macdVal">-</strong></div>
      <div class="small-muted">ADX: <strong id="adxVal">-</strong></div>
      <div class="small-muted">ATR: <strong id="atrVal">-</strong></div>
      <div class="small-muted">Volatility: <strong id="volVal">-</strong></div>
    </div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
function calcEMA(values, period){
  const k=2/(period+1);let ema=[values[0]];
  for(let i=1;i<values.length;i++)ema.push(values[i]*k+ema[i-1]*(1-k));
  return ema;
}
function calcMACDSeries(c,short=12,long=26,signal=9){
  const emaS=calcEMA(c,short),emaL=calcEMA(c,long);
  const macd=c.map((_,i)=>emaS[i]-emaL[i]);
  const sig=calcEMA(macd,signal);
  const hist=macd.map((v,i)=>v-(sig[i]||0));
  return {macd,sig,hist};
}
function fmt(d){const t=new Date(d);return t.toISOString().split('T')[0];}

/* ===== Chart Setup ===== */
const chart=LightweightCharts.createChart(document.getElementById('chartRoot'),{
  layout:{backgroundColor:'#fff',textColor:'#111'},grid:{vertLines:{color:'#f3f4f6'},horzLines:{color:'#f3f4f6'}},
  timeScale:{borderColor:'#eee'},rightPriceScale:{borderColor:'#eee'}
});
const candle=chart.addCandlestickSeries({upColor:'#16a34a',downColor:'#dc2626',borderVisible:true});
const ema26=chart.addLineSeries({color:'#2563eb',lineWidth:1.5});
const backtrend=chart.addHistogramSeries({priceFormat:{type:'volume'},priceScaleId:'',base:0});

const macdChart=LightweightCharts.createChart(document.getElementById('macdRoot'),{
  layout:{backgroundColor:'#fff',textColor:'#111'},
  grid:{vertLines:{color:'#f3f4f6'},horzLines:{color:'#f3f4f6'}},timeScale:{visible:true,borderColor:'#eee'}
});
const macdLine=macdChart.addLineSeries({color:'#0ea5e9'});
const macdSignal=macdChart.addLineSeries({color:'#f59e0b'});
const macdHist=macdChart.addHistogramSeries({color:'#a78bfa'});

/* ===== DOM refs ===== */
const livePriceEl=document.getElementById('livePrice');
const pairSelect=document.getElementById('pairSelect');
const timeframeSelect=document.getElementById('timeframeSelect');
const aiSummaryEl=document.getElementById('aiSummary');
const aiSignal=document.getElementById('aiSignalBadge');
const aiConfidence=document.getElementById('aiConfidence');
const aiRisk=document.getElementById('aiRisk');
const aiEntry=document.getElementById('aiEntry');
const aiSL=document.getElementById('aiSL');
const aiTP1=document.getElementById('aiTP1');
const aiTP2=document.getElementById('aiTP2');
const fundNews=document.getElementById('fundamentalNews');
const rsiEl=document.getElementById('rsiVal');
const macdValEl=document.getElementById('macdVal');
const adxEl=document.getElementById('adxVal');
const atrEl=document.getElementById('atrVal');
const volEl=document.getElementById('volVal');
const changeEl=document.getElementById('pairChange');

/* ===== Data state ===== */
let lastCandle=null, auto=false;
function setSignal(sig){
  aiSignal.textContent=sig;
  aiSignal.className=sig==='BUY'?'ai-signal-buy':sig==='SELL'?'ai-signal-sell':'ai-signal-hold';
}

/* ===== Fetch + Render ===== */
async function analyze(){
  const pair=pairSelect.value, tf=timeframeSelect.value;
  const r=await fetch(`/api/analyze?pair=${pair}&timeframe=${tf}`); const j=await r.json();
  const ps=j.price_series||[]; const c=ps.map(p=>({time:fmt(p.date),open:+p.open,high:+p.high,low:+p.low,close:+p.close}));
  candle.setData(c);
  const closes=c.map(d=>d.close);
  const ema=calcEMA(closes,26).map((v,i)=>({time:c[i].time,value:v}));
  ema26.setData(ema);
  const {macd,sig,hist}=calcMACDSeries(closes);
  macdLine.setData(macd.map((v,i)=>({time:c[i].time,value:v})));
  macdSignal.setData(sig.map((v,i)=>({time:c[i].time,value:v})));
  macdHist.setData(hist.map((v,i)=>({time:c[i].time,value:v})));
  macdValEl.textContent=macd.at(-1)?.toFixed(3)||'-';
  lastCandle=c.at(-1);
  livePriceEl.textContent=j.price_data?.current?.toFixed(4)||lastCandle.close.toFixed(4);
  aiSummaryEl.textContent=j.ai_analysis?.analysis_summary||'-';
  setSignal(j.ai_analysis?.signal||'HOLD');
  aiConfidence.textContent=j.ai_analysis?.confidence+'%'||'-';
  aiRisk.textContent=j.ai_analysis?.risk_level||'-';
  aiEntry.textContent=j.ai_analysis?.entry_price||'-';
  aiSL.textContent=j.ai_analysis?.stop_loss||'-';
  aiTP1.textContent=j.ai_analysis?.take_profit_1||'-';
  aiTP2.textContent=j.ai_analysis?.take_profit_2||'-';
  fundNews.textContent=j.fundamental_analysis||'-';
  const t=j.technical_analysis||{};
  rsiEl.textContent=t.momentum?.rsi?.toFixed(2)||'-';
  adxEl.textContent=t.trend?.adx?.toFixed(2)||'-';
  atrEl.textContent=t.volatility?.atr?.toFixed(2)||'-';
  volEl.textContent=t.volatility?.volatility_pct?(t.volatility.volatility_pct*100).toFixed(2)+'%':'-';

  // Backtrend overlay
  const sig=j.ai_analysis?.signal?.toUpperCase()||'HOLD';
  const color=sig==='BUY'?'rgba(34,197,94,0.15)':sig==='SELL'?'rgba(239,68,68,0.15)':'rgba(234,179,8,0.15)';
  backtrend.setData(c.map(d=>({time:d.time,value:d.close,color})));
}

/* ===== Live Price Ticker ===== */
let prevPrice=null;
async function tick(){
  const pair=pairSelect.value;
  try{
    const r=await fetch(`/api/realtime?pair=${pair}`);
    const j=await r.json();
    const price=j.price??j.current_price??null;
    if(price){
      livePriceEl.textContent=price.toFixed(4);
      const ch=prevPrice?((price-prevPrice)/prevPrice)*100:0;
      changeEl.textContent=ch.toFixed(2)+'%';
      changeEl.style.color=ch>=0?'#16a34a':'#dc2626';
      prevPrice=price;
      if(lastCandle){
        const u={time:lastCandle.time,open:lastCandle.open,high:Math.max(lastCandle.high,price),low:Math.min(lastCandle.low,price),close:price};
        candle.update(u);
      }
    }
  }catch{}
}

/* ===== Events ===== */
document.getElementById('analyzeBtn').onclick=analyze;
document.getElementById('toggleAutoRefresh').onclick=()=>{
  auto=!auto;
  toggleAutoRefresh.textContent='Auto Refresh: '+(auto?'ON':'OFF');
  if(auto)setInterval(analyze,30000);
};
analyze();
setInterval(tick,5000);
</script>
</body>
</html>
