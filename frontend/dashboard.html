<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAUUSD AI Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; 
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .price-display {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .up { color: #4CAF50; }
        .down { color: #f44336; }
        .connection-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .connected { background: #4CAF50; }
        .disconnected { background: #f44336; }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #4CAF50;
        }
        .log-error { border-left-color: #f44336; }
        .log-warning { border-left-color: #ff9800; }
        .log-info { border-left-color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ XAUUSD AI Analysis Dashboard</h1>
            <p>Real-time Gold Price Analysis with AI</p>
        </div>

        <div class="grid">
            <div class="status-card">
                <h3>üìä Connection Status</h3>
                <div id="connectionStatus" class="connection-status disconnected">Disconnected</div>
                <div id="clientCount">Connected Clients: 0</div>
            </div>

            <div class="status-card">
                <h3>üí∞ Current Price</h3>
                <div id="priceDisplay" class="price-display">-</div>
                <div id="priceChange">Change: -</div>
                <div id="lastUpdate">Last update: -</div>
            </div>

            <div class="status-card">
                <h3>üìà Quick Actions</h3>
                <button onclick="subscribeXAUUSD()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer;">
                    üìä Subscribe XAUUSD
                </button>
                <button onclick="getHealth()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: #2196F3; color: white; cursor: pointer;">
                    üè• Check Health
                </button>
                <button onclick="clearLog()" style="padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: #ff9800; color: white; cursor: pointer;">
                    üßπ Clear Log
                </button>
            </div>
        </div>

        <div class="status-card">
            <h3>üìù Real-time Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentPrice = null;

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('WebSocket already connected', 'info');
                return;
            }

            ws = new WebSocket('ws://localhost:8000/ws');

            ws.onopen = function(event) {
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').className = 'connection-status connected';
                addLog('‚úÖ WebSocket connected successfully!', 'info');
                
                // Auto-subscribe to XAUUSD
                setTimeout(() => subscribeXAUUSD(), 1000);
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addLog(`üì® ${data.type}: ${JSON.stringify(data)}`, 'info');
                
                switch(data.type) {
                    case 'connection_established':
                        addLog('üéâ ' + data.message, 'info');
                        break;
                    case 'subscription_confirmed':
                        addLog(`üìä Subscribed to: ${data.symbols.join(', ')}`, 'info');
                        break;
                    case 'price_update':
                        updatePriceDisplay(data);
                        break;
                    case 'analysis_update':
                        addLog('ü§ñ New AI Analysis Received', 'info');
                        break;
                }
            };

            ws.onerror = function(error) {
                addLog('‚ùå WebSocket error: ' + error, 'error');
                document.getElementById('connectionStatus').textContent = 'Error';
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
            };

            ws.onclose = function(event) {
                addLog('üîå WebSocket disconnected', 'warning');
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                
                // Attempt reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updatePriceDisplay(data) {
            const priceElement = document.getElementById('priceDisplay');
            const changeElement = document.getElementById('priceChange');
            const updateElement = document.getElementById('lastUpdate');
            
            const newPrice = data.price;
            priceElement.textContent = `$${newPrice.toFixed(2)}`;
            
            // Price change indicator
            if (currentPrice) {
                const change = ((newPrice - currentPrice) / currentPrice * 100).toFixed(2);
                changeElement.textContent = `Change: ${change}%`;
                changeElement.className = change >= 0 ? 'up' : 'down';
                priceElement.className = change >= 0 ? 'price-display up' : 'price-display down';
            }
            
            currentPrice = newPrice;
            updateElement.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        function subscribeXAUUSD() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    symbols: ['XAUUSD']
                }));
                addLog('üì§ Sent subscription request for XAUUSD', 'info');
            } else {
                addLog('‚ùå WebSocket not connected', 'error');
            }
        }

        async function getHealth() {
            try {
                const response = await fetch('http://localhost:8000/api/health');
                const data = await response.json();
                addLog(`üè• Health: ${data.status} - Price: $${data.current_price}`, 'info');
            } catch (error) {
                addLog('‚ùå Health check failed: ' + error, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            addLog('Log cleared', 'info');
        }

        // Initialize
        addLog('üöÄ Dashboard initialized', 'info');
        connectWebSocket();

        // Auto-refresh client count every 5 seconds
        setInterval(async () => {
            try {
                const response = await fetch('http://localhost:8000/api/ws-info');
                const data = await response.json();
                document.getElementById('clientCount').textContent = 
                    `Connected Clients: ${data.connected_clients}`;
            } catch (error) {
                // Silent fail
            }
        }, 5000);
    </script>
</body>
</html>
