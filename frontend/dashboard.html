<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAUUSD AI Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #0f1b2d;
            color: #e0e0e0; 
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 15px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: #1a2a3a;
            border-radius: 15px;
            padding: 20px;
            height: 500px;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background: #1a2a3a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #2d3e50;
        }
        .price-display {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        .up { color: #00e676; }
        .down { color: #ff5252; }
        .neutral { color: #ffca28; }
        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .connected { background: #00e676; color: #000; }
        .disconnected { background: #ff5252; color: white; }
        .connecting { background: #ffca28; color: #000; }
        
        .indicators-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .indicator {
            padding: 10px;
            background: #2d3e50;
            border-radius: 8px;
            text-align: center;
        }
        .indicator-value {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .analysis-card {
            background: linear-gradient(135deg, #2d3e50 0%, #1a2a3a 100%);
            border-left: 4px solid #2196F3;
        }
        
        .signal-buy { border-left-color: #00e676; }
        .signal-sell { border-left-color: #ff5252; }
        .signal-neutral { border-left-color: #ffca28; }
        
        .log {
            background: #1a2a3a;
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            background: #2d3e50;
        }
        .log-buy { border-left: 3px solid #00e676; }
        .log-sell { border-left: 3px solid #ff5252; }
        .log-neutral { border-left: 3px solid #ffca28; }
        .log-info { border-left: 3px solid #2196F3; }
        .log-warning { border-left: 3px solid #ff9800; }
        .log-error { border-left: 3px solid #f44336; }
        
        .timeframe-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .timeframe-btn {
            padding: 8px 15px;
            background: #2d3e50;
            border: none;
            border-radius: 5px;
            color: #e0e0e0;
            cursor: pointer;
        }
        .timeframe-btn.active {
            background: #2196F3;
            color: white;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #2d3e50;
            border-radius: 8px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ XAUUSD AI Trading Dashboard</h1>
            <p>Real-time Gold Price Analysis dengan AI & Technical Indicators</p>
        </div>

        <div class="grid">
            <!-- Main Chart Area -->
            <div class="chart-container">
                <div class="timeframe-selector">
                    <button class="timeframe-btn active" onclick="changeTimeframe('1D')">1D</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('4H')">4H</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('1H')">1H</button>
                    <button onclick="refreshAnalysis()" style="margin-left: auto;">üîÑ Refresh</button>
                </div>
                <div id="priceChart" style="height: 100%;"></div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Price & Status Card -->
                <div class="card">
                    <h3>üí∞ Real-time Price</h3>
                    <div id="priceDisplay" class="price-display">-</div>
                    <div id="priceChange" style="text-align: center;">Change: -</div>
                    <div id="lastUpdate" style="text-align: center; font-size: 0.9em; margin-top: 10px;">Last update: -</div>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <div id="connectionStatus" class="connection-status disconnected">DISCONNECTED</div>
                        <div id="clientCount" style="margin-top: 10px;">Connected Clients: 0</div>
                    </div>
                </div>

                <!-- Technical Indicators -->
                <div class="card">
                    <h3>üìä Technical Indicators</h3>
                    <div class="indicators-grid">
                        <div class="indicator">
                            <div>RSI (14)</div>
                            <div id="rsiValue" class="indicator-value">-</div>
                        </div>
                        <div class="indicator">
                            <div>MACD</div>
                            <div id="macdValue" class="indicator-value">-</div>
                        </div>
                        <div class="indicator">
                            <div>Trend</div>
                            <div id="trendValue" class="indicator-value">-</div>
                        </div>
                        <div class="indicator">
                            <div>Volatility</div>
                            <div id="volatilityValue" class="indicator-value">-</div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis -->
                <div class="card analysis-card" id="analysisCard">
                    <h3>ü§ñ AI Analysis <span id="aiLoading" class="loading" style="display: none;"></span></h3>
                    <div id="aiAnalysis" style="margin-top: 10px;">
                        <div>Loading AI analysis...</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div>Signal</div>
                            <div id="signalStrength" class="indicator-value">-</div>
                        </div>
                        <div class="stat-item">
                            <div>Confidence</div>
                            <div id="confidenceLevel" class="indicator-value">-</div>
                        </div>
                        <div class="stat-item">
                            <div>Risk</div>
                            <div id="riskLevel" class="indicator-value">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls & Additional Info -->
        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h3>üéÆ Trading Controls</h3>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button onclick="getTechnicalAnalysis()">üìä Technical Analysis</button>
                    <button onclick="getAIAnalysis()">ü§ñ AI Analysis</button>
                    <button onclick="getCompleteAnalysis()">üîç Complete Analysis</button>
                    <button onclick="simulateTrade('BUY')" style="background: #00e676;">üîº Simulate BUY</button>
                    <button onclick="simulateTrade('SELL')" style="background: #ff5252;">üîΩ Simulate SELL</button>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="clearLog()">üßπ Clear Log</button>
                    <button onclick="exportData()">üì• Export Data</button>
                </div>
            </div>

            <div class="card">
                <h3>üìà Market Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div>Support Levels</div>
                        <div id="supportCount" class="indicator-value">-</div>
                    </div>
                    <div class="stat-item">
                        <div>Resistance Levels</div>
                        <div id="resistanceCount" class="indicator-value">-</div>
                    </div>
                    <div class="stat-item">
                        <div>Analysis Time</div>
                        <div id="analysisTime" class="indicator-value">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support & Resistance Levels -->
        <div class="card">
            <h3>üéØ Key Levels</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <div>
                    <h4>üõ°Ô∏è Support Levels</h4>
                    <div id="supportLevels" style="margin-top: 10px;"></div>
                </div>
                <div>
                    <h4>üöß Resistance Levels</h4>
                    <div id="resistanceLevels" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <h3>üìù Trading Activity & Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // Global variables
        let ws = null;
        let currentPrice = null;
        let currentTimeframe = '1D';
        let currentAnalysis = null;

        // Add log entry
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // WebSocket connection
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('WebSocket already connected', 'info');
                return;
            }

            updateConnectionStatus('connecting');
            ws = new WebSocket('ws://localhost:8000/ws');

            ws.onopen = function(event) {
                updateConnectionStatus('connected');
                addLog('‚úÖ WebSocket connected successfully!', 'info');
                
                // Auto-subscribe to XAUUSD
                setTimeout(() => subscribeXAUUSD(), 1000);
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                processWebSocketMessage(data);
            };

            ws.onerror = function(error) {
                addLog('‚ùå WebSocket error', 'error');
                updateConnectionStatus('disconnected');
            };

            ws.onclose = function(event) {
                addLog('üîå WebSocket disconnected', 'warning');
                updateConnectionStatus('disconnected');
                
                // Attempt reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Process incoming WebSocket messages
        function processWebSocketMessage(data) {
            switch(data.type) {
                case 'connection_established':
                    addLog('üéâ ' + data.message, 'info');
                    break;
                    
                case 'subscription_confirmed':
                    addLog(`üìä Subscribed to: ${data.symbols.join(', ')}`, 'info');
                    break;
                    
                case 'price_update':
                    updatePriceDisplay(data);
                    break;
                    
                case 'analysis_update':
                    updateAnalysisDisplay(data.data);
                    break;
                    
                default:
                    addLog(`üì® ${data.type}`, 'info');
            }
        }

        // Update price display
        function updatePriceDisplay(data) {
            const priceElement = document.getElementById('priceDisplay');
            const changeElement = document.getElementById('priceChange');
            const updateElement = document.getElementById('lastUpdate');
            
            const newPrice = data.price;
            priceElement.textContent = `$${newPrice.toFixed(2)}`;
            
            // Price change indicator
            if (currentPrice !== null) {
                const change = ((newPrice - currentPrice) / currentPrice * 100).toFixed(2);
                const changeValue = parseFloat(change);
                
                changeElement.textContent = `Change: ${change}%`;
                
                if (changeValue > 0) {
                    priceElement.className = 'price-display up';
                    changeElement.className = 'up';
                } else if (changeValue < 0) {
                    priceElement.className = 'price-display down';
                    changeElement.className = 'down';
                } else {
                    priceElement.className = 'price-display neutral';
                    changeElement.className = 'neutral';
                }
            }
            
            currentPrice = newPrice;
            updateElement.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        // Update analysis display
        function updateAnalysisDisplay(analysisData) {
            currentAnalysis = analysisData;
            
            // Update technical indicators
            if (analysisData.technical_analysis) {
                updateTechnicalIndicators(analysisData.technical_analysis);
            }
            
            // Update AI analysis
            if (analysisData.ai_analysis) {
                updateAIAnalysis(analysisData.ai_analysis);
            }
            
            // Update chart if available
            if (analysisData.chart_data && analysisData.chart_data.plotly_config) {
                updateChart(analysisData.chart_data.plotly_config);
            }
            
            addLog('üìä Analysis data updated', 'info');
        }

        // Update technical indicators
        function updateTechnicalIndicators(techAnalysis) {
            // Find RSI indicator
            const rsiIndicator = techAnalysis.indicators.find(ind => ind.name === 'RSI_14');
            if (rsiIndicator) {
                document.getElementById('rsiValue').textContent = rsiIndicator.value.toFixed(2);
                document.getElementById('rsiValue').className = `indicator-value ${
                    rsiIndicator.value > 70 ? 'down' : rsiIndicator.value < 30 ? 'up' : 'neutral'
                }`;
            }
            
            // Find MACD indicator
            const macdIndicator = techAnalysis.indicators.find(ind => ind.name === 'MACD');
            if (macdIndicator) {
                document.getElementById('macdValue').textContent = macdIndicator.value.toFixed(4);
                document.getElementById('macdValue').className = `indicator-value ${
                    macdIndicator.value > 0 ? 'up' : 'down'
                }`;
            }
            
            // Update trend and volatility
            document.getElementById('trendValue').textContent = techAnalysis.summary;
            document.getElementById('trendValue').className = `indicator-value ${
                techAnalysis.summary === 'BULLISH' ? 'up' : techAnalysis.summary === 'BEARISH' ? 'down' : 'neutral'
            }`;
            
            if (techAnalysis.volatility !== undefined) {
                document.getElementById('volatilityValue').textContent = techAnalysis.volatility.toFixed(2) + '%';
            }
            
            // Update support and resistance levels
            updateSupportResistanceLevels(techAnalysis.support_levels, techAnalysis.resistance_levels);
            
            // Update statistics
            document.getElementById('supportCount').textContent = techAnalysis.support_levels.length;
            document.getElementById('resistanceCount').textContent = techAnalysis.resistance_levels.length;
        }

        // Update AI analysis
        function updateAIAnalysis(aiAnalysis) {
            const analysisElement = document.getElementById('aiAnalysis');
            const analysisCard = document.getElementById('analysisCard');
            
            analysisElement.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>Recommendation:</strong> ${aiAnalysis.recommendation}</div>
                <div style="margin-bottom: 10px;"><strong>Summary:</strong> ${aiAnalysis.technical_summary}</div>
                <div style="font-size: 0.9em; color: #aaa;"><strong>Factors:</strong> ${aiAnalysis.key_factors.slice(0, 3).join(', ')}</div>
            `;
            
            // Update signal indicators
            document.getElementById('signalStrength').textContent = aiAnalysis.recommendation;
            document.getElementById('confidenceLevel').textContent = `${(aiAnalysis.confidence_score * 100).toFixed(1)}%`;
            document.getElementById('riskLevel').textContent = aiAnalysis.risk_assessment;
            
            // Update card styling based on signal
            analysisCard.className = `card analysis-card signal-${aiAnalysis.recommendation.toLowerCase()}`;
            
            // Color code the indicators
            document.getElementById('signalStrength').className = `indicator-value ${
                aiAnalysis.recommendation === 'BUY' ? 'up' : aiAnalysis.recommendation === 'SELL' ? 'down' : 'neutral'
            }`;
            
            document.getElementById('riskLevel').className = `indicator-value ${
                aiAnalysis.risk_assessment === 'LOW' ? 'up' : aiAnalysis.risk_assessment === 'HIGH' ? 'down' : 'neutral'
            }`;
            
            // Hide loading indicator
            document.getElementById('aiLoading').style.display = 'none';
        }

        // Update support and resistance levels
        function updateSupportResistanceLevels(supportLevels, resistanceLevels) {
            const supportElement = document.getElementById('supportLevels');
            const resistanceElement = document.getElementById('resistanceLevels');
            
            supportElement.innerHTML = supportLevels.map(level => 
                `<div style="padding: 5px; background: #2d3e50; margin: 2px 0; border-radius: 3px;">$${level.toFixed(2)}</div>`
            ).join('') || '<div style="color: #666;">No support levels</div>';
            
            resistanceElement.innerHTML = resistanceLevels.map(level => 
                `<div style="padding: 5px; background: #2d3e50; margin: 2px 0; border-radius: 3px;">$${level.toFixed(2)}</div>`
            ).join('') || '<div style="color: #666;">No resistance levels</div>';
        }

        // Update chart with Plotly
        function updateChart(plotlyConfig) {
            Plotly.newPlot('priceChart', plotlyConfig.data, plotlyConfig.layout, {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            });
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status.toUpperCase();
            statusElement.className = `connection-status ${status}`;
        }

        // WebSocket actions
        function subscribeXAUUSD() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    symbols: ['XAUUSD']
                }));
                addLog('üì§ Sent subscription request for XAUUSD', 'info');
            } else {
                addLog('‚ùå WebSocket not connected', 'error');
            }
        }

        // API Calls
        async function getTechnicalAnalysis() {
            try {
                addLog('üîç Fetching technical analysis...', 'info');
                const response = await fetch(`http://localhost:8000/api/v1/analysis/xauusd?timeframe=${currentTimeframe}&include_news=false&include_chart=true`);
                const data = await response.json();
                updateAnalysisDisplay(data);
                addLog('‚úÖ Technical analysis updated', 'info');
            } catch (error) {
                addLog('‚ùå Failed to fetch technical analysis: ' + error, 'error');
            }
        }

        async function getAIAnalysis() {
            try {
                document.getElementById('aiLoading').style.display = 'inline-block';
                addLog('ü§ñ Fetching AI analysis...', 'info');
                const response = await fetch(`http://localhost:8000/api/v1/analysis/xauusd?timeframe=${currentTimeframe}&include_news=true&include_chart=false`);
                const data = await response.json();
                updateAnalysisDisplay(data);
                addLog('‚úÖ AI analysis updated', 'info');
            } catch (error) {
                document.getElementById('aiLoading').style.display = 'none';
                addLog('‚ùå Failed to fetch AI analysis: ' + error, 'error');
            }
        }

        async function getCompleteAnalysis() {
            try {
                document.getElementById('aiLoading').style.display = 'inline-block';
                addLog('üîç Fetching complete analysis...', 'info');
                const response = await fetch(`http://localhost:8000/api/v1/analysis/xauusd?timeframe=${currentTimeframe}&include_news=true&include_chart=true`);
                const data = await response.json();
                updateAnalysisDisplay(data);
                addLog('‚úÖ Complete analysis updated', 'info');
            } catch (error) {
                document.getElementById('aiLoading').style.display = 'none';
                addLog('‚ùå Failed to fetch complete analysis: ' + error, 'error');
            }
        }

        // Change timeframe
        function changeTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update active button
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            addLog(`üìä Changed timeframe to ${timeframe}`, 'info');
            
            // Refresh analysis with new timeframe
            getCompleteAnalysis();
        }

        // Refresh analysis
        function refreshAnalysis() {
            addLog('üîÑ Refreshing analysis...', 'info');
            getCompleteAnalysis();
        }

        // Simulate trade
        function simulateTrade(action) {
            const price = currentPrice || 4239.37;
            addLog(`üéØ ${action} order simulated at $${price.toFixed(2)}`, 
                   action === 'BUY' ? 'buy' : 'sell');
        }

        // Export data
        function exportData() {
            addLog('üì• Exporting trading data...', 'info');
            // In real app, this would download CSV or PDF
        }

        // Clear log
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            addLog('Log cleared', 'info');
        }

        // Initialize dashboard
        function initializeDashboard() {
            addLog('üöÄ XAUUSD AI Trading Dashboard initialized', 'info');
            connectWebSocket();
            
            // Load initial analysis
            getCompleteAnalysis();
            
            // Auto-refresh client count and analysis time
            setInterval(async () => {
                try {
                    const response = await fetch('http://localhost:8000/api/ws-info');
                    const data = await response.json();
                    document.getElementById('clientCount').textContent = 
                        `Connected Clients: ${data.connected_clients}`;
                    
                    // Update analysis time
                    document.getElementById('analysisTime').textContent = 
                        new Date().toLocaleTimeString();
                } catch (error) {
                    // Silent fail
                }
            }, 5000);
            
            // Auto-refresh analysis every 60 seconds
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    refreshAnalysis();
                }
            }, 60000);
        }

        // Start the dashboard when page loads
        window.onload = initializeDashboard;
    </script>
</body>
</html>
