<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAUUSD AI Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            padding: 12px 24px;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
            color: #ffd700;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .timeframe-btn:hover, .timeframe-btn.active {
            background: #ffd700;
            color: #0f2027;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .price-display {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .indicator-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .indicator-value {
            font-size: 1.4em;
            font-weight: bold;
            margin: 5px 0;
        }

        .bullish { color: #00ff88; }
        .bearish { color: #ff4444; }
        .neutral { color: #ffd700; }

        .analysis-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            max-height: 600px;
            overflow-y: auto;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-family: 'Courier New', monospace;
        }

        .news-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ffd700;
        }

        .news-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffd700;
        }

        .news-source {
            font-size: 0.9em;
            color: #cccccc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .last-update {
            font-size: 0.9em;
            color: #cccccc;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .indicator-toggle {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .indicator-toggle.active {
            background: #ffd700;
            color: #0f2027;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§  XAUUSD AI Analysis Dashboard</h1>
            <p>Real-time Gold Analysis with Technical Indicators</p>
        </div>

        <div class="status-bar">
            <div class="last-update">Last update: <span id="lastUpdate">-</span></div>
            <div class="timeframe-controls">
                <button class="timeframe-btn active" onclick="loadData('1H')">1H</button>
                <button class="timeframe-btn" onclick="loadData('4H')">4H</button>
                <button class="timeframe-btn" onclick="loadData('1D')">1D</button>
            </div>
        </div>

        <div class="price-display" id="currentPrice">
            Loading...
        </div>

        <div class="dashboard">
            <div class="chart-container">
                <div class="chart-controls">
                    <button class="indicator-toggle active" onclick="toggleIndicator('ema')">EMA</button>
                    <button class="indicator-toggle active" onclick="toggleIndicator('macd')">MACD</button>
                    <button class="indicator-toggle" onclick="toggleIndicator('rsi')">RSI</button>
                </div>
                <canvas id="priceChart" height="400"></canvas>
                <div id="macdChartContainer" style="display: none;">
                    <canvas id="macdChart" height="150"></canvas>
                </div>
                <div id="rsiChartContainer" style="display: none;">
                    <canvas id="rsiChart" height="150"></canvas>
                </div>
            </div>

            <div class="analysis-panel">
                <h3>ðŸ“Š AI Analysis</h3>
                <div class="analysis-content" id="aiAnalysis">
                    Loading analysis...
                </div>
            </div>
        </div>

        <div class="indicators-grid" id="indicatorsGrid">
            <!-- Indicators will be populated here -->
        </div>

        <div class="news-panel">
            <h3>ðŸ“° Market News</h3>
            <div id="newsContainer">
                <div class="loading">Loading news...</div>
            </div>
        </div>
    </div>

    <script>
        let currentTimeframe = '1H';
        let priceChart = null;
        let macdChart = null;
        let rsiChart = null;
        let chartData = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData('1H');
            setInterval(() => loadData(currentTimeframe), 30000); // Update every 30 seconds
        });

        function loadData(timeframe) {
            currentTimeframe = timeframe;
            
            // Update active button
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            showLoading();
            fetch(`/api/analysis/${timeframe}`)
                .then(response => response.json())
                .then(data => {
                    updateDashboard(data);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('aiAnalysis').textContent = 'Error loading data. Please try again.';
                });
        }

        function showLoading() {
            document.getElementById('currentPrice').textContent = 'Loading...';
            document.getElementById('aiAnalysis').textContent = 'Loading analysis...';
            document.getElementById('indicatorsGrid').innerHTML = '<div class="loading">Loading indicators...</div>';
        }

        function updateDashboard(data) {
            // Update price
            document.getElementById('currentPrice').textContent = `$${data.current_price.toFixed(2)}`;
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Update AI analysis
            document.getElementById('aiAnalysis').textContent = data.ai_analysis;
            
            // Update indicators grid
            updateIndicatorsGrid(data.technical_indicators);
            
            // Update news
            updateNews(data.news);
            
            // Update charts
            chartData = data.chart_data;
            updateCharts();
        }

        function updateIndicatorsGrid(indicators) {
            const grid = document.getElementById('indicatorsGrid');
            grid.innerHTML = '';

            const indicatorConfig = {
                'ema_12': { name: 'EMA 12', format: '0.2f' },
                'ema_26': { name: 'EMA 26', format: '0.2f' },
                'ema_50': { name: 'EMA 50', format: '0.2f' },
                'rsi': { name: 'RSI', format: '0.1f' },
                'macd': { name: 'MACD', format: '0.4f' },
                'macd_signal': { name: 'MACD Signal', format: '0.4f' },
                'macd_hist': { name: 'MACD Hist', format: '0.4f' }
            };

            Object.keys(indicatorConfig).forEach(key => {
                if (indicators[key] !== undefined) {
                    const config = indicatorConfig[key];
                    const value = indicators[key];
                    const card = document.createElement('div');
                    card.className = 'indicator-card';
                    
                    let trendClass = 'neutral';
                    if (key === 'rsi') {
                        trendClass = value > 70 ? 'bearish' : value < 30 ? 'bullish' : 'neutral';
                    } else if (key.includes('macd')) {
                        trendClass = value > 0 ? 'bullish' : value < 0 ? 'bearish' : 'neutral';
                    }
                    
                    card.innerHTML = `
                        <div>${config.name}</div>
                        <div class="indicator-value ${trendClass}">
                            ${value.toFixed(config.format.includes('4') ? 4 : 2)}
                        </div>
                    `;
                    grid.appendChild(card);
                }
            });
        }

        function updateNews(newsData) {
            const container = document.getElementById('newsContainer');
            if (newsData.articles && newsData.articles.length > 0) {
                container.innerHTML = newsData.articles.map(article => `
                    <div class="news-item">
                        <div class="news-title">${article.title}</div>
                        <div class="news-description">${article.description}</div>
                        <div class="news-source">${article.source.name} â€¢ ${new Date(article.publishedAt).toLocaleDateString()}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="loading">No news available</div>';
            }
        }

        function updateCharts() {
            updatePriceChart();
            updateMACDChart();
            updateRSIChart();
        }

        function updatePriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }

            const prices = chartData.map(d => d.close);
            const ema12 = chartData.map(d => d.ema_12).filter(v => v !== null);
            const ema26 = chartData.map(d => d.ema_26).filter(v => v !== null);
            const ema50 = chartData.map(d => d.ema_50).filter(v => v !== null);

            // Prepare candlestick data
            const candlestickData = chartData.map(d => ({
                x: new Date(d.datetime),
                o: d.open,
                h: d.high,
                l: d.low,
                c: d.close
            }));

            priceChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'XAUUSD Price',
                        data: candlestickData,
                        color: {
                            up: '#00ff88',
                            down: '#ff4444',
                            unchanged: '#cccccc',
                        },
                    }, {
                        label: 'EMA 12',
                        data: chartData.map((d, i) => ({
                            x: new Date(d.datetime),
                            y: d.ema_12
                        })),
                        borderColor: '#ffd700',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }, {
                        label: 'EMA 26',
                        data: chartData.map((d, i) => ({
                            x: new Date(d.datetime),
                            y: d.ema_26
                        })),
                        borderColor: '#00ccff',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }, {
                        label: 'EMA 50',
                        data: chartData.map((d, i) => ({
                            x: new Date(d.datetime),
                            y: d.ema_50
                        })),
                        borderColor: '#ff4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `XAUUSD ${currentTimeframe} Chart with EMA Indicators`,
                            color: 'white'
                        },
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateMACDChart() {
            const ctx = document.getElementById('macdChart').getContext('2d');
            
            if (macdChart) {
                macdChart.destroy();
            }

            const macdData = chartData.map(d => ({
                x: new Date(d.datetime),
                macd: d.macd,
                signal: d.macd_signal,
                hist: d.macd_hist
            })).filter(d => d.macd !== null && d.signal !== null && d.hist !== null);

            macdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: 'MACD Histogram',
                        data: macdData.map(d => ({
                            x: d.x,
                            y: d.hist
                        })),
                        backgroundColor: macdData.map(d => d.hist >= 0 ? '#00ff88' : '#ff4444'),
                        borderColor: macdData.map(d => d.hist >= 0 ? '#00ff88' : '#ff4444'),
                        borderWidth: 1,
                        type: 'bar'
                    }, {
                        label: 'MACD',
                        data: macdData.map(d => ({
                            x: d.x,
                            y: d.macd
                        })),
                        borderColor: '#ffd700',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }, {
                        label: 'Signal',
                        data: macdData.map(d => ({
                            x: d.x,
                            y: d.signal
                        })),
                        borderColor: '#00ccff',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'MACD Indicator',
                            color: 'white'
                        },
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateRSIChart() {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            
            if (rsiChart) {
                rsiChart.destroy();
            }

            const rsiData = chartData.map(d => ({
                x: new Date(d.datetime),
                y: d.rsi
            })).filter(d => d.y !== null);

            rsiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'RSI',
                        data: rsiData,
                        borderColor: '#ffd700',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'RSI Indicator',
                            color: 'white'
                        },
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 70,
                                yMax: 70,
                                borderColor: '#ff4444',
                                borderWidth: 1,
                                borderDash: [5, 5]
                            },
                            line2: {
                                type: 'line',
                                yMin: 30,
                                yMax: 30,
                                borderColor: '#00ff88',
                                borderWidth: 1,
                                borderDash: [5, 5]
                            }
                        }
                    }
                }
            });
        }

        function toggleIndicator(indicator) {
            const button = event.target;
            button.classList.toggle('active');
            
            switch(indicator) {
                case 'macd':
                    const macdContainer = document.getElementById('macdChartContainer');
                    macdContainer.style.display = button.classList.contains('active') ? 'block' : 'none';
                    if (button.classList.contains('active') && chartData.length > 0) {
                        updateMACDChart();
                    }
                    break;
                case 'rsi':
                    const rsiContainer = document.getElementById('rsiChartContainer');
                    rsiContainer.style.display = button.classList.contains('active') ? 'block' : 'none';
                    if (button.classList.contains('active') && chartData.length > 0) {
                        updateRSIChart();
                    }
                    break;
            }
        }

        // Add candlestick chart type to Chart.js
        Chart.defaults.elements.candlestick = {
            color: {
                up: '#00ff88',
                down: '#ff4444',
                unchanged: '#cccccc'
            }
        };

        Chart.controllers.candlestick = Chart.controllers.bar.extend({
            dataElementType: Chart.elements.Candlestick,
            
            updateElement: function(element, index, reset) {
                const me = this;
                const meta = me.getMeta();
                const dataset = me.getDataset();
                
                const custom = element.custom || {};
                const x = me.indexScale.getPixelForValue(undefined, index);
                const o = me.getValueScale().getPixelForValue(dataset.data[index].o);
                const h = me.getValueScale().getPixelForValue(dataset.data[index].h);
                const l = me.getValueScale().getPixelForValue(dataset.data[index].l);
                const c = me.getValueScale().getPixelForValue(dataset.data[index].c);
                
                element._model = {
                    x: x,
                    y: (h + l) / 2,
                    base: (h + l) / 2,
                    width: me.getIndexScale().getPixelForTick(index + 1) - me.getIndexScale().getPixelForTick(index),
                    open: o,
                    high: h,
                    low: l,
                    close: c,
                    custom: custom
                };
                
                element.pivot();
            },
            
            draw: function() {
                const ctx = this.chart.ctx;
                const elements = this.getMeta().data;
                
                for (let i = 0; i < elements.length; i++) {
                    const element = elements[i];
                    const view = element._model;
                    
                    ctx.save();
                    
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = view.close >= view.open ? 
                        view.color.up : view.color.down;
                    ctx.fillStyle = view.close >= view.open ? 
                        view.color.up : view.color.down;
                    
                    // Draw high-low line
                    ctx.beginPath();
                    ctx.moveTo(view.x, view.high);
                    ctx.lineTo(view.x, view.low);
                    ctx.stroke();
                    
                    // Draw body
                    const bodyTop = Math.min(view.open, view.close);
                    const bodyBottom = Math.max(view.open, view.close);
                    const bodyHeight = bodyBottom - bodyTop;
                    
                    if (bodyHeight > 0) {
                        ctx.fillRect(
                            view.x - view.width / 2,
                            bodyTop,
                            view.width,
                            bodyHeight
                        );
                    }
                    
                    ctx.restore();
                }
            }
        });

        Chart.elements.Candlestick = Chart.elements.Element.extend({
            draw: function() {
                // Drawing is handled in the controller
            }
        });
    </script>
</body>
</html>
